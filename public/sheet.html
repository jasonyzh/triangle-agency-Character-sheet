<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>职员档案 // TRIANGLE AGENCY</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
    :root {
        --deep-bg: #1a252f;
        --bg-pattern: radial-gradient(#2c3e50 1px, transparent 1px);
        --panel-bg: #ffffff;
        --input-bg: #f8f9fa;
        --text-main: #2c3e50;
        --text-dim: #95a5a6;
        --border-color: #e0e0e0;
        --signal-red: #c0392b;
        --accent: #2980b9;
        --reality: #f39c12;
        --functional: #c0392b;
        --nav-height: 60px;
        --safe-bottom: env(safe-area-inset-bottom);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { font-family: "Roboto Mono", "Noto Sans SC", "Microsoft YaHei", sans-serif; background-color: var(--deep-bg); background-image: var(--bg-pattern); background-size: 20px 20px; color: var(--text-main); overflow: hidden; height: 100dvh; width: 100vw; position: relative; }
    .container { max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; height: 100%; padding: 15px; padding-bottom: 0; }
    .top-nav { display: flex; align-items: center; justify-content: space-between; margin: 0 0 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; color: white; flex-shrink: 0; }
    .brand-logo-sm { display: flex; flex-direction: column; line-height: 0.9; font-weight: 800; font-style: italic; }
    .brand-logo-sm span:first-child { font-size: 14px; color: white; }
    .brand-logo-sm span:last-child { font-size: 8px; color: var(--signal-red); letter-spacing: 2px; }
    .btn-back { background: none; border: none; font-size: 14px; color: rgba(255,255,255,0.7); cursor: pointer; display: flex; align-items: center; gap: 5px; }
    .btn-back:hover { color: white; }
    h1 { margin: 0; font-size: 16px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; text-align: right; flex: 1; display:flex; flex-direction:column; align-items:flex-end; color: white; }
    h1 span.sub { font-size: 10px; color: rgba(255,255,255,0.5); font-weight: normal; }
    .offline-tag, .readonly-tag { background: #34495e; color: #bdc3c7; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px; display: none; }
    .offline-mode .offline-tag { display: inline-block; }
    .offline-mode .btn-back, .offline-mode .btn-save-server { display: none; }
    body.readonly-mode .readonly-tag { display: inline-block; background: var(--signal-red); color: white; }
    body.readonly-mode .btn-save, body.readonly-mode .btn-add, body.readonly-mode .btn-del, body.readonly-mode .save-area { display: none !important; }
    body.readonly-mode input, body.readonly-mode textarea, body.readonly-mode .rich-editor, body.readonly-mode select { pointer-events: none; background: transparent; border-color: transparent; color: #555; -webkit-appearance: none; appearance: none; }
    .swiper-container { flex-grow: 1; width: 100%; overflow: hidden; position: relative; }
    .swiper-wrapper { display: flex; width: 400%; height: 100%; transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
    .tab-view { width: 25%; height: 100%; overflow-y: auto; display: block !important; padding-right: 5px; padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 60px); -ms-overflow-style: none; scrollbar-width: none; }
    .tab-view::-webkit-scrollbar { display: none; }
    .panel, .card { background: var(--panel-bg); border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 16px; border: 1px solid var(--border-color); position: relative; overflow: hidden; z-index: 1; }
    .panel::before, .card::before, .panel::after, .card::after { content: ''; position: absolute; z-index: -1; pointer-events: none; opacity: 0.05; transform-origin: center; }
    .panel::before, .card::before { background: #2c3e50; width: 200px; height: 200px; top: calc(-50px + 100px * var(--r1, 0.5)); left: calc(-50px + 100px * var(--r2, 0.5)); clip-path: polygon(50% 0%, 0% 100%, 100% 100%); animation: float-shard calc(25s + 10s * var(--r3, 0.5)) infinite linear; }
    .panel::after, .card::after { background: var(--signal-red); width: 150px; height: 150px; opacity: 0.03; bottom: calc(-30px + 50px * var(--r2, 0.5)); right: calc(-30px + 50px * var(--r1, 0.5)); clip-path: polygon(0 0, 100% 50%, 0 100%); animation: float-shard calc(30s + 15s * var(--r1, 0.5)) infinite reverse linear; }
    input, textarea, .rich-editor, h2, label, button, .attr-row, .track-sec, .perm-group, .perm-note, .row-2, select { position: relative; z-index: 2; }
    .card { padding-top: 35px; border-left: 4px solid #ccc; } 
    @keyframes float-shard { 0% { transform: rotate(0deg) translate(0, 0); } 50% { transform: rotate(180deg) translate(20px, 20px); } 100% { transform: rotate(360deg) translate(0, 0); } }
    h2 { font-size: 14px; color: var(--text-main); border-bottom: 2px solid var(--signal-red); padding-bottom: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; font-weight: 800; letter-spacing: 1px; }
    h2 i { color: var(--signal-red); }
    label { display: block; font-weight: 700; font-size: 11px; margin: 12px 0 6px; color: var(--text-dim); letter-spacing: 0.5px; text-transform: uppercase; }
    input[type="text"], textarea, .rich-editor, select { width: 100%; padding: 10px 12px; border: 1px solid #dcdcdc; background: var(--input-bg); border-radius: 4px; font-size: 14px; color: var(--text-main); transition: all 0.2s; font-family: inherit; }
    select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; padding-right: 30px; }
    input:focus, textarea:focus, .rich-editor:focus, select:focus { outline: none; border-color: var(--signal-red); background: #fff; box-shadow: 0 0 0 2px rgba(192, 57, 43, 0.1); }
    .rich-editor { min-height: 60px; white-space: pre-wrap; }
    .rich-editor:empty:before { content: attr(placeholder); color: #bdc3c7; font-style: italic; }
    .small-input { width: 45px !important; padding: 5px !important; text-align: center; flex-shrink: 0; margin: 0 5px; }
    .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .perm-group input { margin-bottom: 8px; }
    .perm-note { background: #f0f2f5; padding: 10px; border-radius: 4px; font-size: 12px; color: #666; margin-top: 10px; border-left: 3px solid #ccc; }
    
    /* 混合输入框（下拉/文本切换）样式修正 */
    .hybrid-input-wrapper { position: relative; display: flex; align-items: center; }
    .hybrid-input-wrapper input[type="text"] { display: none; }
    .hybrid-input-wrapper .rich-editor { display: none; width: 100%; padding-right: 30px; } /* 新增：支持富文本 */
    
    .hybrid-input-wrapper.show-input input[type="text"] { display: block; }
    .hybrid-input-wrapper.show-input .rich-editor { display: block; } /* 新增：显示富文本 */
    .hybrid-input-wrapper.show-input select { display: none; }
    
    .btn-reset-list { display: none; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #bdc3c7; border: none; border-radius: 50%; width: 20px; height: 20px; color: white; font-size: 10px; cursor: pointer; z-index: 5; align-items: center; justify-content: center; }
    .hybrid-input-wrapper.show-input .btn-reset-list { display: flex; }
    .hybrid-input-wrapper.has-editor .btn-reset-list { top: 10px; transform: none; } /* 新增：针对富文本框，按钮置顶 */
    .btn-reset-list:hover { background: var(--signal-red); }
    
    @media(min-width: 768px) { .char-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; margin-bottom: 20px; } .char-layout .panel { height: 100%; margin-bottom: 0; } }
    .attr-row { display: flex; align-items: center; margin-bottom: 12px; border-bottom: 1px dashed var(--border-color); padding-bottom: 8px; gap: 8px; }
    .attr-label { flex: 0 0 50px; background: #333; color: white; text-align: center; border-radius: 3px; font-size: 10px; padding: 4px 0; font-weight: bold; }
    .attr-input { flex: 0 0 36px; text-align: center; font-weight: bold; padding: 4px; background: white; border: 1px solid #ccc; color: var(--signal-red); }
    .attr-dots-container { flex: 1; display: flex; justify-content: center; }
    .attr-dots { display: flex; gap: 4px; }
    .dot { width: 16px; height: 16px; border: 1px solid #bdc3c7; border-radius: 50%; cursor: pointer; flex-shrink: 0; transition: all 0.2s; background: #fff; }
    .dot.active { background: #333; border-color: #333; }
    .dot.marked { background: var(--signal-red); border-color: var(--signal-red); }
    .track-header { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; align-items: end; }
    .track-stat { display: flex; flex-direction: column; align-items: center; width: 100%; }
    .track-stat label { margin: 0 0 6px; font-size: 10px; text-align: center; color: var(--text-dim); white-space: nowrap; }
    .track-stat input { width: 100%; min-width: 0; padding: 8px 0 !important; text-align: center; font-weight: bold; font-size: 16px; background: white; border-radius: 4px; }
    @media (min-width: 768px) { .track-header { display: flex; justify-content: center; gap: 25px; } .track-stat { width: auto; } .track-stat input { width: 80px !important; } }
    .p-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; max-width: 340px; margin: 0 auto 5px; }
    .p-cell { aspect-ratio: 1; border: 1px solid #bdc3c7; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 9px; color: #999; cursor: pointer; background: white; }
    .c-func { color: var(--functional); } .f-cell.active { background: var(--functional); border-color: var(--functional); color: white; }
    .c-real { color: var(--reality); } .r-cell.active { background: var(--reality); border-color: var(--reality); color: white; }
    .c-anom { color: var(--accent); } .a-cell.active { background: var(--accent); border-color: var(--accent); color: white; }
    .p-cell.ignored { background: #95a5a6; border-color: #7f8c8d; color: white; }
    .p-cell.ignored span { opacity: 0.7; }
    .track-rule { font-size: 11px; color: #7f8c8d; padding: 6px 0; border-top: 1px dotted var(--border-color); margin-top: 8px; }
    .mod-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: white; }
    .mod-header h2 { border: none; margin: 0; padding: 0; color: white; border-bottom: none; }
    .btn-add { background: white; border: none; padding: 5px 15px; border-radius: 20px; color: var(--signal-red); font-size: 11px; cursor: pointer; transition: 0.2s; font-weight: bold; text-transform: uppercase; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .btn-add:hover { background: #f0f0f0; }
    .btn-del { position: absolute; top: 10px; right: 10px; background: #fdf0ef; color: #e74c3c; width: 24px; height: 24px; border-radius: 50%; border: none; cursor: pointer; font-size: 14px; line-height: 1; display:flex; align-items:center; justify-content:center; z-index: 5; }
    .btn-del:hover { background: var(--signal-red); color: white; }
    .bd-anom { border-left-color: var(--accent); }
    .bd-real { border-left-color: var(--reality); }
    .bd-func { border-left-color: var(--functional); }
    .sq-dots { display: flex; gap: 4px; }
    .sq-dot { width: 14px; height: 14px; border: 1px solid #bdc3c7; border-radius: 2px; cursor: pointer; background: white; }
    .sq-dot.active { background: var(--accent); border-color: var(--accent); }
    .rel-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin: 8px 0; flex-wrap: nowrap; }
    .r-dots { display: flex; gap: 4px; flex: 1; overflow-x: auto; scrollbar-width: none; align-items: center; }
    .chk-btn { flex-shrink: 0; cursor: pointer; font-size: 11px; display: flex; align-items: center; user-select: none; }
    .chk-btn input { display: none; }
    .chk-btn span { padding: 4px 10px; background: #eee; color: #777; border-radius: 4px; transition: all 0.2s; font-weight: bold; border: 1px solid transparent; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
    .chk-btn input:checked + span { background: var(--signal-red); color: white; border-color: var(--signal-red); }
    .chk-btn input:checked + span::before { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; }
    .chk-btn span::after { content: "未激活"; }
    .chk-btn input:checked + span::after { content: "已激活"; }
    .chk-btn.chk-trained span::after { content: "未训练"; }
    .chk-btn.chk-trained input:checked + span::after { content: "已训练"; }
    .save-area { 
    text-align: center; 
    margin: 30px 0; 
    display: flex; 
    gap: 15px; 
    justify-content: center; 
    position: relative; 
    z-index: 2; 
    flex-wrap: wrap; /* 新增：允许按钮换行 */
	}.btn-purple { 
		background: #9b59b6; 
		box-shadow: 0 4px 10px rgba(155, 89, 182, 0.4); 
	}
	.btn-purple:hover { 
		background: #8e44ad; 
	}.btn-dark { 
		background: #34495e; 
		box-shadow: 0 4px 10px rgba(44, 62, 80, 0.4); 
	}
	.btn-dark:hover { 
		background: #2c3e50; 
	}
    .btn-save { background: var(--signal-red); color: white; border: none; padding: 12px 30px; border-radius: 4px; font-size: 13px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(192, 57, 43, 0.4); display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 1px; }
    .btn-export { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; }
    .btn-export:hover { border-color: white; background: rgba(255,255,255,0.1); }
    .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: calc(var(--nav-height) + var(--safe-bottom)); background: white; border-top: 1px solid #ddd; display: flex; z-index: 1000; padding-bottom: var(--safe-bottom); }
    .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #95a5a6; font-size: 10px; cursor: pointer; transition: 0.2s; }
    .nav-btn i { font-size: 18px; margin-bottom: 4px; }
    .nav-btn.active { color: var(--signal-red); }
    .nav-btn.active i { transform: translateY(-2px); }
    .nav-btn.n-char.active { color: #16a085; }
    .nav-btn.n-anom.active { color: var(--accent); }
    .nav-btn.n-real.active { color: var(--reality); }
    .nav-btn.n-item.active { color: var(--signal-red); }
    #status-msg { position: fixed; top: 20px; left:50%; transform:translateX(-50%); background: var(--signal-red); color: white; padding: 8px 20px; border-radius: 4px; font-size: 12px; display:none; z-index:2000; box-shadow: 0 5px 20px rgba(0,0,0,0.5); font-weight: bold; letter-spacing: 1px; }
	#status-msg.success { background: #27ae60; }
	#status-msg.error { background: var(--signal-red); }
	.nav-arrow { position: fixed; top: 50%; transform: translateY(-50%); font-size: 60px; color: var(--signal-red); cursor: pointer; z-index: 900; padding: 20px; display: none; transition: all 0.2s ease; opacity: 0.8; user-select: none; }
	.nav-arrow:hover { transform: translateY(-50%) scale(1.1); opacity: 1; text-shadow: 0 0 10px rgba(192, 57, 43, 0.4); }
	.arrow-left { left: calc(50% - 450px - 80px); }
	.arrow-right { right: auto; left: calc(50% + 450px + 20px); }
	.nav-arrow.disabled { color: #555; cursor: default; opacity: 0.3; pointer-events: none; }
	@media (min-width: 1150px) { .nav-arrow { display: block; } }
	@media (max-width: 1149px) { .nav-arrow { display: none !important; } }
</style>
</head>
<body>
<div id="status-msg"><i class="fas fa-save"></i> DATA_SAVED</div>
<div class="container">
<div class="top-nav">
<button class="btn-back" onclick="goBack()"><i class="fas fa-chevron-left"></i> 返回</button>
<div class="brand-logo-sm"><span>TRIANGLE</span><span>AGENCY</span></div>
<h1>职员档案 <span class="sub"><span class="offline-tag">OFFLINE</span><span class="readonly-tag">READ-ONLY</span></span></h1>
</div>
<div class="swiper-container" id="swiperContainer">
<div class="swiper-wrapper" id="swiperWrapper">
<div id="view-char" class="tab-view">
<div class="char-layout">
<div class="panel"><h2><i class="fas fa-shield-alt"></i> 资质保证</h2><div id="attrs-list"></div></div>
<div class="panel">
<h2><i class="fas fa-id-card"></i> 基础信息</h2>
<label>玩家姓名</label><input type="text" id="pName" placeholder="输入姓名">
<div class="row-2">
<div><label>异常能力</label><div class="hybrid-input-wrapper" id="grp-pAnom"><select id="sel-pAnom" onchange="handlePresetChange('pAnom', this.value)"></select><input type="text" id="pAnom" placeholder="输入异常能力"><button class="btn-reset-list" onclick="resetToDropdown('pAnom')"><i class="fas fa-list"></i></button></div></div>
<div><label>现实身份</label><div class="hybrid-input-wrapper" id="grp-pReal"><select id="sel-pReal" onchange="handlePresetChange('pReal', this.value)"></select><input type="text" id="pReal" placeholder="输入现实身份"><button class="btn-reset-list" onclick="resetToDropdown('pReal')"><i class="fas fa-list"></i></button></div></div>
</div>
<label>机构职能</label><div class="hybrid-input-wrapper" id="grp-pFunc"><select id="sel-pFunc" onchange="handlePresetChange('pFunc', this.value)"></select><input type="text" id="pFunc" placeholder="输入机构职能"><button class="btn-reset-list" onclick="resetToDropdown('pFunc')"><i class="fas fa-list"></i></button></div>
<label>现实触发器</label><div class="rich-editor" id="pTrig1" contenteditable="true" placeholder="GM可随时触发此项"></div>
<label>过载解除</label><div class="rich-editor" id="pTrig2" contenteditable="true" placeholder="如何解除过载"></div>
<label>首要指令</label><div class="rich-editor" id="pTrig3" contenteditable="true" placeholder="如果你……，则获得1点申诫"></div>
<label>许可行为</label><div class="perm-group"><input type="text" id="perm1" placeholder="许可行为 1"><input type="text" id="perm2" placeholder="许可行为 2"><input type="text" id="perm3" placeholder="许可行为 3"></div>
<div class="perm-note">如果你在单次任务中完成全部 3 项，将获得 3 点额外嘉奖。</div>
</div>
</div>
<div class="panel">
<h2><i class="fas fa-chart-bar"></i> 进度追踪</h2>
<div class="track-header">
<div class="track-stat"><label>MVP</label><input type="text" id="pComm" placeholder="0"></div>
<div class="track-stat"><label>嘉奖</label><input type="text" id="mvpCount" placeholder="0"></div>
<div class="track-stat"><label>申诫</label><input type="text" id="watchCount" placeholder="0"></div>
<div class="track-stat"><label>察看期</label><input type="text" id="pRep" placeholder="0"></div>
</div>
<div class="track-sec"><h3 class="c-func" style="font-size:12px; margin:5px 0;">职能</h3><div class="track-row"><div class="p-grid"><div class="p-cell f-cell" data-idx="1"></div><div class="p-cell f-cell" data-idx="2"></div><div class="p-cell f-cell" data-idx="3"><span>A3</span></div><div class="p-cell f-cell" data-idx="4"></div><div class="p-cell f-cell" data-idx="5"></div><div class="p-cell f-cell" data-idx="6"><span>D4</span></div><div class="p-cell f-cell" data-idx="7"></div><div class="p-cell f-cell" data-idx="8"></div><div class="p-cell f-cell" data-idx="9"><span>G3</span></div><div class="p-cell f-cell" data-idx="10"></div></div><div class="p-grid"><div class="p-cell f-cell" data-idx="11"></div><div class="p-cell f-cell" data-idx="12"><span>J3</span></div><div class="p-cell f-cell" data-idx="13"></div><div class="p-cell f-cell" data-idx="14"></div><div class="p-cell f-cell" data-idx="15"><span>N3</span></div><div class="p-cell f-cell" data-idx="16"></div><div class="p-cell f-cell" data-idx="17"></div><div class="p-cell f-cell" data-idx="18"><span>Q3</span></div><div class="p-cell f-cell" data-idx="19"></div><div class="p-cell f-cell" data-idx="20"></div></div><div class="p-grid"><div class="p-cell f-cell" data-idx="21"><span>T3</span></div><div class="p-cell f-cell" data-idx="22"></div><div class="p-cell f-cell" data-idx="23"></div><div class="p-cell f-cell" data-idx="24"><span>W8</span></div><div class="p-cell f-cell" data-idx="25"></div><div class="p-cell f-cell" data-idx="26"></div><div class="p-cell f-cell" data-idx="27"><span>Y2</span></div><div class="p-cell f-cell" data-idx="28"></div><div class="p-cell f-cell" data-idx="29"></div><div class="p-cell f-cell" data-idx="30"></div></div></div><div class="track-rule">当你获得任务MVP时，在你的职能记录条上标记1格，且无需从其他记录条上移除一格。</div><div class="track-rule">每当你在职能记录条上标记一格时，将任意一项资质的"资质保证上限"提升1点，最高不超过9点。</div></div>
<div class="track-sec"><h3 class="c-real" style="font-size:12px; margin:5px 0;">现实</h3><div class="track-row"><div class="p-grid"><div class="p-cell r-cell" data-idx="1"><span>C4</span></div><div class="p-cell r-cell" data-idx="2"></div><div class="p-cell r-cell" data-idx="3"></div><div class="p-cell r-cell" data-idx="4"><span>L11</span></div><div class="p-cell r-cell" data-idx="5"></div><div class="p-cell r-cell" data-idx="6"></div><div class="p-cell r-cell" data-idx="7"></div><div class="p-cell r-cell" data-idx="8"><span>E2</span></div><div class="p-cell r-cell" data-idx="9"></div><div class="p-cell r-cell" data-idx="10"><span>O4</span></div></div><div class="p-grid"><div class="p-cell r-cell" data-idx="11"></div><div class="p-cell r-cell" data-idx="12"><span>J3</span></div><div class="p-cell r-cell" data-idx="13"></div><div class="p-cell r-cell" data-idx="14"><span>T6</span></div><div class="p-cell r-cell" data-idx="15"></div><div class="p-cell r-cell" data-idx="16"><span>V2</span></div><div class="p-cell r-cell" data-idx="17"></div><div class="p-cell r-cell" data-idx="18"></div><div class="p-cell r-cell" data-idx="19"></div><div class="p-cell r-cell" data-idx="20"><span>X3</span></div></div><div class="p-grid"><div class="p-cell r-cell" data-idx="21"></div><div class="p-cell r-cell" data-idx="22"><span>H5</span></div><div class="p-cell r-cell" data-idx="23"></div><div class="p-cell r-cell" data-idx="24"></div><div class="p-cell r-cell" data-idx="25"></div><div class="p-cell r-cell" data-idx="26"></div><div class="p-cell r-cell" data-idx="27"><span>E3</span></div><div class="p-cell r-cell" data-idx="28"></div><div class="p-cell r-cell" data-idx="29"></div><div class="p-cell r-cell" data-idx="30"></div></div></div><div class="track-rule">当你既未获得任务MVP也未进入察看期时，你可以将你与任意一段关系的连结提升1点。</div><div class="track-rule">每当你在现实记录条上标记一格时，将你与任意一段"关系"的"连结"提升1点，然后对关系网内的每段关系重复此操作。</div></div>
<div class="track-sec"><h3 class="c-anom" style="font-size:12px; margin:5px 0;">异常</h3><div class="track-row"><div class="p-grid"><div class="p-cell a-cell" data-idx="1"><span>H4</span></div><div class="p-cell a-cell" data-idx="2"><span>H3</span></div><div class="p-cell a-cell" data-idx="3"></div><div class="p-cell a-cell" data-idx="4"></div><div class="p-cell a-cell" data-idx="5"><span>U2</span></div><div class="p-cell a-cell" data-idx="6"></div><div class="p-cell a-cell" data-idx="7"><span>X2</span></div><div class="p-cell a-cell" data-idx="8"></div><div class="p-cell a-cell" data-idx="9"></div><div class="p-cell a-cell" data-idx="10"></div></div><div class="p-grid"><div class="p-cell a-cell" data-idx="11"><span>N1</span></div><div class="p-cell a-cell" data-idx="12"></div><div class="p-cell a-cell" data-idx="13"><span>Q2</span></div><div class="p-cell a-cell" data-idx="14"></div><div class="p-cell a-cell" data-idx="15"></div><div class="p-cell a-cell" data-idx="16"></div><div class="p-cell a-cell" data-idx="17"><span>L10</span></div><div class="p-cell a-cell" data-idx="18"></div><div class="p-cell a-cell" data-idx="19"><span>G8</span></div><div class="p-cell a-cell" data-idx="20"></div></div><div class="p-grid"><div class="p-cell a-cell" data-idx="21"></div><div class="p-cell a-cell" data-idx="22"></div><div class="p-cell a-cell" data-idx="23"><span>A7</span></div><div class="p-cell a-cell" data-idx="24"></div><div class="p-cell a-cell" data-idx="25"></div><div class="p-cell a-cell" data-idx="26"></div><div class="p-cell a-cell" data-idx="27"></div><div class="p-cell a-cell" data-idx="28"></div><div class="p-cell a-cell" data-idx="29"></div><div class="p-cell a-cell" data-idx="30"></div></div></div><div class="track-rule">当你进入察看期时，在你的异常记录条上标记1格，且无需从其他记录条上移除一格。</div><div class="track-rule">每当你在异常记录条上标记一格时，选择一项：<br>➤练习：在任意一项异常能力上标记"熟练"。 <br>➤广为人知：从一项异常能力中移除"熟练"标记，并向你的团队提出该能力的问题。在获得最多票数的答案轨道上做标记，然后获得所有已解锁的能力。</div></div>
</div>
<div class="panel"><h2><i class="fas fa-file-contract"></i> 欢迎你，特工！</h2><div style="margin-bottom:12px;"><label>1. 你是如何与你的异常接触的？</label><div class="rich-editor" id="q1" contenteditable="true"></div></div><div style="margin-bottom:12px;"><label>2. 机构是如何找到你的？</label><div class="rich-editor" id="q2" contenteditable="true"></div></div><div style="margin-bottom:12px;"><label>3. 你的能力有独特的外在视觉表现吗？</label><div class="rich-editor" id="q3" contenteditable="true"></div></div><div style="margin-bottom:12px;"><label>4. 你喝咖啡有什么偏好？</label><div class="rich-editor" id="q4" contenteditable="true"></div></div><div style="margin-bottom:12px;"><label>5. 请描述你过往的工作经历</label><div class="rich-editor" id="q5" contenteditable="true"></div></div><div style="margin-bottom:12px;"><label>6. 你对Adobe、Excel和Google套件的熟悉程度如何？</label><div class="rich-editor" id="q6" contenteditable="true"></div></div><div style="margin-bottom:12px;"><label>7. 在协作工作环境中，你能做出什么贡献？</label><div class="rich-editor" id="q7" contenteditable="true"></div></div></div>
<div class="panel"><h2><i class="fas fa-sticky-note"></i> 备注/笔记</h2><label>标题</label><input type="text" id="noteTitle" style="margin-bottom: 12px; font-weight: bold;"><label>内容</label><div class="rich-editor" id="noteBody" contenteditable="true" placeholder="摘要..."></div></div>
<div class="save-area"><button class="btn-save btn-save-server" onclick="saveData()"><i class="fas fa-cloud-upload-alt"></i> 上传终端</button>
<button class="btn-save btn-export" onclick="exportOffline()"><i class="fas fa-download"></i> 离线另存</button><button class="btn-save btn-export" onclick="exportJson()"><i class="fas fa-file-code"></i> 导出JSON</button><button class="btn-save btn-export" onclick="triggerImport()"><i class="fas fa-file-import"></i> 导入覆盖</button>
<input type="file" id="jsonInput" accept=".json" style="display:none" onchange="handleImportJson(this)">
</div>
</div>
<div id="view-anom" class="tab-view"><div class="mod-header"><h2>异常能力</h2><button class="btn-add" onclick="addAnom(null, false)"><i class="fas fa-plus"></i> 添加</button></div><div id="list-anom"></div><div class="save-area"><button class="btn-save btn-save-server" onclick="saveData()"><i class="fas fa-cloud-upload-alt"></i> 上传终端</button><button class="btn-save btn-export" onclick="exportOffline()"><i class="fas fa-download"></i> 离线另存</button></div></div>
<div id="view-real" class="tab-view"><div class="mod-header"><h2>关系网</h2><button class="btn-add" onclick="addRealSafe()"><i class="fas fa-plus"></i> 添加</button></div><div id="list-real"></div><div class="save-area"><button class="btn-save btn-save-server" onclick="saveData()"><i class="fas fa-cloud-upload-alt"></i> 上传终端</button><button class="btn-save btn-export" onclick="exportOffline()"><i class="fas fa-download"></i> 离线另存</button></div></div>
<div id="view-item" class="tab-view"><div class="mod-header"><h2>申领物/福利</h2><button class="btn-add" onclick="addItem(null, false)"><i class="fas fa-plus"></i> 添加</button></div><div id="list-item"></div><div class="save-area"><button class="btn-save btn-save-server" onclick="saveData()"><i class="fas fa-cloud-upload-alt"></i> 上传终端</button><button class="btn-save btn-export" onclick="exportOffline()"><i class="fas fa-download"></i> 离线另存</button></div></div>
</div>
</div>
</div>
<div class="nav-bar">
<div class="nav-btn active n-char" onclick="switchView('view-char', this)"><i class="fas fa-id-badge"></i><span>档案</span></div>
<div class="nav-btn n-anom" onclick="switchView('view-anom', this)"><i class="fas fa-bolt"></i><span>异常</span></div>
<div class="nav-btn n-real" onclick="switchView('view-real', this)"><i class="fas fa-heart"></i><span>关系</span></div>
<div class="nav-btn n-item" onclick="switchView('view-item', this)"><i class="fas fa-box-open"></i><span>物品</span></div>
</div>
<script id="__SAVED_DATA__" type="application/json"></script>
<script>
const params = new URLSearchParams(window.location.search);
const charId = params.get('id');
const isReadOnly = params.get('readonly') === 'true';
const token = localStorage.getItem('ta_token');

// 获取带认证的请求头
function getAuthHeaders() {
    const headers = { 'Content-Type': 'application/json' };
    if (token) headers['Authorization'] = `Bearer ${token}`;
    return headers;
}

// [修改] 初始化增加 bonuses
let CONFIG_DATA = { anoms: [], realities: [], functions: [], bonuses: [] };

// 槽位限制
let SLOT_LIMITS = { anomSlots: 3, realSlots: 3 };

async function loadConfigData() {
    try {
        const res = await fetch('/api/options');
        if (res.ok) {
            CONFIG_DATA = await res.json();
            console.log("配置数据加载成功:", CONFIG_DATA);
            initDropdowns();
        } else { console.error("无法加载配置数据"); }
    } catch (e) { console.error("配置数据请求出错:", e); }
}

function initDropdowns() {
    const fillSelect = (id, items) => {
        const sel = document.getElementById(id);
        if(!sel) return;
        sel.innerHTML = '<option value="" disabled selected>-- 请选择 --</option>';
        if (items && Array.isArray(items)) {
            items.forEach(item => {
                const val = typeof item === 'string' ? item : item.name;
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = val;
                sel.appendChild(opt);
            });
        }
        const customOpt = document.createElement('option');
        customOpt.value = '__CUSTOM__';
        customOpt.textContent = '➤ 自定义 / 手动输入...';
        sel.appendChild(customOpt);
    };
    fillSelect('sel-pAnom', CONFIG_DATA.anoms);
    fillSelect('sel-pReal', CONFIG_DATA.realities);
    fillSelect('sel-pFunc', CONFIG_DATA.functions);
}

function handlePresetChange(fieldId, value) {
    const wrapper = document.getElementById(`grp-${fieldId}`);
    const input = document.getElementById(fieldId);
    if (value === '__CUSTOM__') {
        wrapper.classList.add('show-input');
        input.value = ''; 
        input.focus();
    } else {
        input.value = value;
        applyCascadingLogic(fieldId, value);
    }
}

function resetToDropdown(fieldId) {
    const wrapper = document.getElementById(`grp-${fieldId}`);
    const select = document.getElementById(`sel-${fieldId}`);
    const input = document.getElementById(fieldId);
    wrapper.classList.remove('show-input');
    select.value = ''; 
    input.value = '';  
}

// ===================================
// 联动逻辑
// ===================================
function applyCascadingLogic(fieldId, value) {
    if (!value) return;

    if (fieldId === 'pReal') {
        const config = CONFIG_DATA.realities.find(r => r.name === value);
        if (config) {
            document.getElementById('pTrig1').innerHTML = config.trigger || ''; 
            document.getElementById('pTrig2').innerHTML = config.overload || '';
        }
    } 
    else if (fieldId === 'pFunc') {
        const config = CONFIG_DATA.functions.find(f => f.name === value);
        if (config) {
            document.getElementById('pTrig3').innerHTML = config.directive;
            if (config.perms && config.perms.length === 3) {
                document.getElementById('perm1').value = config.perms[0];
                document.getElementById('perm2').value = config.perms[1];
                document.getElementById('perm3').value = config.perms[2];
            }
            const itemListContainer = document.getElementById('list-item');
            const presetItems = (config.items || []).slice().reverse();
            const numToReplace = presetItems.length;
            for (let i = 0; i < numToReplace; i++) {
                if (itemListContainer.firstChild) {
                    itemListContainer.firstChild.remove();
                }
            }
            presetItems.forEach(itemData => {
                addItem(itemData, true);
            });
        }
    }
    else if (fieldId === 'pAnom') {
        const config = CONFIG_DATA.anoms.find(a => a.name === value);
        if (config) {
             const anomListContainer = document.getElementById('list-anom');
            const presetAbilities = (config.abilities || []).slice().reverse();
            const numToReplace = presetAbilities.length;
            for (let i = 0; i < numToReplace; i++) {
                if (anomListContainer.firstChild) {
                    anomListContainer.firstChild.remove();
                }
            }
            presetAbilities.forEach(abilityData => {
                addAnom(abilityData, true);
            });
        }
    }
}

function setHybridInputState(fieldId, value) {
    const select = document.getElementById(`sel-${fieldId}`);
    const wrapper = document.getElementById(`grp-${fieldId}`);
    const input = document.getElementById(fieldId);
    let isPreset = false;
    Array.from(select.options).forEach(opt => { if (opt.value === value) isPreset = true; });
    input.value = value || '';
    if (isPreset) {
        wrapper.classList.remove('show-input');
        select.value = value;
    } else if (value && value.trim() !== '') {
        wrapper.classList.add('show-input');
        select.value = '__CUSTOM__';
    } else {
        wrapper.classList.remove('show-input');
        select.value = '';
    }
}

document.addEventListener('wheel', (e) => { const a=document.querySelectorAll('.tab-view')[currentTab]; if(a&&!a.contains(e.target))a.scrollTop+=e.deltaY;}, {passive:true});
let mouseStartX = 0;
let mouseStartY = 0;

// 1. 记录鼠标按下的位置
document.addEventListener('mousedown', (e) => {
    mouseStartX = e.clientX;
    mouseStartY = e.clientY;
});
// 2. 修改后的点击监听
document.addEventListener('click', (e) => {
    // 计算移动距离
    const diffX = Math.abs(e.clientX - mouseStartX);
    const diffY = Math.abs(e.clientY - mouseStartY);

    // 如果移动超过 5 像素，视为拖拽，不触发页面切换
    if (diffX > 5 || diffY > 5) return;

    const c = document.querySelector('.container');
    const n = document.querySelector('.nav-bar');
    
    // 排除条件：
    // 1. 屏幕宽度小于等于 930px (手机端由触摸逻辑接管)
    // 2. 点击在内容容器内
    // 3. 点击在底部导航栏内
    // 4. 点击的是左右箭头按钮 (箭头有自己的 onclick 事件)
    if (window.innerWidth <= 930 || 
        c.contains(e.target) || 
        (n && n.contains(e.target)) || 
        e.target.closest('.nav-arrow')) {
        return;
    }
	
	// 执行切换逻辑
    const x = e.clientX;
    const m = window.innerWidth / 2;
    if (x < m) {
        if (currentTab > 0) {
            currentTab--;
            updateSwiper();
        }
    } else {
        if (currentTab < tabOrder.length - 1) {
            currentTab++;
            updateSwiper();
        }
    }
});

let currentTab = 0;
const tabOrder = ['view-char', 'view-anom', 'view-real', 'view-item'];
const swiperWrapper = document.getElementById('swiperWrapper');
const navBtns = document.querySelectorAll('.nav-btn');
function switchView(id, btn) { const i=tabOrder.indexOf(id); if(i!==-1){currentTab=i;updateSwiper();} }
function moveTab(dir) { const n=currentTab+dir; if(n>=0&&n<tabOrder.length){currentTab=n;updateSwiper();} }
function updateSwiper() { swiperWrapper.style.transform=`translateX(-${currentTab*25}%)`; navBtns.forEach((b,i)=>{if(i===currentTab)b.classList.add('active');else b.classList.remove('active');}); document.querySelectorAll('.tab-view')[currentTab].scrollTop=0; const l=document.querySelector('.arrow-left'), r=document.querySelector('.arrow-right'); if(l&&r){ if(currentTab===0)l.classList.add('disabled');else l.classList.remove('disabled'); if(currentTab===tabOrder.length-1)r.classList.add('disabled');else r.classList.remove('disabled');} }
let touchStartX=0, touchStartY=0, isSwipingDisabled=false; const minSwipe=60, container=document.getElementById('swiperContainer');
container.addEventListener('touchstart',e=>{ const t=e.target; if(t.tagName.toLowerCase()==='input'||t.tagName.toLowerCase()==='textarea'||t.isContentEditable||t.tagName.toLowerCase()==='select'){isSwipingDisabled=true;}else{isSwipingDisabled=false;touchStartX=e.changedTouches[0].screenX;touchStartY=e.changedTouches[0].screenY;}},{passive:true});
container.addEventListener('touchend',e=>{ if(isSwipingDisabled)return; const x=e.changedTouches[0].screenX, y=e.changedTouches[0].screenY; handleSwipe(x,y);},{passive:true});
function handleSwipe(endX,endY){ const dX=endX-touchStartX, dY=endY-touchStartY; if(Math.abs(dX)>minSwipe&&Math.abs(dX)>Math.abs(dY)){ if(dX<0){if(currentTab<tabOrder.length-1){currentTab++;updateSwiper();}}else{if(currentTab>0){currentTab--;updateSwiper();}}}}
function setRandomVars(el) { el.style.setProperty('--r1',Math.random()); el.style.setProperty('--r2',Math.random()); el.style.setProperty('--r3',Math.random()); }
document.addEventListener('DOMContentLoaded', async () => {
    document.querySelectorAll('.panel').forEach(setRandomVars);
    await loadConfigData();
    updateSwiper();
    initAttrs();
    const offlineDataEl = document.getElementById('__SAVED_DATA__');
    if(offlineDataEl && offlineDataEl.textContent.trim().length > 2) {
        document.body.classList.add('offline-mode');
        populateData(JSON.parse(offlineDataEl.textContent));
    } else {
        if(!charId) { window.location.href='dashboard.html'; return; }
        try {
            const res=await fetch(`/api/character/${charId}`, { headers: getAuthHeaders() });
            if (res.status === 401 || res.status === 403) {
                window.location.href = 'login.html';
                return;
            }
            const data=await res.json();
            populateData(data);
        }
        catch(e) { if(!document.getElementById('list-anom').children.length) addAnom(null, false); if(!document.getElementById('list-real').children.length) document.getElementById('list-real').appendChild(addReal()); if(!document.getElementById('list-item').children.length) addItem(null, false); }
    }
});
if (isReadOnly) {
    document.body.classList.add('readonly-mode');
    document.addEventListener('DOMContentLoaded', () => {
         document.querySelectorAll('[contenteditable]').forEach(el => el.setAttribute('contenteditable', 'false'));
         ['pAnom', 'pReal', 'pFunc'].forEach(id => { document.getElementById(`grp-${id}`).classList.add('show-input'); });
    });
}
async function goBack() { if(isReadOnly||document.body.classList.contains('offline-mode')){if(isReadOnly){window.location.href='monitor.html';return;}window.location.href='dashboard.html';return;} const b=document.querySelector('.btn-back'); b.innerHTML='<i class="fas fa-spinner fa-spin"></i> 保存中'; try{await saveData(true);}catch(e){console.error("Auto-save failed:",e);} window.location.href='dashboard.html';}
const ATTRS=['专注','欺瞒','活力','共情','主动','坚毅','气场','专业','诡秘'];
function initAttrs(){ const c=document.getElementById('attrs-list');c.innerHTML='';ATTRS.forEach(a=>{ const d=document.createElement('div');d.className='attr-row';d.innerHTML=`<div class="attr-label">${a}</div><input type="text" class="attr-input" data-attr="${a}" value="0"><div class="attr-dots-container"><div class="attr-dots" data-attr="${a}">${Array(9).fill(0).map((_,i)=>`<div class="dot" data-i="${i+1}"></div>`).join('')}</div></div>`;c.appendChild(d); const i=d.querySelector('input');i.oninput=(e)=>renderDots(a,e.target.value);d.querySelectorAll('.dot').forEach(dot=>{dot.onclick=()=>{if(isReadOnly)return;const max=parseInt(i.value)||0,idx=parseInt(dot.dataset.i);if(idx>max)return;if(dot.classList.contains('marked')){dot.classList.remove('marked');dot.classList.add('active');}else{dot.classList.remove('active');dot.classList.add('marked');}}});});}
function renderDots(a,v){const val=parseInt(v)||0;document.querySelectorAll(`.attr-dots[data-attr="${a}"] .dot`).forEach((d,i)=>{if(i<val){if(!d.classList.contains('marked'))d.classList.add('active');}else{d.classList.remove('active','marked');}}); }
function createDelBtn(type){
    return`<button class="btn-del" onclick="deleteCard(this, '${type}')">×</button>`;
}

function deleteCard(btn, type) {
    if(!confirm('确定删除?')) return;
    btn.parentElement.remove();
    updateSlotButtons();
}

// 更新添加按钮状态
function updateSlotButtons() {
    const anomCount = document.querySelectorAll('#list-anom .card').length;
    const realCount = document.querySelectorAll('#list-real .card').length;

    const btnAddAnom = document.querySelector('#view-anom .btn-add');
    const btnAddReal = document.querySelector('#view-real .btn-add');

    if (btnAddAnom) {
        // 始终启用按钮
        btnAddAnom.disabled = false;
        btnAddAnom.innerHTML = `<i class="fas fa-plus"></i> 添加 (${anomCount})`;
        btnAddAnom.style.opacity = '1';
        btnAddAnom.style.cursor = 'pointer';
    }

    if (btnAddReal) {
        // 始终启用按钮
        btnAddReal.disabled = false;
        btnAddReal.innerHTML = `<i class="fas fa-plus"></i> 添加 (${realCount})`;
        btnAddReal.style.opacity = '1';
        btnAddReal.style.cursor = 'pointer';
    }
}

function addAnom(d=null, prepend=false, skipCheck=false){
    // [修改] 移除了槽位限制检查逻辑
    
    const div=document.createElement('div');
    div.className='card bd-anom';
    div.innerHTML=`${createDelBtn('anom')}<div class="row-2" style="margin-bottom:10px"><input type="text" class="f-name" placeholder="能力名称"><input type="text" class="f-trig" placeholder="触发器"></div><input type="text" class="f-qual" placeholder="资质" style="margin-bottom:10px"><label class="c-anom">成功时</label><div class="rich-editor f-succ" contenteditable="true"></div><label style="color:#c0392b;margin-top:8px">失败时</label><div class="rich-editor f-fail" contenteditable="true"></div><div style="background:#f9f9f9;padding:10px;border-radius:6px;margin-top:10px;border:1px solid #eee"><div style="display:flex;align-items:center;margin-bottom:6px;gap:10px"><input type="text" class="f-tdesc" placeholder="问题" style="flex:1;margin-bottom:0"><label class="chk-btn chk-trained"><input type="checkbox" class="f-chk"><span></span></label></div><div style="display:flex;gap:8px;align-items:center;margin-bottom:6px"><input type="text" class="f-t1" placeholder="答案1" style="flex:1"><input type="text" class="small-input f-t1-val"><div class="sq-dots d1">${get3Sq()}</div></div><div style="display:flex;gap:8px;align-items:center"><input type="text" class="f-t2" placeholder="答案2" style="flex:1"><input type="text" class="small-input f-t2-val"><div class="sq-dots d2">${get3Sq()}</div></div></div>`; 
    setupSq(div);
    if(d) fillAnom(div,d);
    setRandomVars(div); 
    
    const container = document.getElementById('list-anom'); 
    if(prepend) { container.prepend(div); } else { container.appendChild(div); } 
    if(isReadOnly){div.querySelectorAll('[contenteditable]').forEach(e=>e.setAttribute('contenteditable','false'));}
    
    updateSlotButtons();
}

// [修改] 辅助函数：构建连结加成下拉选项 (增加省略号逻辑)
function getBonusOptions() {
    let opts = '<option value="" disabled selected>-- 选择连结加成 --</option>';
    if (CONFIG_DATA.bonuses && Array.isArray(CONFIG_DATA.bonuses)) {
        CONFIG_DATA.bonuses.forEach(b => {
            const val = typeof b === 'string' ? b : (b.content || b.name);
            const name = typeof b === 'string' ? b : b.name;
            
            // 处理显示文本：超过20字省略
            let displayName = name;
            if (displayName.length > 20) {
                displayName = displayName.substring(0, 20) + '...';
            }

            const safeVal = val.replace(/"/g, '&quot;');
            // value 存完整文本，标签内容存省略后的文本
            opts += `<option value="${safeVal}">${displayName}</option>`;
        });
    }
    opts += '<option value="__CUSTOM__">➤ 自定义 / 手动输入...</option>';
    return opts;
}

// [新增] 处理连结加成下拉变化
window.handleBonusChange = function(select) {
    const wrapper = select.parentElement;
    const editor = wrapper.querySelector('.rich-editor');
    const val = select.value;
    wrapper.classList.add('show-input'); 
    if (val === '__CUSTOM__') {
        editor.focus();
    } else {
        editor.innerHTML = val;
    }
};

// [新增] 重置连结加成回下拉菜单
window.resetBonus = function(btn) {
    const wrapper = btn.parentElement;
    const select = wrapper.querySelector('select');
    wrapper.classList.remove('show-input');
    select.value = ''; 
};

// [修改] addReal 函数，移除了槽位检查
function addReal(d = null, skipCheck = false) {
    // [修改] 移除了槽位限制检查逻辑

    const div = document.createElement('div');
    div.className = 'card bd-real';
    const bonusOptions = getBonusOptions();
    div.innerHTML = `
        ${createDelBtn('real')}
        <div class="row-2" style="margin-bottom:10px">
            <input type="text" class="f-name" placeholder="姓名">
            <input type="text" class="f-actor" placeholder="扮演者">
        </div>
        <div class="rich-editor f-desc" contenteditable="true" placeholder="描述" style="margin-bottom:10px"></div>
        <label>连结进度</label>
        <div class="rel-row">
            <div class="sq-dots r-dots">${get9Dots()}</div>
            <label class="chk-btn"><input type="checkbox" class="f-act"><span></span></label>
        </div>
        <label>连结加成</label>
        <div class="hybrid-input-wrapper has-editor">
            <select class="f-conn-sel" onchange="handleBonusChange(this)">${bonusOptions}</select>
            <div class="rich-editor f-conn" contenteditable="true" placeholder="选择预设或输入加成效果..."></div>
            <button class="btn-reset-list" onclick="resetBonus(this)"><i class="fas fa-list"></i></button>
        </div>
    `;
    setupRDots(div);
    if (d) fillReal(div, d);
    setRandomVars(div);
    if (isReadOnly) {
        div.querySelectorAll('[contenteditable]').forEach(e => e.setAttribute('contenteditable', 'false'));
        div.querySelector('.hybrid-input-wrapper').classList.add('show-input');
    }
    setTimeout(updateSlotButtons, 0);
    return div;
}

function addItem(d=null, prepend=false){const div=document.createElement('div');div.className='card bd-func';div.innerHTML=`${createDelBtn('item')}<div class="row-2" style="margin-bottom:10px"><input type="text" class="f-item" placeholder="物品名称"><input type="text" class="f-pd" placeholder="页面/PD码"></div><label>效果</label><div class="rich-editor f-eff" contenteditable="true"></div>`;if(d){div.querySelector('.f-item').value=d.item||'';div.querySelector('.f-pd').value=d.pd||'';div.querySelector('.f-eff').innerHTML=d.eff||'';}setRandomVars(div); const container = document.getElementById('list-item'); if(prepend) { container.prepend(div); } else { container.appendChild(div); } if(isReadOnly){div.querySelectorAll('[contenteditable]').forEach(e=>e.setAttribute('contenteditable','false'));}}

function get3Sq(){return` <div class="sq-dot"></div><div class="sq-dot"></div><div class="sq-dot"></div> `;}
function get9Dots(){return Array(9).fill(0).map((_,i)=>`<div class="dot" data-i="${i+1}"></div>`).join('');}
function setupSq(div){div.querySelectorAll('.sq-dot').forEach(d=>d.onclick=()=>{if(!isReadOnly)d.classList.toggle('active');});}

// 安全添加关系（带槽位检查）
function addRealSafe() {
    const card = addReal(null, false);
    if (card) {
        document.getElementById('list-real').appendChild(card);
    }
}
function setupRDots(div){const d=div.querySelectorAll('.r-dots .dot');d.forEach(dot=>{dot.onclick=()=>{if(isReadOnly)return;const idx=parseInt(dot.dataset.i);d.forEach((dd,i)=>{if(i<idx)dd.classList.add('active');else dd.classList.remove('active');});}});}
function fillAnom(div,d){div.querySelector('.f-name').value=d.name||'';div.querySelector('.f-trig').value=d.trig||'';div.querySelector('.f-qual').value=d.qual||'';div.querySelector('.f-succ').innerHTML=d.succ||'';div.querySelector('.f-fail').innerHTML=d.fail||'';if(d.chk)div.querySelector('.f-chk').checked=d.chk;if(d.tdesc)div.querySelector('.f-tdesc').value=d.tdesc;if(d.t1)div.querySelector('.f-t1').value=d.t1;if(d.t1v)div.querySelector('.f-t1-val').value=d.t1v;if(d.t2)div.querySelector('.f-t2').value=d.t2;if(d.t2v)div.querySelector('.f-t2-val').value=d.t2v;if(d.p1)div.querySelectorAll('.d1 .sq-dot').forEach((e,i)=>{if(d.p1[i])e.classList.add('active')});if(d.p2)div.querySelectorAll('.d2 .sq-dot').forEach((e,i)=>{if(d.p2[i])e.classList.add('active')});}

// [修改] fillReal 函数，处理连结加成回显
function fillReal(div, d) {
    div.querySelector('.f-name').value = d.name;
    div.querySelector('.f-actor').value = d.actor;
    div.querySelector('.f-desc').innerHTML = d.desc;
    div.querySelector('.f-act').checked = d.act;
    
    const connEditor = div.querySelector('.f-conn');
    const connWrapper = div.querySelector('.hybrid-input-wrapper');
    connEditor.innerHTML = d.conn;
    
    // 只要已有内容（哪怕是空字符串），都切换到编辑模式
    if (d.conn !== undefined && d.conn !== null) {
        connWrapper.classList.add('show-input');
        div.querySelector('.f-conn-sel').value = '__CUSTOM__'; 
    }

    div.querySelectorAll('.r-dots .dot').forEach((e, i) => {
        if (i < d.lvl) e.classList.add('active')
    });
}

document.querySelectorAll('.p-cell').forEach(c=>{c.addEventListener('click',()=>{if(isReadOnly)return;if(c.classList.contains('active')){c.classList.remove('active');c.classList.add('ignored');}else if(c.classList.contains('ignored')){c.classList.remove('ignored');}else{c.classList.add('active');}});c.addEventListener('contextmenu',(e)=>{e.preventDefault();if(isReadOnly)return;c.classList.remove('active');c.classList.add('ignored');});});
function populateData(d){
    // 更新槽位限制
    SLOT_LIMITS.anomSlots = d.anomSlots || 3;
    SLOT_LIMITS.realSlots = d.realSlots || 3;

    ['pName','pTrig1','pTrig2','pTrig3','perm1','perm2','perm3','pComm','pRep','mvpCount','watchCount','noteTitle','noteBody'].forEach(id=>{const e=document.getElementById(id);if(d[id]&&e){if(e.tagName==='DIV')e.innerHTML=d[id];else e.value=d[id];}});setHybridInputState('pAnom',d.pAnom);setHybridInputState('pReal',d.pReal);setHybridInputState('pFunc',d.pFunc);if(d.qs)d.qs.forEach((h,i)=>{const q=document.getElementById(`q${i+1}`);if(q)q.innerHTML=h;});if(d.attrs){for(let k in d.attrs){const r=document.querySelector(`.attr-input[data-attr="${k}"]`);if(r){r.value=d.attrs[k].v;renderDots(k,d.attrs[k].v);const dots=r.parentElement.querySelectorAll('.dot');d.attrs[k].m.forEach(idx=>{if(dots[idx-1]){dots[idx-1].classList.remove('active');dots[idx-1].classList.add('marked');}});}}}document.getElementById('list-anom').innerHTML='';document.getElementById('list-real').innerHTML='';document.getElementById('list-item').innerHTML='';
    // 加载数据时跳过槽位检查
    (d.anoms||[]).forEach(x=>addAnom(x, false, true));
    (d.reals||[]).forEach(x=>{const card = addReal(x, true); if(card) document.getElementById('list-real').appendChild(card);});
    (d.items||[]).forEach(x=>addItem(x, false));
    // 如果没有数据，添加默认卡片（跳过检查）
    if(!document.getElementById('list-anom').children.length)addAnom(null, false, true);
    if(!document.getElementById('list-real').children.length){const card = addReal(null, true); if(card) document.getElementById('list-real').appendChild(card);}
    if(!document.getElementById('list-item').children.length)addItem(null, false);
    (d.pf||[]).forEach(i=>document.querySelector(`.f-cell[data-idx="${i}"]`)?.classList.add('active'));(d.pr||[]).forEach(i=>document.querySelector(`.r-cell[data-idx="${i}"]`)?.classList.add('active'));(d.pa||[]).forEach(i=>document.querySelector(`.a-cell[data-idx="${i}"]`)?.classList.add('active'));(d.pf_ign||[]).forEach(i=>document.querySelector(`.f-cell[data-idx="${i}"]`)?.classList.add('ignored'));(d.pr_ign||[]).forEach(i=>document.querySelector(`.r-cell[data-idx="${i}"]`)?.classList.add('ignored'));(d.pa_ign||[]).forEach(i=>document.querySelector(`.a-cell[data-idx="${i}"]`)?.classList.add('ignored'));
    // 更新按钮状态
    updateSlotButtons();
}
function gatherData(){const d={pName:document.getElementById('pName').value,pAnom:document.getElementById('pAnom').value,pReal:document.getElementById('pReal').value,pFunc:document.getElementById('pFunc').value,pTrig1:document.getElementById('pTrig1').innerHTML,pTrig2:document.getElementById('pTrig2').innerHTML,pTrig3:document.getElementById('pTrig3').innerHTML,perm1:document.getElementById('perm1').value,perm2:document.getElementById('perm2').value,perm3:document.getElementById('perm3').value,pComm:document.getElementById('pComm').value,pRep:document.getElementById('pRep').value,mvpCount:document.getElementById('mvpCount').value,watchCount:document.getElementById('watchCount').value,noteTitle:document.getElementById('noteTitle').value,noteBody:document.getElementById('noteBody').innerHTML,qs:[],attrs:{},anoms:[],reals:[],items:[],pf:[],pr:[],pa:[],pf_ign:[],pr_ign:[],pa_ign:[],anomSlots:SLOT_LIMITS.anomSlots,realSlots:SLOT_LIMITS.realSlots};for(let i=1;i<=7;i++)d.qs.push(document.getElementById(`q${i}`).innerHTML);ATTRS.forEach(a=>{const r=document.querySelector(`.attr-input[data-attr="${a}"]`).parentElement,m=[];r.querySelectorAll('.dot.marked').forEach(dt=>m.push(parseInt(dt.dataset.i)));d.attrs[a]={v:r.querySelector('input').value,m:m};});document.querySelectorAll('#list-anom .card').forEach(c=>{d.anoms.push({name:c.querySelector('.f-name').value,trig:c.querySelector('.f-trig').value,qual:c.querySelector('.f-qual').value,succ:c.querySelector('.f-succ').innerHTML,fail:c.querySelector('.f-fail').innerHTML,chk:c.querySelector('.f-chk').checked,tdesc:c.querySelector('.f-tdesc').value,t1:c.querySelector('.f-t1').value,t1v:c.querySelector('.f-t1-val').value,t2:c.querySelector('.f-t2').value,t2v:c.querySelector('.f-t2-val').value,p1:Array.from(c.querySelectorAll('.d1 .sq-dot')).map(e=>e.classList.contains('active')),p2:Array.from(c.querySelectorAll('.d2 .sq-dot')).map(e=>e.classList.contains('active'))});});document.querySelectorAll('#list-real .card').forEach(c=>{let l=0;c.querySelectorAll('.r-dots .dot').forEach((e,i)=>{if(e.classList.contains('active'))l=i+1});d.reals.push({name:c.querySelector('.f-name').value,actor:c.querySelector('.f-actor').value,desc:c.querySelector('.f-desc').innerHTML,act:c.querySelector('.f-act').checked,conn:c.querySelector('.f-conn').innerHTML,lvl:l});});document.querySelectorAll('#list-item .card').forEach(c=>{d.items.push({item:c.querySelector('.f-item').value,pd:c.querySelector('.f-pd').value,eff:c.querySelector('.f-eff').innerHTML});});document.querySelectorAll('.f-cell.active').forEach(e=>d.pf.push(parseInt(e.dataset.idx)));document.querySelectorAll('.r-cell.active').forEach(e=>d.pr.push(parseInt(e.dataset.idx)));document.querySelectorAll('.a-cell.active').forEach(e=>d.pa.push(parseInt(e.dataset.idx)));document.querySelectorAll('.f-cell.ignored').forEach(e=>d.pf_ign.push(parseInt(e.dataset.idx)));document.querySelectorAll('.r-cell.ignored').forEach(e=>d.pr_ign.push(parseInt(e.dataset.idx)));document.querySelectorAll('.a-cell.ignored').forEach(e=>d.pa_ign.push(parseInt(e.dataset.idx)));return d;}
function showToast(msg, type='success') {
    const m = document.getElementById('status-msg');
    m.innerHTML = type === 'error' ? `<i class="fas fa-exclamation-circle"></i> ${msg}` : `<i class="fas fa-save"></i> ${msg}`;
    m.className = type === 'error' ? 'error' : 'success';
    m.style.display = 'block';
    setTimeout(() => m.style.display = 'none', 2500);
}
async function saveData(silent=false){if(isReadOnly)return;const d=gatherData();const res=await fetch(`/api/character/${charId}`,{method:'PUT',headers:getAuthHeaders(),body:JSON.stringify(d)});if(res.ok){if(!silent){showToast('DATA_SAVED', 'success');}}else if(res.status===401||res.status===403){window.location.href='login.html';}else{showToast('保存失败', 'error');}}
function exportOffline(){const d=gatherData();let h=document.documentElement.outerHTML;h=h.replace(/<script id="__SAVED_DATA__" type="application\/json">.*?<\/script>/s,`<script id="__SAVED_DATA__" type="application/json">${JSON.stringify(d)}<\/script>`);const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([h],{type:'text/html'}));a.download=`${d.pName||'角色'}_离线备份.html`;a.click();}

// ==========================================
// 新增：JSON 导出与导入功能
// ==========================================

/**
 * 导出当前数据为 JSON 文件
 */
function exportJson() {
    // 1. 获取当前页面所有数据
    const data = gatherData();
    
    // 2. 生成文件名 (例如: 姓名_data.json)
    const name = data.pName ? data.pName.replace(/\s+/g, '_') : 'character';
    const fileName = `${name}_data.json`;

    // 3. 创建 Blob 对象
    const jsonStr = JSON.stringify(data, null, 2); // 格式化缩进
    const blob = new Blob([jsonStr], { type: 'application/json' });

    // 4. 创建下载链接并触发点击
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    
    // 5. 清理
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('JSON 数据已导出');
}

/**
 * 触发文件选择框
 */
function triggerImport() {
    if (document.body.classList.contains('readonly-mode')) {
        alert('只读模式下无法导入数据');
        return;
    }
    if(!confirm('警告：导入 JSON 将完全覆盖当前页面上的所有内容！\n确定要继续吗？')) {
        return;
    }
    document.getElementById('jsonInput').click();
}

/**
 * 处理文件读取与数据填充
 */
function handleImportJson(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            // 1. 解析 JSON
            const data = JSON.parse(e.target.result);
            
            // 2. 简单验证数据有效性 (检查是否有关键字段)
            if (typeof data !== 'object' || (!data.pName && !data.anoms)) {
                throw new Error("无效的角色数据格式");
            }

            // 3. 填充数据 (使用现有的 populateData 函数)
            populateData(data);
            
            showToast('数据导入成功', 'success');
            
            // 可选：导入后自动保存到服务器
            // saveData(true); 

        } catch (err) {
            console.error(err);
            alert('导入失败：文件格式错误或数据损坏');
        }
    };

    reader.readAsText(file);
    
    // 清空 input，确保同一个文件可以被再次选择触发 onchange
    input.value = '';
}
</script>
<div class="nav-arrow arrow-left" onclick="moveTab(-1)"><i class="fas fa-caret-left"></i></div>
<div class="nav-arrow arrow-right" onclick="moveTab(1)"><i class="fas fa-caret-right"></i></div>
</body>
</html>
