<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>职员档案 // TRIANGLE AGENCY</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
    :root {
        --deep-bg: #1a252f;
        --bg-pattern: radial-gradient(#2c3e50 1px, transparent 1px);
        --panel-bg: #ffffff;
        --input-bg: #f8f9fa;
        --text-main: #2c3e50;
        --text-dim: #95a5a6;
        --border-color: #e0e0e0;
        --signal-red: #c0392b;
        --accent: #2980b9;
        --reality: #f39c12;
        --functional: #c0392b;
        --nav-height: 60px;
        --safe-bottom: env(safe-area-inset-bottom);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { font-family: "Roboto Mono", "Noto Sans SC", "Microsoft YaHei", sans-serif; background-color: var(--deep-bg); background-image: var(--bg-pattern); background-size: 20px 20px; color: var(--text-main); overflow: hidden; height: 100dvh; width: 100vw; position: relative; }
    .container { max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; height: 100%; padding: 15px; padding-bottom: 0; }
    
    /* 顶部导航 */
    .top-nav { display: flex; align-items: center; justify-content: space-between; margin: 0 0 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; color: white; flex-shrink: 0; }
    .header-right { flex: 1; display: flex; align-items: center; justify-content: flex-end; gap: 15px; }
    
    /* 顶部邮箱按钮样式 */
    .top-mail-btn {
        position: relative;
        font-size: 20px;
        color: rgba(255,255,255,0.3); /* 默认灰色 */
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 5px;
    }
    .top-mail-btn:hover { color: white; }
    
    /* 有未读消息时的样式 */
    .top-mail-btn.has-unread { 
        color: var(--signal-red); 
        animation: mail-pulse 2s infinite; 
    }
    @keyframes mail-pulse {
        0% { text-shadow: 0 0 0 rgba(192, 57, 43, 0); transform: scale(1); }
        50% { text-shadow: 0 0 10px rgba(192, 57, 43, 0.6); transform: scale(1.1); }
        100% { text-shadow: 0 0 0 rgba(192, 57, 43, 0); transform: scale(1); }
    }

    /* 数字标记样式 */
    .mail-badge {
        position: absolute;
        bottom: -2px;
        left: -4px;
        background: var(--signal-red);
        color: white;
        font-size: 9px;
        font-weight: 900;
        padding: 1px 4px;
        border-radius: 4px;
        line-height: 1;
        display: none; 
        border: 1px solid var(--deep-bg);
        box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .brand-logo-sm { display: flex; flex-direction: column; line-height: 0.9; font-weight: 800; font-style: italic; }
    .brand-logo-sm span:first-child { font-size: 14px; color: white; }
    .brand-logo-sm span:last-child { font-size: 8px; color: var(--signal-red); letter-spacing: 2px; }
    .btn-back { background: none; border: none; font-size: 14px; color: rgba(255,255,255,0.7); cursor: pointer; display: flex; align-items: center; gap: 5px; }
    .btn-back:hover { color: white; }
    
    h1 { margin: 0; font-size: 16px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; text-align: right; display:flex; flex-direction:column; align-items:flex-end; color: white; }
    h1 span.sub { font-size: 10px; color: rgba(255,255,255,0.5); font-weight: normal; }
    
    .offline-tag, .readonly-tag { background: #34495e; color: #bdc3c7; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px; display: none; }
    .offline-mode .offline-tag { display: inline-block; }
    .offline-mode .btn-back, .offline-mode .btn-save-server { display: none; }
    body.readonly-mode .readonly-tag { display: inline-block; background: var(--signal-red); color: white; }
    body.readonly-mode .btn-save, body.readonly-mode .btn-add, body.readonly-mode .btn-del, body.readonly-mode .save-area { display: none !important; }
    body.readonly-mode input, body.readonly-mode textarea, body.readonly-mode .rich-editor, body.readonly-mode select { pointer-events: none; background: transparent; border-color: transparent; color: #555; -webkit-appearance: none; appearance: none; }
    
    /* Swiper 调整：宽度改为400%因为只有4页了 */
    .swiper-container { flex-grow: 1; width: 100%; overflow: hidden; position: relative; }
    .swiper-wrapper { display: flex; width: 400%; height: 100%; transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
    .tab-view { width: 25%; height: 100%; overflow-y: auto; display: block !important; padding-right: 5px; padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 60px); -ms-overflow-style: none; scrollbar-width: none; }
    .tab-view::-webkit-scrollbar { display: none; }
    
    .panel, .card { background: var(--panel-bg); border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 16px; border: 1px solid var(--border-color); position: relative; overflow: hidden; z-index: 1; }
    .panel::before, .card::before, .panel::after, .card::after { content: ''; position: absolute; z-index: -1; pointer-events: none; opacity: 0.05; transform-origin: center; }
    .panel::before, .card::before { background: #2c3e50; width: 200px; height: 200px; top: calc(-50px + 100px * var(--r1, 0.5)); left: calc(-50px + 100px * var(--r2, 0.5)); clip-path: polygon(50% 0%, 0% 100%, 100% 100%); animation: float-shard calc(25s + 10s * var(--r3, 0.5)) infinite linear; }
    .panel::after, .card::after { background: var(--signal-red); width: 150px; height: 150px; opacity: 0.03; bottom: calc(-30px + 50px * var(--r2, 0.5)); right: calc(-30px + 50px * var(--r1, 0.5)); clip-path: polygon(0 0, 100% 50%, 0 100%); animation: float-shard calc(30s + 15s * var(--r1, 0.5)) infinite reverse linear; }
    input, textarea, .rich-editor, h2, label, button, .attr-row, .track-sec, .perm-group, .perm-note, .row-2, select { position: relative; z-index: 2; }
    .card { padding-top: 35px; border-left: 4px solid #ccc; } 
    @keyframes float-shard { 0% { transform: rotate(0deg) translate(0, 0); } 50% { transform: rotate(180deg) translate(20px, 20px); } 100% { transform: rotate(360deg) translate(0, 0); } }
    h2 { font-size: 14px; color: var(--text-main); border-bottom: 2px solid var(--signal-red); padding-bottom: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; font-weight: 800; letter-spacing: 1px; }
    h2 i { color: var(--signal-red); }
    label { display: block; font-weight: 700; font-size: 11px; margin: 12px 0 6px; color: var(--text-dim); letter-spacing: 0.5px; text-transform: uppercase; }
    input[type="text"], textarea, .rich-editor, select { width: 100%; padding: 10px 12px; border: 1px solid #dcdcdc; background: var(--input-bg); border-radius: 4px; font-size: 14px; color: var(--text-main); transition: all 0.2s; font-family: inherit; }
    select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; padding-right: 30px; }
    input:focus, textarea:focus, .rich-editor:focus, select:focus { outline: none; border-color: var(--signal-red); background: #fff; box-shadow: 0 0 0 2px rgba(192, 57, 43, 0.1); }
    .rich-editor { min-height: 60px; white-space: pre-wrap; }
    .rich-editor:empty:before { content: attr(placeholder); color: #bdc3c7; font-style: italic; }
    .small-input { width: 45px !important; padding: 5px !important; text-align: center; flex-shrink: 0; margin: 0 5px; }
    .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .perm-group input { margin-bottom: 8px; }
    .perm-note { background: #f0f2f5; padding: 10px; border-radius: 4px; font-size: 12px; color: #666; margin-top: 10px; border-left: 3px solid #ccc; }
    
    /* 混合输入框（下拉/文本切换）样式修正 */
    .hybrid-input-wrapper { position: relative; display: flex; align-items: center; }
    .hybrid-input-wrapper input[type="text"] { display: none; }
    .hybrid-input-wrapper .rich-editor { display: none; width: 100%; padding-right: 30px; } /* 新增：支持富文本 */
    
    .hybrid-input-wrapper.show-input input[type="text"] { display: block; }
    .hybrid-input-wrapper.show-input .rich-editor { display: block; } /* 新增：显示富文本 */
    .hybrid-input-wrapper.show-input select { display: none; }
    
    .btn-reset-list { display: none; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #bdc3c7; border: none; border-radius: 50%; width: 20px; height: 20px; color: white; font-size: 10px; cursor: pointer; z-index: 5; align-items: center; justify-content: center; }
    .hybrid-input-wrapper.show-input .btn-reset-list { display: flex; }
    .hybrid-input-wrapper.has-editor .btn-reset-list { top: 10px; transform: none; } /* 新增：针对富文本框，按钮置顶 */
    .btn-reset-list:hover { background: var(--signal-red); }
    
    @media(min-width: 768px) { .char-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; margin-bottom: 20px; } .char-layout .panel { height: 100%; margin-bottom: 0; } }
    .attr-row { display: flex; align-items: center; margin-bottom: 12px; border-bottom: 1px dashed var(--border-color); padding-bottom: 8px; gap: 8px; }
    .attr-label { flex: 0 0 50px; background: #333; color: white; text-align: center; border-radius: 3px; font-size: 10px; padding: 4px 0; font-weight: bold; }
    .attr-input { flex: 0 0 36px; text-align: center; font-weight: bold; padding: 4px; background: white; border: 1px solid #ccc; color: var(--signal-red); }
    .attr-dots-container { flex: 1; display: flex; justify-content: center; }
    .attr-dots { display: flex; gap: 4px; }
    .dot { width: 16px; height: 16px; border: 1px solid #bdc3c7; border-radius: 50%; cursor: pointer; flex-shrink: 0; transition: all 0.2s; background: #fff; }
    .dot.active { background: #333; border-color: #333; }
    .dot.marked { background: var(--signal-red); border-color: var(--signal-red); }
    .track-header { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; align-items: end; }
    .track-stat { display: flex; flex-direction: column; align-items: center; width: 100%; }
    .track-stat label { margin: 0 0 6px; font-size: 10px; text-align: center; color: var(--text-dim); white-space: nowrap; }
    .track-stat input { width: 100%; min-width: 0; padding: 8px 0 !important; text-align: center; font-weight: bold; font-size: 16px; background: white; border-radius: 4px; }
    .clickable-stat { cursor: pointer; transition: all 0.2s; }
    .clickable-stat:hover { transform: scale(1.05); }
    .clickable-stat:hover label { color: var(--accent); }
    .clickable-stat input { cursor: pointer; }
    @media (min-width: 768px) { .track-header { display: flex; justify-content: center; gap: 25px; } .track-stat { width: auto; } .track-stat input { width: 80px !important; } }
    .p-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; max-width: 340px; margin: 0 auto 5px; }
    .p-cell { aspect-ratio: 1; border: 1px solid #bdc3c7; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 9px; color: #999; cursor: pointer; background: white; }
    .c-func { color: var(--functional); } .f-cell.active { background: var(--functional); border-color: var(--functional); color: white; }
    .c-real { color: var(--reality); } .r-cell.active { background: var(--reality); border-color: var(--reality); color: white; }
    .c-anom { color: var(--accent); } .a-cell.active { background: var(--accent); border-color: var(--accent); color: white; }
    .p-cell.ignored { background: #95a5a6; border-color: #7f8c8d; color: white; }
    .p-cell.ignored span { opacity: 0.7; }
    .track-rule { font-size: 11px; color: #7f8c8d; padding: 6px 0; border-top: 1px dotted var(--border-color); margin-top: 8px; }
    .mod-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: white; }
    .mod-header h2 { border: none; margin: 0; padding: 0; color: white; border-bottom: none; }
    .btn-add { background: white; border: none; padding: 5px 15px; border-radius: 20px; color: var(--signal-red); font-size: 11px; cursor: pointer; transition: 0.2s; font-weight: bold; text-transform: uppercase; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .btn-add:hover { background: #f0f0f0; }
    .btn-del { position: absolute; top: 10px; right: 10px; background: #fdf0ef; color: #e74c3c; width: 24px; height: 24px; border-radius: 50%; border: none; cursor: pointer; font-size: 14px; line-height: 1; display:flex; align-items:center; justify-content:center; z-index: 5; }
    .btn-del:hover { background: var(--signal-red); color: white; }
    .bd-anom { border-left-color: var(--accent); }
    .bd-real { border-left-color: var(--reality); }
    .bd-func { border-left-color: var(--functional); }
    .sq-dots { display: flex; gap: 4px; }
    .sq-dot { width: 14px; height: 14px; border: 1px solid #bdc3c7; border-radius: 2px; cursor: pointer; background: white; }
    .sq-dot.active { background: var(--accent); border-color: var(--accent); }
    .rel-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin: 8px 0; flex-wrap: nowrap; }
    .r-dots { display: flex; gap: 4px; flex: 1; overflow-x: auto; scrollbar-width: none; align-items: center; }
    .chk-btn { flex-shrink: 0; cursor: pointer; font-size: 11px; display: flex; align-items: center; user-select: none; }
    .chk-btn input { display: none; }
    .chk-btn span { padding: 4px 10px; background: #eee; color: #777; border-radius: 4px; transition: all 0.2s; font-weight: bold; border: 1px solid transparent; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
    .chk-btn input:checked + span { background: var(--signal-red); color: white; border-color: var(--signal-red); }
    .chk-btn input:checked + span::before { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; }
    .chk-btn span::after { content: "未激活"; }
    .chk-btn input:checked + span::after { content: "已激活"; }
    .chk-btn.chk-trained span::after { content: "未训练"; }
    .chk-btn.chk-trained input:checked + span::after { content: "已训练"; }
    .save-area { text-align: center; margin: 30px 0; display:flex; gap:15px; justify-content:center; position: relative; z-index: 2; flex-wrap: wrap; }
    .btn-save { background: var(--signal-red); color: white; border: none; padding: 12px 30px; border-radius: 4px; font-size: 13px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(192, 57, 43, 0.4); display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 1px; }
    .btn-export { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; }
    .btn-export:hover { border-color: white; background: rgba(255,255,255,0.1); }
    .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: calc(var(--nav-height) + var(--safe-bottom)); background: white; border-top: 1px solid #ddd; display: flex; z-index: 1000; padding-bottom: var(--safe-bottom); }
    .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #95a5a6; font-size: 10px; cursor: pointer; transition: 0.2s; }
    .nav-btn i { font-size: 18px; margin-bottom: 4px; }
    .nav-btn.active { color: var(--signal-red); }
    .nav-btn.active i { transform: translateY(-2px); }
    .nav-btn.n-char.active { color: #16a085; }
    .nav-btn.n-anom.active { color: var(--accent); }
    .nav-btn.n-real.active { color: var(--reality); }
    .nav-btn.n-item.active { color: var(--signal-red); }
    /* .nav-btn.n-mail removed from css */

/* === 邮箱全屏模态框 (重工科技感特效) === */
    .full-page-modal {
        display: flex;
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        /* 背景色加深，增加透明度，模拟厚重的玻璃或金属板 */
        background: rgba(15, 23, 42, 0.98);
        z-index: 5000;
        flex-direction: column;

        /* 关键：使用 inset 裁剪，模拟从右上角(0,0)展开的矩形闸门 */
        /* 初始状态：上0，右0，下100%(切掉底部)，左100%(切掉左侧) -> 实际上是一个右上角的点 */
        clip-path: inset(0 0 100% 100%);
        
        /* 沉重的物理曲线：启动稍有阻力，中间极快释放，最后沉重刹车 */
        transition: clip-path 0.55s cubic-bezier(0.7, 0, 0.2, 1);
        
        /* 硬件加速提示 */
        will-change: clip-path;
        
        /* 内部阴影，增加深邃感 */
        box-shadow: inset 0 0 150px rgba(0,0,0,0.8);
    }

    .full-page-modal.active {
        /* 展开状态：完全无裁剪 */
        clip-path: inset(0 0 0 0);
    }

    /* 增加一个扫描线背景层，增强科技感 */
    .full-page-modal::before {
        content: '';
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: repeating-linear-gradient(
            0deg,
            transparent,
            transparent 2px,
            rgba(0, 0, 0, 0.3) 2px,
            rgba(0, 0, 0, 0.3) 4px
        );
        pointer-events: none;
        z-index: -1;
    }

    /* 内部内容动画：带有惯性的上浮显示 */
    .mail-modal-header, .mail-modal-body {
        opacity: 0;
        /* 初始位置稍微偏下，并带有轻微的缩放，模拟全息投影生成的感觉 */
        transform: translateY(30px) scale(0.98);
        /* 关闭时快速消失，不拖泥带水 */
        transition: opacity 0.2s ease, transform 0.2s ease;
    }

    /* 激活时的内部内容 */
    .full-page-modal.active .mail-modal-header, 
    .full-page-modal.active .mail-modal-body {
        opacity: 1;
        transform: translateY(0) scale(1);
        /* 延迟显示：必须等"闸门"完全落下后，数据才显示，节奏感更强 */
        transition: 
            opacity 0.4s ease 0.3s, 
            transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s; /* 带一点点弹性回弹 */
    }

    .mail-modal-header {
        background: #1e293b;
        padding: 15px 20px;
        display: flex; justify-content: space-between; align-items: center;
        /* 顶部加粗红线，强调警告/机密感 */
        border-bottom: 3px solid var(--signal-red);
        color: white;
        flex-shrink: 0;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .mail-modal-header h2 { 
        margin: 0; border: none; padding: 0; color: white; 
        font-family: "Roboto Mono", monospace; 
        letter-spacing: 1px;
    }
    .btn-close-mail {
        background: none; border: none; color: rgba(255,255,255,0.5);
        font-size: 24px; cursor: pointer; transition: 0.3s;
    }
    .btn-close-mail:hover { 
        color: var(--signal-red); 
        text-shadow: 0 0 10px var(--signal-red);
        transform: rotate(90deg) scale(1.1); 
    }

    .mail-modal-body {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    .mail-container-inner {
        max-width: 900px;
        width: 100%;
        margin: 0 auto;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    /* 邮箱视图样式 */
    .mail-tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #f8f9fa; padding: 5px; border-radius: 6px; }
    .mail-tab { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; background: transparent; color: #7f8c8d; transition: all 0.2s; }
    .mail-tab.active { background: white; color: #8e44ad; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .mail-tab i { margin-right: 5px; }
    .mail-content { flex: 1; min-height: 300px; }
    .mail-list { display: flex; flex-direction: column; gap: 10px; }
    .mail-item { background: white; border-radius: 6px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s; border-left: 4px solid #8e44ad; }
    .mail-item:hover { transform: translateX(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
    .mail-item.unread { background: #f8f4fc; }
    .mail-item.hw-auth { border-left-color: #c0392b; }
    .mail-item.sent-mail-item { border-left-color: #3498db; display: flex; gap: 12px; align-items: flex-start; }
    .mail-icon { flex-shrink: 0; width: 24px; text-align: center; }
    .mail-icon.sent-icon { color: #3498db; font-size: 18px; margin-top: 3px; }
    .mail-info { flex: 1; min-width: 0; }
    .mail-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .mail-recipient { font-size: 11px; color: #3498db; font-weight: bold; }
    .mail-sender { font-size: 11px; color: #7f8c8d; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
    .mail-sender .os-badge { background: #c0392b; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; }
    .mail-subject { font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
    .mail-preview { font-size: 12px; color: #95a5a6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .mail-time { font-size: 10px; color: #bdc3c7; margin-top: 8px; }
    .mail-empty { text-align: center; padding: 40px; color: #95a5a6; }
    .mail-empty i { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
    /* 高墙文件夹样式 */
    .hw-folder { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
    .hw-file { background: linear-gradient(135deg, #2c3e50, #34495e); border-radius: 8px; padding: 20px 15px; text-align: center; cursor: pointer; transition: all 0.3s; color: white; }
    .hw-file:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .hw-file i { font-size: 32px; margin-bottom: 10px; color: #c0392b; }
    .hw-file .hw-name { font-size: 12px; font-weight: bold; word-break: break-all; }
    /* === 高墙特效 (V1 优化版) === */
    #hw-overlay {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: #0f172a;
        z-index: 9999;
        pointer-events: none;
        clip-path: inset(50% 0 50% 0);
        transition: clip-path 0.8s cubic-bezier(0.8, 0, 0.2, 1);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        overflow: hidden;
    }
    #hw-overlay.active { pointer-events: all; clip-path: inset(0 0 0 0); }
    #hw-overlay.glitch-mode { background: #000; animation: bg-flash 0.1s infinite; }

    .hw-normal-content { text-align: center; color: var(--signal-red); transition: opacity 0.1s; z-index: 10; }
    #hw-overlay.glitch-mode .hw-normal-content { filter: invert(1) blur(1px); transform: scale(1.1); }
    .hw-scanlines { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2)); background-size: 100% 4px; animation: scanline 0.2s linear infinite; pointer-events: none; display: none; z-index: 21; }
    @keyframes bg-flash { 0%, 100% { background-color: #100000; } 50% { background-color: #000000; } }
    @keyframes scanline { to { transform: translateY(4px); } }

    .hw-eye-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000;
        z-index: 30;
        display: flex; justify-content: center; align-items: center;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .hw-eye-svg {
        width: 150px; opacity: 0; transform-origin: center center;
        transform: scaleY(0.01); filter: drop-shadow(0 0 20px #00f3ff);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative; z-index: 31;
    }
    .hw-eye-svg.eye-open { opacity: 1; transform: scaleY(1); }

    .hw-eye-svg.scared {
        animation: eye-tremble 0.1s infinite;
    }
    @keyframes eye-tremble {
        0% { transform: scale(1) translate(0, 0); }
        50% { transform: scale(0.98) translate(1px, -1px); }
        100% { transform: scale(1) translate(0, 0); }
    }

    .hw-tentacles-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 35;
        pointer-events: none;
        overflow: hidden;
    }

    .tendril {
        position: absolute;
        top: 50%; left: 50%;
        width: 8vw;
        height: 120vmax;
        background: #000;
        transform-origin: top center;
        opacity: 0;
        border-radius: 0 0 50% 50%;
        filter: blur(12px) contrast(1.5);
    }

    .tendril.creeping {
        opacity: 1;
        animation: creep-in 2.2s cubic-bezier(0.6, 0, 0.1, 1) forwards;
    }

    @keyframes creep-in {
        from { transform: translate(-50%, -110%) rotate(var(--r)); }
        to { transform: translate(-50%, 0%) rotate(var(--r)); }
    }

    #hw-blackout {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 100;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    #hw-blackout.active { opacity: 1; }

    .hw-loader-icon { font-size: 48px; margin-bottom: 20px; }
    .hw-loader-text { font-size: 16px; letter-spacing: 2px; font-weight: 900; display: flex; align-items: center; justify-content: center; }
    .hw-dots::after { content: ''; width: 1.5em; text-align: left; display: inline-block; animation: dot-steps 1.5s infinite steps(4, end); }
    @keyframes dot-steps { 0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80%, 100% { content: '...'; } }
    #status-msg { position: fixed; top: 20px; left:50%; transform:translateX(-50%); background: var(--signal-red); color: white; padding: 8px 20px; border-radius: 4px; font-size: 12px; display:none; z-index:2000; box-shadow: 0 5px 20px rgba(0,0,0,0.5); font-weight: bold; letter-spacing: 1px; }
	#status-msg.success { background: #27ae60; }
	#status-msg.error { background: var(--signal-red); }

    /* === 蓝色眼睛邮件阅读器 === */
    #mail-reader-overlay {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: #0a0f1a;
        z-index: 8888;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.4s ease;
        display: flex; flex-direction: column;
        overflow: hidden;
    }
    #mail-reader-overlay.active { pointer-events: all; opacity: 1; }

    .mail-reader-bg {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: radial-gradient(ellipse at center, rgba(0, 100, 200, 0.15) 0%, transparent 70%);
        z-index: 1;
    }

    .mail-eye-container {
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 180px; height: 100px;
        z-index: 2;
        opacity: 0;
        transition: all 0.6s ease;
    }
    #mail-reader-overlay.active .mail-eye-container {
        opacity: 0.15;
        animation: mail-eye-pulse 3s ease-in-out infinite;
    }
    @keyframes mail-eye-pulse {
        0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.15; }
        50% { transform: translate(-50%, -50%) scale(1.05); opacity: 0.25; }
    }

    .mail-eye-svg {
        width: 100%; height: 100%;
        filter: drop-shadow(0 0 30px rgba(0, 120, 255, 0.6));
    }
    .mail-eye-svg path, .mail-eye-svg circle { fill: #1e90ff; }
    .mail-eye-svg .eye-pupil { fill: #0a0f1a; }

    .mail-scanlines {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: repeating-linear-gradient(
            0deg,
            transparent,
            transparent 2px,
            rgba(0, 100, 200, 0.03) 2px,
            rgba(0, 100, 200, 0.03) 4px
        );
        pointer-events: none;
        z-index: 3;
    }

    .mail-reader-panel {
        position: relative;
        z-index: 10;
        width: 90%;
        max-width: 600px;
        margin: auto;
        background: rgba(15, 25, 45, 0.95);
        border: 1px solid rgba(30, 144, 255, 0.3);
        border-radius: 12px;
        box-shadow: 0 0 40px rgba(0, 100, 200, 0.2), inset 0 0 20px rgba(0, 50, 100, 0.1);
        transform: scale(0.9) translateY(20px);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        max-height: 80vh;
        display: flex;
        flex-direction: column;
    }
    #mail-reader-overlay.active .mail-reader-panel {
        transform: scale(1) translateY(0);
        opacity: 1;
        transition-delay: 0.2s;
    }

    .mail-reader-header {
        padding: 20px;
        border-bottom: 1px solid rgba(30, 144, 255, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-shrink: 0;
    }
    .mail-reader-title { flex: 1; }
    .mail-reader-title h3 {
        margin: 0 0 5px 0;
        color: #e0f0ff;
        font-size: 18px;
        font-weight: 700;
    }
    .mail-reader-meta {
        font-size: 12px;
        color: #6090b0;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }
    .mail-reader-meta span { display: flex; align-items: center; gap: 5px; }
    .mail-reader-meta .os-badge {
        background: linear-gradient(135deg, #c0392b, #e74c3c);
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: bold;
    }
    .mail-reader-close {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #8090a0;
        width: 36px; height: 36px;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex; align-items: center; justify-content: center;
    }
    .mail-reader-close:hover { background: rgba(255, 100, 100, 0.2); border-color: #e74c3c; color: #e74c3c; }

    .mail-reader-body {
        padding: 20px;
        flex: 1;
        overflow-y: auto;
        color: #c0d0e0;
        font-size: 14px;
        line-height: 1.8;
        white-space: pre-wrap;
    }
    .mail-reader-body::-webkit-scrollbar { width: 6px; }
    .mail-reader-body::-webkit-scrollbar-track { background: rgba(0, 50, 100, 0.2); }
    .mail-reader-body::-webkit-scrollbar-thumb { background: rgba(30, 144, 255, 0.4); border-radius: 3px; }

    .mail-reader-actions {
        padding: 15px 20px;
        border-top: 1px solid rgba(30, 144, 255, 0.2);
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        flex-shrink: 0;
    }
    .mail-reader-btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
        display: flex; align-items: center; gap: 8px;
    }
    .mail-reader-btn.primary {
        background: linear-gradient(135deg, #1e90ff, #0066cc);
        border: none;
        color: white;
        box-shadow: 0 4px 15px rgba(30, 144, 255, 0.4);
    }
    .mail-reader-btn.primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(30, 144, 255, 0.5); }
    .mail-reader-btn.secondary {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #8090a0;
    }
    .mail-reader-btn.secondary:hover { border-color: #1e90ff; color: #1e90ff; }
    .mail-reader-btn.danger {
        background: linear-gradient(135deg, #c0392b, #e74c3c);
        border: none;
        color: white;
    }
    .mail-reader-btn.danger:hover { transform: translateY(-2px); }
    .mail-reader-btn.success {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        border: none;
        color: white;
        box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
    }
    .mail-reader-btn.success:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(39, 174, 96, 0.5); }
    .mail-reader-btn.warning {
        background: linear-gradient(135deg, #e67e22, #f39c12);
        border: none;
        color: white;
        box-shadow: 0 4px 15px rgba(230, 126, 34, 0.4);
    }
    .mail-reader-btn.warning:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(230, 126, 34, 0.5); }

    /* 眼睛眨眼动画 */
    .mail-eye-blink {
        animation: mail-eye-blink-anim 0.3s ease forwards;
    }
    @keyframes mail-eye-blink-anim {
        0% { transform: translate(-50%, -50%) scaleY(1); }
        50% { transform: translate(-50%, -50%) scaleY(0.1); }
        100% { transform: translate(-50%, -50%) scaleY(1); }
    }

    /* === 发件箱三选项样式 === */
    .outbox-options {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 20px;
    }
    @media (max-width: 600px) {
        .outbox-options { grid-template-columns: 1fr; }
    }
    .outbox-option {
        background: linear-gradient(135deg, #f8f9fa, #fff);
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    .outbox-option:hover {
        border-color: #8e44ad;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(142, 68, 173, 0.15);
    }
    .outbox-option.active {
        border-color: #8e44ad;
        background: linear-gradient(135deg, #f3e5f5, #fff);
        box-shadow: 0 4px 15px rgba(142, 68, 173, 0.2);
    }
    .outbox-option i {
        font-size: 32px;
        margin-bottom: 10px;
        display: block;
    }
    .outbox-option.opt-containment i { color: #27ae60; }
    .outbox-option.opt-report i { color: #e67e22; }
    .outbox-option.opt-mail i { color: #8e44ad; }
    .outbox-option h4 { margin: 0 0 5px 0; font-size: 14px; color: #2c3e50; }
    .outbox-option p { margin: 0; font-size: 11px; color: #7f8c8d; }

    .outbox-form {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        display: none;
    }
    .outbox-form.active { display: block; }
    .outbox-form h4 {
        margin: 0 0 15px 0;
        color: #2c3e50;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .outbox-form label {
        display: block;
        font-size: 12px;
        color: #7f8c8d;
        margin: 12px 0 6px;
        font-weight: bold;
    }
    .outbox-form input, .outbox-form textarea, .outbox-form select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
    }
    .outbox-form input:focus, .outbox-form textarea:focus, .outbox-form select:focus {
        outline: none;
        border-color: #8e44ad;
        box-shadow: 0 0 0 2px rgba(142, 68, 173, 0.1);
    }
    .outbox-form textarea { min-height: 100px; resize: vertical; }
    .outbox-form .btn-send {
        margin-top: 15px;
        background: linear-gradient(135deg, #8e44ad, #9b59b6);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
    }
    .outbox-form .btn-send:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(142, 68, 173, 0.4);
    }
    .outbox-form .btn-send:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    /* 任务报告表单样式 */
    .report-section {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .report-section h5 {
        margin: 0 0 10px 0;
        font-size: 13px;
        color: #c0392b;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
    }
    .report-status-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    .report-status-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: #fafafa;
        border-radius: 6px;
        cursor: pointer;
    }
    .report-status-item:hover { background: #f0f0f0; }
    .report-status-item input[type="radio"] {
        width: 18px; height: 18px;
        accent-color: #c0392b;
    }
    .report-status-item .status-icon { font-size: 20px; }
    .report-status-item .status-info h6 { margin: 0; font-size: 13px; }
    .report-status-item .status-info small { color: #7f8c8d; font-size: 10px; }
    .report-row {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
    }
    .report-row label {
        width: 60px;
        flex-shrink: 0;
        background: #eee;
        padding: 8px;
        border-radius: 4px;
        font-size: 12px;
        text-align: center;
        margin: 0;
    }
    .report-row input {
        flex: 1;
        margin: 0;
    }
    .report-table {
        width: 100%;
        border-collapse: collapse;
    }
    .report-table th {
        background: #f5f5f5;
        padding: 8px;
        font-size: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    .report-table td {
        padding: 4px;
    }
    .report-table input {
        padding: 6px 8px;
        font-size: 13px;
    }
    .report-table th:last-child {
        width: 40px;
    }
    .btn-add-row {
        float: right;
        background: #27ae60;
        color: white;
        border: none;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 11px;
        cursor: pointer;
        transition: background 0.2s;
    }
    .btn-add-row:hover {
        background: #219a52;
    }
    .btn-remove-row {
        background: #e74c3c;
        color: white;
        border: none;
        width: 24px;
        height: 24px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        transition: background 0.2s;
    }
    .btn-remove-row:hover {
        background: #c0392b;
    }

	.nav-arrow { position: fixed; top: 50%; transform: translateY(-50%); font-size: 60px; color: var(--signal-red); cursor: pointer; z-index: 900; padding: 20px; display: none; transition: all 0.2s ease; opacity: 0.8; user-select: none; }
	.nav-arrow:hover { transform: translateY(-50%) scale(1.1); opacity: 1; text-shadow: 0 0 10px rgba(192, 57, 43, 0.4); }
	.arrow-left { left: calc(50% - 450px - 80px); }
	.arrow-right { right: auto; left: calc(50% + 450px + 20px); }
	.nav-arrow.disabled { color: #555; cursor: default; opacity: 0.3; pointer-events: none; }
	@media (min-width: 1150px) { .nav-arrow { display: block; } }
	@media (max-width: 1149px) { .nav-arrow { display: none !important; } }
	/* =========================================
           邮箱系统 - 红色主题统一补丁
           ========================================= */
        
        /* 1. 邮箱标签页 (Tabs) */
        .mail-tab.active {
            color: var(--signal-red) !important; /* 选中文字变红 */
        }
        
        /* 2. 收件箱列表项 (Inbox Items) */
        .mail-item {
            border-left-color: var(--signal-red) !important; /* 左侧指示条变红 */
        }
        .mail-item:hover {
            background-color: #fff5f5 !important; /* 悬停背景淡红 */
        }
        .mail-item.unread {
            background-color: #fdf2f2 !important; /* 未读背景淡红 */
        }
        
        /* 3. 已发邮件列表项 (Sent Items) */
        .mail-item.sent-mail-item {
            border-left-color: var(--signal-red) !important;
        }
        .mail-icon.sent-icon {
            color: var(--signal-red) !important; /* 纸飞机图标变红 */
        }
        .mail-recipient {
            color: var(--signal-red) !important; /* 收件人名字变红 */
        }

        /* 4. 写信选项卡 (Compose Options) */
        .outbox-option:hover,
        .outbox-option.active {
            border-color: var(--signal-red) !important;
        }
        .outbox-option.active {
            background: linear-gradient(135deg, #fff5f5, #fff) !important;
            box-shadow: 0 4px 15px rgba(192, 57, 43, 0.2) !important;
        }
        
        /* 强制所有选项图标变红 */
        .outbox-option.opt-containment i,
        .outbox-option.opt-report i,
        .outbox-option.opt-mail i {
            color: var(--signal-red) !important;
        }

        /* 5. 表单样式 (Forms) */
        .outbox-form input:focus, 
        .outbox-form textarea:focus, 
        .outbox-form select:focus {
            border-color: var(--signal-red) !important;
            box-shadow: 0 0 0 2px rgba(192, 57, 43, 0.1) !important;
        }
        
        /* 表单标题图标 */
        .outbox-form h4 i {
            color: var(--signal-red) !important;
        }

        /* 发送按钮 */
        .outbox-form .btn-send {
            background: linear-gradient(135deg, var(--signal-red), #e74c3c) !important;
            box-shadow: 0 4px 15px rgba(192, 57, 43, 0.4) !important;
        }
        .outbox-form .btn-send:hover {
            background: linear-gradient(135deg, #a93226, var(--signal-red)) !important;
        }

        /* 6. 高墙文件图标 (Highwall) */
        .hw-file i {
            color: var(--signal-red) !important;
        }
        
        /* 7. 报告中的单选按钮 */
        .report-status-item input[type="radio"] {
            accent-color: var(--signal-red) !important;
        }
        .report-section h5 {
            color: var(--signal-red) !important;
        }
		/* =========================================
           桌面端邮箱弹窗适配 (Desktop Mail Modal)
           ========================================= */
        @media (min-width: 900px) {
            .full-page-modal {
                /* 取消全屏，固定大小 */
                width: 900px !important;
                height: 85vh !important;
                
                /* 绝对定位居中 */
                left: 50% !important;
                top: 50% !important;
                transform: translate(-50%, -50%) !important;
                
                /* 视觉样式优化 */
                border-radius: 12px !important;
                border: 1px solid rgba(192, 57, 43, 0.3); /* 红色微光边框 */
                
                /* 使用超大阴影来模拟半透明遮罩层，让背景变暗 */
                box-shadow: 0 30px 60px rgba(0,0,0,0.5), 0 0 0 200vw rgba(0,0,0,0.6) !important;
            }

            /* 修正头部圆角 */
            .mail-modal-header {
                border-radius: 12px 12px 0 0;
            }

            /* 修正扫描线背景的圆角 */
            .full-page-modal::before {
                border-radius: 12px;
            }
            
            /* 调整内部容器宽度，使其填满弹窗 */
            .mail-container-inner {
                max-width: 100%;
                padding: 0 10px;
            }
        }
		/* =========================================
           移动端体验优化补丁 (Mobile Layout Fix)
           ========================================= */
        @media (max-width: 768px) {
            /* 1. 修复邮箱弹窗被地址栏/底部Bar遮挡的问题 */
            .full-page-modal {
                /* 关键：使用动态高度，自动减去浏览器地址栏的高度 */
                height: 100vh; /* 兼容旧浏览器 */
                height: 100dvh; /* 新浏览器 */
                
                /* 确保底部不被 iPhone 的手势条遮挡 */
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .mail-modal-body {
                /* 增加底部滚动余量，防止最后的内容被挡住 */
                padding-bottom: 80px !important;
            }

            /* 2. 优化"写信/寄送"选项 - 改为紧凑横向布局 */
            .outbox-options {
                /* 强制单列 */
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            .outbox-option {
                /* 使用 Grid 布局实现：左边图标，右边文字 */
                display: grid !important;
                grid-template-columns: 40px 1fr !important; /* 图标宽40px，文字自适应 */
                grid-template-rows: auto auto !important;
                align-items: center !important;
                text-align: left !important;
                
                /* 缩小内边距 */
                padding: 12px 15px !important;
                min-height: auto !important;
            }

            /* 图标调整 */
            .outbox-option i {
                grid-row: 1 / 3 !important; /* 图标跨两行 */
                grid-column: 1 !important;
                margin-bottom: 0 !important;
                font-size: 24px !important; /* 缩小图标 */
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* 标题调整 */
            .outbox-option h4 {
                grid-row: 1 !important;
                grid-column: 2 !important;
                margin: 0 !important;
                font-size: 14px !important;
                line-height: 1.2;
            }

            /* 描述文字调整 */
            .outbox-option p {
                grid-row: 2 !important;
                grid-column: 2 !important;
                margin: 2px 0 0 0 !important;
                font-size: 11px !important;
                color: #999;
                /* 防止文字换行导致太高 */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
        }
		
/* =========================================
   邮箱标签页移动端图标模式补丁
   ========================================= */
@media (max-width: 768px) {
    /* 1. 隐藏所有标签页按钮内的文字 */
    .mail-tab span {
        display: none;
    }

    /* 2. 移除图标右侧的间距 */
    .mail-tab i {
        margin-right: 0;
    }
    
    /* 3. 让图标在按钮内水平居中 */
    .mail-tab {
        justify-content: center;
    }
}
</style>
</head>
<body>
<div id="status-msg"><i class="fas fa-save"></i> DATA_SAVED</div>
<div class="container">
<div class="top-nav">
    <button class="btn-back" onclick="goBack()"><i class="fas fa-chevron-left"></i> 返回</button>
    <div class="brand-logo-sm"><span>TRIANGLE</span><span>AGENCY</span></div>
    <div class="header-right">
        <!-- 顶部邮箱按钮 -->
        <div class="top-mail-btn" onclick="openMailModal()" title="邮箱">
            <i class="fas fa-envelope"></i>
            <span class="mail-badge" id="topMailBadge">0</span>
        </div>
        <h1>职员档案 <span class="sub"><span class="offline-tag">OFFLINE</span><span class="readonly-tag">READ-ONLY</span></span></h1>
    </div>
</div>
<div class="swiper-container" id="swiperContainer">
<div class="swiper-wrapper" id="swiperWrapper">
<div id="view-char" class="tab-view">
<div class="char-layout">
<div class="panel"><h2><i class="fas fa-shield-alt"></i> 资质保证</h2><div id="attrs-list"></div></div>
<div class="panel">
<h2><i class="fas fa-id-card"></i> 基础信息</h2>
<label>玩家姓名</label><input type="text" id="pName" placeholder="输入姓名">
<div class="row-2">
<div><label>异常能力</label><div class="hybrid-input-wrapper" id="grp-pAnom"><select id="sel-pAnom" onchange="handlePresetChange('pAnom', this.value)"></select><input type="text" id="pAnom" placeholder="输入异常能力"><button class="btn-reset-list" onclick="resetToDropdown('pAnom')"><i class="fas fa-list"></i></button></div></div>
<div><label>现实身份</label><div class="hybrid-input-wrapper" id="grp-pReal"><select id="sel-pReal" onchange="handlePresetChange('pReal', this.value)"></select><input type="text" id="pReal" placeholder="输入现实身份"><button class="btn-reset-list" onclick="resetToDropdown('pReal')"><i class="fas fa-list"></i></button></div></div>
</div>
<label>机构职能</label><div class="hybrid-input-wrapper" id="grp-pFunc"><select id="sel-pFunc" onchange="handlePresetChange('pFunc', this.value)"></select><input type="text" id="pFunc" placeholder="输入机构职能"><button class="btn-reset-list" onclick="resetToDropdown('pFunc')"><i class="fas fa-list"></i></button></div>
<label>现实触发器</label><div class="rich-editor" id="pTrig1" contenteditable="true" placeholder="GM可随时触发此项"></div>
<label>过载解除</label><div class="rich-editor" id="pTrig2" contenteditable="true" placeholder="如何解除过载"></div>
<label>首要指令</label><div class="rich-editor" id="pTrig3" contenteditable="true" placeholder="如果你……，则获得1点申诫"></div>
<label>许可行为</label><div class="perm-group"><input type="text" id="perm1" placeholder="许可行为 1"><input type="text" id="perm2" placeholder="许可行为 2"><input type="text" id="perm3" placeholder="许可行为 3"></div>
<div class="perm-note">如果你在单次任务中完成全部 3 项，将获得 3 点额外嘉奖。</div>
</div>
</div>
<div class="panel">
<h2><i class="fas fa-chart-bar"></i> 进度追踪</h2>
<div class="track-header">
<div class="track-stat"><label>MVP</label><input type="text" id="pComm" placeholder="0" readonly></div>
<div class="track-stat clickable-stat" onclick="showRecordHistory('reward')"><label>嘉奖</label><input type="text" id="mvpCount" placeholder="0" readonly></div>
<div class="track-stat clickable-stat" onclick="showRecordHistory('reprimand')"><label>申诫</label><input type="text" id="watchCount" placeholder="0" readonly></div>
<div class="track-stat"><label>察看期</label><input type="text" id="pRep" placeholder="0" readonly></div>
</div>
<div class="track-sec"><h3 class="c-func" style="font-size:12px; margin:5px 0;">职能</h3><div class="track-row"><div class="p-grid"><div class="p-cell f-cell" data-idx="1"></div><div class="p-cell f-cell" data-idx="2"></div><div class="p-cell f-cell" data-idx="3"><span>A3</span></div><div class="p-cell f-cell" data-idx="4"></div><div class="p-cell f-cell" data-idx="5"></div><div class="p-cell f-cell" data-idx="6"><span>D4</span></div><div class="p-cell f-cell" data-idx="7"></div><div class="p-cell f-cell" data-idx="8"></div><div class="p-cell f-cell" data-idx="9"><span>G3</span></div><div class="p-cell f-cell" data-idx="10"></div></div><div class="p-grid"><div class="p-cell f-cell" data-idx="11"></div><div class="p-cell f-cell" data-idx="12"><span>J3</span></div><div class="p-cell f-cell" data-idx="13"></div><div class="p-cell f-cell" data-idx="14"></div><div class="p-cell f-cell" data-idx="15"><span>N3</span></div><div class="p-cell f-cell" data-idx="16"></div><div class="p-cell f-cell" data-idx="17"></div><div class="p-cell f-cell" data-idx="18"><span>Q3</span></div><div class="p-cell f-cell" data-idx="19"></div><div class="p-cell f-cell" data-idx="20"></div></div><div class="p-grid"><div class="p-cell f-cell" data-idx="21"><span>T3</span></div><div class="p-cell f-cell" data-idx="22"></div><div class="p-cell f-cell" data-idx="23"></div><div class="p-cell f-cell" data-idx="24"><span>W8</span></div><div class="p-cell f-cell" data-idx="25"></div><div class="p-cell f-cell" data-idx="26"></div><div class="p-cell f-cell" data-idx="27"><span>Y2</span></div><div class="p-cell f-cell" data-idx="28"></div><div class="p-cell f-cell" data-idx="29"></div><div class="p-cell f-cell" data-idx="30"></div></div></div><div class="track-rule">当你获得任务MVP时，在你的职能记录条上标记1格，且无需从其他记录条上移除一格。</div><div class="track-rule">每当你在职能记录条上标记一格时，将任意一项资质的"资质保证上限"提升1点，最高不超过9点。</div></div>
<div class="track-sec"><h3 class="c-real" style="font-size:12px; margin:5px 0;">现实</h3><div class="track-row"><div class="p-grid"><div class="p-cell r-cell" data-idx="1"><span>C4</span></div><div class="p-cell r-cell" data-idx="2"></div><div class="p-cell r-cell" data-idx="3"></div><div class="p-cell r-cell" data-idx="4"><span>L11</span></div><div class="p-cell r-cell" data-idx="5"></div><div class="p-cell r-cell" data-idx="6"></div><div class="p-cell r-cell" data-idx="7"></div><div class="p-cell r-cell" data-idx="8"><span>E2</span></div><div class="p-cell r-cell" data-idx="9"></div><div class="p-cell r-cell" data-idx="10"><span>O4</span></div></div><div class="p-grid"><div class="p-cell r-cell" data-idx="11"></div><div class="p-cell r-cell" data-idx="12"><span>J3</span></div><div class="p-cell r-cell" data-idx="13"></div><div class="p-cell r-cell" data-idx="14"><span>T6</span></div><div class="p-cell r-cell" data-idx="15"></div><div class="p-cell r-cell" data-idx="16"><span>V2</span></div><div class="p-cell r-cell" data-idx="17"></div><div class="p-cell r-cell" data-idx="18"></div><div class="p-cell r-cell" data-idx="19"></div><div class="p-cell r-cell" data-idx="20"><span>X3</span></div></div><div class="p-grid"><div class="p-cell r-cell" data-idx="21"></div><div class="p-cell r-cell" data-idx="22"><span>H5</span></div><div class="p-cell r-cell" data-idx="23"></div><div class="p-cell r-cell" data-idx="24"></div><div class="p-cell r-cell" data-idx="25"></div><div class="p-cell r-cell" data-idx="26"></div><div class="p-cell r-cell" data-idx="27"><span>E3</span></div><div class="p-cell r-cell" data-idx="28"></div><div class="p-cell r-cell" data-idx="29"></div><div class="p-cell r-cell" data-idx="30"></div></div></div><div class="track-rule">当你既未获得任务MVP也未进入察看期时，你可以将你与任意一段关系的连结提升1点。</div><div class="track-rule">每当你在现实记录条上标记一格时，将你与任意一段"关系"的"连结"提升1点，然后对关系网内的每段关系重复此操作。</div></div>
<div class="track-sec"><h3 class="c-anom" style="font-size:12px; margin:5px 0;">异常</h3><div class="track-row"><div class="p-grid"><div class="p-cell a-cell" data-idx="1"><span>H4</span></div><div class="p-cell a-cell" data-idx="2"><span>H3</span></div><div class="p-cell a-cell" data-idx="3"></div><div class="p-cell a-cell" data-idx="4"></div><div class="p-cell a-cell" data-idx="5"><span>U2</span></div><div class="p-cell a-cell" data-idx="6"></div><div class="p-cell a-cell" data-idx="7"><span>X2</span></div><div class="p-cell a-cell" data-idx="8"></div><div class="p-cell a-cell" data-idx="9"></div><div class="p-cell a-cell" data-idx="10"></div></div><div class="p-grid"><div class="p-cell a-cell" data-idx="11"><span>N1</span></div><div class="p-cell a-cell" data-idx="12"></div><div class="p-cell a-cell" data-idx="13"><span>Q2</span></div><div class="p-cell a-cell" data-idx="14"></div><div class="p-cell a-cell" data-idx="15"></div><div class="p-cell a-cell" data-idx="16"></div><div class="p-cell a-cell" data-idx="17"><span>L10</span></div><div class="p-cell a-cell" data-idx="18"></div><div class="p-cell a-cell" data-idx="19"><span>G8</span></div><div class="p-cell a-cell" data-idx="20"></div></div><div class="p-grid"><div class="p-cell a-cell" data-idx="21"></div><div class="p-cell a-cell" data-idx="22"></div><div class="p-cell a-cell" data-idx="23"><span>A7</span></div><div class="p-cell a-cell" data-idx="24"></div><div class="p-cell a-cell" data-idx="25"></div><div class="p-cell a-cell" data-idx="26"></div><div class="p-cell a-cell" data-idx="27"></div><div class="p-cell a-cell" data-idx="28"></div><div class="p-cell a-cell" data-idx="29"></div><div class="p-cell a-cell" data-idx="30"></div></div></div><div class="track-rule">当你进入察看期时，在你的异常记录条上标记1格，且无需从其他记录条上移除一格。</div><div class="track-rule">每当你在异常记录条上标记一格时，选择一项：<br>➤练习：在任意一项异常能力上标记"熟练"。 <br>➤广为人知：从一项异常能力中移除"熟练"标记，并向你的团队提出该能力的问题。在获得最多票数的答案轨道上做标记，然后获得所有已解锁的能力。</div></div>
</div>
<div class="panel"><h2><i class="fas fa-file-contract"></i> 欢迎你，特工！</h2><div style="margin-bottom:12px;"><label>1. 你是如何与你的异常接触的？</label><div class="rich-editor" id="q1" contenteditable="true"></div></div><div style="margin-bottom:12px;"><label>2. 机构是如何找到你的？</label><div class="rich-editor" id="q2" contenteditable="true"></div></div><div style="margin-bottom:12px;"><label>3. 你的能力有独特的外在视觉表现吗？</label><div class="rich-editor" id="q3" contenteditable="true"></div></div><div style="margin-bottom:12px;"><label>4. 你喝咖啡有什么偏好？</label><div class="rich-editor" id="q4" contenteditable="true"></div></div><div style="margin-bottom:12px;"><label>5. 请描述你过往的工作经历</label><div class="rich-editor" id="q5" contenteditable="true"></div></div><div style="margin-bottom:12px;"><label>6. 你对Adobe、Excel和Google套件的熟悉程度如何？</label><div class="rich-editor" id="q6" contenteditable="true"></div></div><div style="margin-bottom:12px;"><label>7. 在协作工作环境中，你能做出什么贡献？</label><div class="rich-editor" id="q7" contenteditable="true"></div></div></div>
<div class="panel"><h2><i class="fas fa-sticky-note"></i> 备注/笔记</h2><label>标题</label><input type="text" id="noteTitle" style="margin-bottom: 12px; font-weight: bold;"><label>内容</label><div class="rich-editor" id="noteBody" contenteditable="true" placeholder="摘要..."></div></div>
<div class="save-area"><button class="btn-save btn-save-server" onclick="saveData()"><i class="fas fa-cloud-upload-alt"></i> 上传终端</button>
<button class="btn-save btn-export" onclick="exportOffline()"><i class="fas fa-download"></i> 离线另存</button>

<button class="btn-save btn-export" onclick="exportJson()">
        <i class="fas fa-download"></i> 导出JSON
    </button>
    <!-- 导入 JSON 按钮 -->
    <button class="btn-save btn-export" onclick="triggerImport()">
        <i class="fas fa-download"></i> 导入覆盖
    </button>
	<input type="file" id="jsonInput" accept=".json" style="display:none" onchange="handleImportJson(this)">
	
</div>
</div>
<div id="view-anom" class="tab-view"><div class="mod-header"><h2>异常能力</h2><button class="btn-add" onclick="addAnom(null, false)"><i class="fas fa-plus"></i> 添加</button></div><div id="list-anom"></div><div class="save-area"><button class="btn-save btn-save-server" onclick="saveData()"><i class="fas fa-cloud-upload-alt"></i> 上传终端</button><button class="btn-save btn-export" onclick="exportOffline()"><i class="fas fa-download"></i> 离线另存</button></div></div>
<div id="view-real" class="tab-view"><div class="mod-header"><h2>关系网</h2><button class="btn-add" onclick="addRealSafe()"><i class="fas fa-plus"></i> 添加</button></div><div id="list-real"></div><div class="save-area"><button class="btn-save btn-save-server" onclick="saveData()"><i class="fas fa-cloud-upload-alt"></i> 上传终端</button><button class="btn-save btn-export" onclick="exportOffline()"><i class="fas fa-download"></i> 离线另存</button></div></div>
<div id="view-item" class="tab-view"><div class="mod-header"><h2>申领物/福利</h2><button class="btn-add" onclick="addItem(null, false)"><i class="fas fa-plus"></i> 添加</button></div><div id="list-item"></div><div class="save-area"><button class="btn-save btn-save-server" onclick="saveData()"><i class="fas fa-cloud-upload-alt"></i> 上传终端</button><button class="btn-save btn-export" onclick="exportOffline()"><i class="fas fa-download"></i> 离线另存</button></div></div>
</div>
</div>
</div>

<!-- 邮箱全屏模态框 -->
<div id="mail-full-modal" class="full-page-modal">
    <div class="mail-modal-header">
        <h2><i class="fas fa-envelope"></i> 机构邮箱</h2>
        <button class="btn-close-mail" onclick="closeMailModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="mail-modal-body">
        <div class="mail-container-inner">
			<div class="mail-tabs">
				<button class="mail-tab active" onclick="switchMailTab('inbox')"><i class="fas fa-inbox"></i><span>收件箱</span></button>
				<button class="mail-tab" onclick="switchMailTab('sent')"><i class="fas fa-paper-plane"></i><span>已发邮件</span></button>
				<button class="mail-tab" id="tab-compose" onclick="switchMailTab('compose')"><i class="fas fa-pen"></i><span>写信</span></button>
				<button class="mail-tab" id="tab-highwall" onclick="switchMailTab('highwall')" style="display:none;"><i class="fas fa-file-shield"></i><span>高墙文件</span></button>
			</div>
            <div class="mail-content" id="mailContent">
                <div class="mail-empty">
                    <i class="fas fa-envelope-open"></i>
                    <p>加载中...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 高墙特效 (伪装 -> 故障 -> 眼睛 -> 吞噬) -->
<div id="hw-overlay">
    <!-- 1. 伪装层 -->
    <div class="hw-normal-content" id="hw-content">
        <i class="fas fa-circle-notch fa-spin hw-loader-icon" id="hw-icon"></i>
        <div class="hw-loader-text" id="hw-text">访问高墙文件<span class="hw-dots"></span></div>
    </div>

    <!-- 2. 故障层 -->
    <div class="hw-scanlines" id="hw-scanlines"></div>

    <!-- 3. 眼睛层 -->
    <div class="hw-eye-layer" id="hw-eye-layer">
        <svg class="hw-eye-svg" id="hw-eye-icon" viewBox="0 0 100 90">
            <path d="M5 45 Q 50 5 95 45 Q 50 85 5 45 Z" fill="#000" stroke="#00f3ff" stroke-width="3"/>
            <circle cx="50" cy="45" r="16" fill="#00f3ff" opacity="0.8" />
            <path d="M50 30 Q 54 45 50 60 Q 46 45 50 30 Z" fill="#fff" />
        </svg>
    </div>

    <!-- 4. 暗影触手层 -->
    <div class="hw-tentacles-layer" id="hw-tentacles"></div>

    <!-- 5. 最终熄灭层 -->
    <div id="hw-blackout"></div>
</div>

<!-- 蓝色眼睛邮件阅读器 -->
<div id="mail-reader-overlay">
    <!-- 背景光晕 -->
    <div class="mail-reader-bg"></div>

    <!-- 背景眼睛装饰 -->
    <div class="mail-eye-container">
        <svg class="mail-eye-svg" viewBox="0 0 100 60">
            <path d="M5 30 Q 50 0 95 30 Q 50 60 5 30 Z" fill="none" stroke="#1e90ff" stroke-width="2"/>
            <circle cx="50" cy="30" r="15" fill="#1e90ff" opacity="0.6"/>
            <circle cx="50" cy="30" r="8" class="eye-pupil"/>
            <ellipse cx="46" cy="27" rx="3" ry="4" fill="rgba(255,255,255,0.4)"/>
        </svg>
    </div>

    <!-- 扫描线效果 -->
    <div class="mail-scanlines"></div>

    <!-- 邮件内容面板 -->
    <div class="mail-reader-panel">
        <div class="mail-reader-header">
            <div class="mail-reader-title">
                <h3 id="mail-reader-subject">邮件标题</h3>
                <div class="mail-reader-meta">
                    <span id="mail-reader-sender"><i class="fas fa-user"></i> 发件人</span>
                    <span id="mail-reader-time"><i class="fas fa-clock"></i> 时间</span>
                </div>
            </div>
            <button class="mail-reader-close" onclick="closeMailReader()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mail-reader-body" id="mail-reader-body">
            邮件内容
        </div>
        <div class="mail-reader-actions" id="mail-reader-actions">
            <button class="mail-reader-btn secondary" onclick="closeMailReader()">
                <i class="fas fa-check"></i> 关闭
            </button>
        </div>
    </div>
</div>

<div class="nav-bar">
<div class="nav-btn active n-char" onclick="switchView('view-char', this)"><i class="fas fa-id-badge"></i><span>档案</span></div>
<div class="nav-btn n-anom" onclick="switchView('view-anom', this)"><i class="fas fa-bolt"></i><span>异常</span></div>
<div class="nav-btn n-real" onclick="switchView('view-real', this)"><i class="fas fa-heart"></i><span>关系</span></div>
<div class="nav-btn n-item" onclick="switchView('view-item', this)"><i class="fas fa-box-open"></i><span>物品</span></div>
<!-- n-mail Removed -->
</div>
<script id="__SAVED_DATA__" type="application/json"></script>
<script>
const params = new URLSearchParams(window.location.search);
const charId = params.get('id');
const isReadOnly = params.get('readonly') === 'true';
const token = localStorage.getItem('ta_token');

// 获取带认证的请求头
function getAuthHeaders() {
    const headers = { 'Content-Type': 'application/json' };
    if (token) headers['Authorization'] = `Bearer ${token}`;
    return headers;
}

// [修改] 初始化增加 bonuses
let CONFIG_DATA = { anoms: [], realities: [], functions: [], bonuses: [] };

// 槽位限制
let SLOT_LIMITS = { anomSlots: 3, realSlots: 3 };

async function loadConfigData() {
    try {
        const res = await fetch('/api/options');
        if (res.ok) {
            CONFIG_DATA = await res.json();
            console.log("配置数据加载成功:", CONFIG_DATA);
            initDropdowns();
        } else { console.error("无法加载配置数据"); }
    } catch (e) { console.error("配置数据请求出错:", e); }
}

function initDropdowns() {
    const fillSelect = (id, items) => {
        const sel = document.getElementById(id);
        if(!sel) return;
        sel.innerHTML = '<option value="" disabled selected>-- 请选择 --</option>';
        if (items && Array.isArray(items)) {
            items.forEach(item => {
                const val = typeof item === 'string' ? item : item.name;
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = val;
                sel.appendChild(opt);
            });
        }
        const customOpt = document.createElement('option');
        customOpt.value = '__CUSTOM__';
        customOpt.textContent = '➤ 自定义 / 手动输入...';
        sel.appendChild(customOpt);
    };
    fillSelect('sel-pAnom', CONFIG_DATA.anoms);
    fillSelect('sel-pReal', CONFIG_DATA.realities);
    fillSelect('sel-pFunc', CONFIG_DATA.functions);
}

function handlePresetChange(fieldId, value) {
    const wrapper = document.getElementById(`grp-${fieldId}`);
    const input = document.getElementById(fieldId);
    if (value === '__CUSTOM__') {
        wrapper.classList.add('show-input');
        input.value = ''; 
        input.focus();
    } else {
        input.value = value;
        applyCascadingLogic(fieldId, value);
    }
}

function resetToDropdown(fieldId) {
    const wrapper = document.getElementById(`grp-${fieldId}`);
    const select = document.getElementById(`sel-${fieldId}`);
    const input = document.getElementById(fieldId);
    wrapper.classList.remove('show-input');
    select.value = ''; 
    input.value = '';  
}

// ===================================
// 联动逻辑
// ===================================
function applyCascadingLogic(fieldId, value) {
    if (!value) return;

    if (fieldId === 'pReal') {
        const config = CONFIG_DATA.realities.find(r => r.name === value);
        if (config) {
            document.getElementById('pTrig1').innerHTML = config.trigger || ''; 
            document.getElementById('pTrig2').innerHTML = config.overload || '';
        }
    } 
    else if (fieldId === 'pFunc') {
        const config = CONFIG_DATA.functions.find(f => f.name === value);
        if (config) {
            document.getElementById('pTrig3').innerHTML = config.directive;
            if (config.perms && config.perms.length === 3) {
                document.getElementById('perm1').value = config.perms[0];
                document.getElementById('perm2').value = config.perms[1];
                document.getElementById('perm3').value = config.perms[2];
            }
            const itemListContainer = document.getElementById('list-item');
            const presetItems = (config.items || []).slice().reverse();
            const numToReplace = presetItems.length;
            for (let i = 0; i < numToReplace; i++) {
                if (itemListContainer.firstChild) {
                    itemListContainer.firstChild.remove();
                }
            }
            presetItems.forEach(itemData => {
                addItem(itemData, true);
            });
        }
    }
    else if (fieldId === 'pAnom') {
        const config = CONFIG_DATA.anoms.find(a => a.name === value);
        if (config) {
             const anomListContainer = document.getElementById('list-anom');
            const presetAbilities = (config.abilities || []).slice().reverse();
            const numToReplace = presetAbilities.length;
            for (let i = 0; i < numToReplace; i++) {
                if (anomListContainer.firstChild) {
                    anomListContainer.firstChild.remove();
                }
            }
            presetAbilities.forEach(abilityData => {
                addAnom(abilityData, true);
            });
        }
    }
}

function setHybridInputState(fieldId, value) {
    const select = document.getElementById(`sel-${fieldId}`);
    const wrapper = document.getElementById(`grp-${fieldId}`);
    const input = document.getElementById(fieldId);
    let isPreset = false;
    Array.from(select.options).forEach(opt => { if (opt.value === value) isPreset = true; });
    input.value = value || '';
    if (isPreset) {
        wrapper.classList.remove('show-input');
        select.value = value;
    } else if (value && value.trim() !== '') {
        wrapper.classList.add('show-input');
        select.value = '__CUSTOM__';
    } else {
        wrapper.classList.remove('show-input');
        select.value = '';
    }
}

document.addEventListener('wheel', (e) => { const a=document.querySelectorAll('.tab-view')[currentTab]; if(a&&!a.contains(e.target))a.scrollTop+=e.deltaY;}, {passive:true});
// ==========================================
// 修复：防止拖拽误触 + 防止弹窗/按钮穿透
// ==========================================
let mouseStartX = 0;
let mouseStartY = 0;

// 1. 记录鼠标按下的位置
document.addEventListener('mousedown', (e) => {
    mouseStartX = e.clientX;
    mouseStartY = e.clientY;
});

// 2. 点击监听（包含穿透修复）
document.addEventListener('click', (e) => {
    // A. 拖拽检测：如果移动超过 5 像素，视为选中文本或拖拽，不触发翻页
    const diffX = Math.abs(e.clientX - mouseStartX);
    const diffY = Math.abs(e.clientY - mouseStartY);
    if (diffX > 5 || diffY > 5) return;

    const c = document.querySelector('.container');
    const n = document.querySelector('.nav-bar');
    
    // B. 排除区域（点击这些地方不会触发翻页）
    if (window.innerWidth <= 930 || 
        c.contains(e.target) || 
        (n && n.contains(e.target)) || 
        e.target.closest('.nav-arrow') ||
        e.target.closest('.modal-overlay') || 
        e.target.closest('.full-page-modal') ||
        e.target.closest('button') ||        
        ['INPUT', 'SELECT', 'TEXTAREA'].includes(e.target.tagName)) {
        return;
    }

    // C. 执行翻页逻辑
    const x = e.clientX;
    const m = window.innerWidth / 2;
    
    if (x < m) {
        if (currentTab > 0) { currentTab--; updateSwiper(); }
    } else {
        if (currentTab < tabOrder.length - 1) { currentTab++; updateSwiper(); }
    }
});

let currentTab = 0;
// 修改 tabOrder，移除了 'view-mail'
const tabOrder = ['view-char', 'view-anom', 'view-real', 'view-item'];
const swiperWrapper = document.getElementById('swiperWrapper');
const navBtns = document.querySelectorAll('.nav-btn');
function switchView(id, btn) { 
    if(id === 'view-mail') {
        openMailModal();
        return;
    }
    const i=tabOrder.indexOf(id); 
    if(i!==-1){
        currentTab=i;
        updateSwiper();
    } 
}
function moveTab(dir) { const n=currentTab+dir; if(n>=0&&n<tabOrder.length){currentTab=n;updateSwiper();} }
function updateSwiper() { swiperWrapper.style.transform=`translateX(-${currentTab*25}%)`; navBtns.forEach((b,i)=>{if(i===currentTab)b.classList.add('active');else b.classList.remove('active');}); document.querySelectorAll('.tab-view')[currentTab].scrollTop=0; const l=document.querySelector('.arrow-left'), r=document.querySelector('.arrow-right'); if(l&&r){ if(currentTab===0)l.classList.add('disabled');else l.classList.remove('disabled'); if(currentTab===tabOrder.length-1)r.classList.add('disabled');else r.classList.remove('disabled');} }
let touchStartX=0, touchStartY=0, isSwipingDisabled=false; const minSwipe=60, container=document.getElementById('swiperContainer');
container.addEventListener('touchstart',e=>{ const t=e.target; if(t.tagName.toLowerCase()==='input'||t.tagName.toLowerCase()==='textarea'||t.isContentEditable||t.tagName.toLowerCase()==='select'){isSwipingDisabled=true;}else{isSwipingDisabled=false;touchStartX=e.changedTouches[0].screenX;touchStartY=e.changedTouches[0].screenY;}},{passive:true});
container.addEventListener('touchend',e=>{ if(isSwipingDisabled)return; const x=e.changedTouches[0].screenX, y=e.changedTouches[0].screenY; handleSwipe(x,y);},{passive:true});
function handleSwipe(endX,endY){ const dX=endX-touchStartX, dY=endY-touchStartY; if(Math.abs(dX)>minSwipe&&Math.abs(dX)>Math.abs(dY)){ if(dX<0){if(currentTab<tabOrder.length-1){currentTab++;updateSwiper();}}else{if(currentTab>0){currentTab--;updateSwiper();}}}}
function setRandomVars(el) { el.style.setProperty('--r1',Math.random()); el.style.setProperty('--r2',Math.random()); el.style.setProperty('--r3',Math.random()); }
document.addEventListener('DOMContentLoaded', async () => {
    document.querySelectorAll('.panel').forEach(setRandomVars);
    await loadConfigData();
    updateSwiper();
    initAttrs();
    // 页面加载完成后加载邮箱状态
    loadMailbox(); 
    
    const offlineDataEl = document.getElementById('__SAVED_DATA__');
    if(offlineDataEl && offlineDataEl.textContent.trim().length > 2) {
        document.body.classList.add('offline-mode');
        populateData(JSON.parse(offlineDataEl.textContent));
    } else {
        if(!charId) { window.location.href='dashboard.html'; return; }
        try {
            const res=await fetch(`/api/character/${charId}`, { headers: getAuthHeaders() });
            if (res.status === 401 || res.status === 403) {
                window.location.href = 'login.html';
                return;
            }
            const data=await res.json();
            populateData(data);
        }
        catch(e) { if(!document.getElementById('list-anom').children.length) addAnom(null, false); if(!document.getElementById('list-real').children.length) document.getElementById('list-real').appendChild(addReal()); if(!document.getElementById('list-item').children.length) addItem(null, false); }
    }
});
if (isReadOnly) {
    document.body.classList.add('readonly-mode');
    document.addEventListener('DOMContentLoaded', () => {
         document.querySelectorAll('[contenteditable]').forEach(el => el.setAttribute('contenteditable', 'false'));
         ['pAnom', 'pReal', 'pFunc'].forEach(id => { document.getElementById(`grp-${id}`).classList.add('show-input'); });
    });
}
// ==========================================================
// MODIFIED: 重写 goBack 函数以支持多来源返回
// ==========================================================
async function goBack() {
    // 1. 确定目标URL
    const params = new URLSearchParams(window.location.search);
    const cameFromManager = params.get('from') === 'manager';
    
    let destinationUrl = 'dashboard.html'; // 默认是仪表盘
    if (cameFromManager) {
        destinationUrl = 'manager.html'; // 如果来自经理页，则返回经理页
    } else if (isReadOnly) {
        // 只读模式通常来自监控页
        destinationUrl = 'monitor.html';
    }

    // 2. 如果是离线模式，直接跳转
    if (document.body.classList.contains('offline-mode')) {
        window.location.href = destinationUrl;
        return;
    }

    // 3. 如果不是只读模式，尝试静默保存
    if (!isReadOnly) {
        const backButton = document.querySelector('.btn-back');
        backButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存并返回';
        try {
            await saveData(true); // true 表示静默保存
        } catch (e) {
            console.error("返回前自动保存失败:", e);
            // 即使保存失败，也继续跳转
        }
    }
    
    // 4. 跳转到目标URL
    window.location.href = destinationUrl;
}

// ==========================================
// 邮箱系统
// ==========================================
let currentMailTab = 'inbox';
let mailData = { inbox: [], sent: [], highwallFiles: [] };
let isA1Unlocked = false; // 是否解锁了A1高墙文件（控制报告提交权限）
let canSendMessages = true; // 是否有发信权限（经理可控制）

function openMailModal() {
    document.getElementById('mail-full-modal').classList.add('active');
    loadMailbox();
}

function closeMailModal() {
    document.getElementById('mail-full-modal').classList.remove('active');
}

function switchMailTab(tab) {
    currentMailTab = tab;
    document.querySelectorAll('.mail-tab').forEach(t => t.classList.remove('active'));
    const tabIndex = tab === 'inbox' ? 1 : tab === 'sent' ? 2 : tab === 'compose' ? 3 : 4;
    document.querySelector(`.mail-tab:nth-child(${tabIndex})`).classList.add('active');
    renderMailContent();
}

async function loadMailbox() {
    if (!charId || !token) return;

    const content = document.getElementById('mailContent');
    // content.innerHTML = '<div class="mail-empty"><i class="fas fa-circle-notch fa-spin"></i><p>加载中...</p></div>';

    try {
        // 检查A1解锁状态
        const a1Res = await fetch(`/api/character/${charId}/check-a1`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (a1Res.ok) {
            const a1Data = await a1Res.json();
            isA1Unlocked = a1Data.unlocked;
        }

        // 加载收件箱
        const inboxRes = await fetch(`/api/character/${charId}/messages`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (inboxRes.ok) {
            mailData.inbox = await inboxRes.json();
        }

        // 加载已发邮件
        const sentRes = await fetch(`/api/character/${charId}/sent-messages`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (sentRes.ok) {
            mailData.sent = await sentRes.json();
        }

        // 加载高墙文件权限
        const hwRes = await fetch(`/api/character/${charId}/highwall-files`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (hwRes.ok) {
            mailData.highwallFiles = await hwRes.json();
        }

        // 更新顶部未读消息标记
        const unreadCount = mailData.inbox.filter(m => !m.read).length;
        const mailBtn = document.querySelector('.top-mail-btn');
        const badge = document.getElementById('topMailBadge');

        if (unreadCount > 0) {
            mailBtn.classList.add('has-unread');
            badge.style.display = 'block';
            badge.textContent = unreadCount;
        } else {
            mailBtn.classList.remove('has-unread');
            badge.style.display = 'none';
        }

        // 高墙文件夹标签 - 只有解锁A1后才显示
        const hwTab = document.getElementById('tab-highwall');
        if (hwTab) {
            if (isA1Unlocked) {
                hwTab.style.display = '';
            } else {
                hwTab.style.display = 'none';
                // 如果当前在高墙标签页，切换到收件箱
                if (currentMailTab === 'highwall') {
                    switchMailTab('inbox');
                    return; // switchMailTab 会调用 renderMailContent
                }
            }
        }

        // 无论是否是当前页签，都刷新内容（因为是在弹窗里）
        renderMailContent();
        
    } catch (e) {
        console.error('加载邮箱失败:', e);
        content.innerHTML = '<div class="mail-empty"><i class="fas fa-exclamation-triangle"></i><p>加载失败</p></div>';
    }
}

function renderMailContent() {
    const content = document.getElementById('mailContent');

    if (currentMailTab === 'inbox') {
        renderInbox(content);
    } else if (currentMailTab === 'sent') {
        renderSentMail(content);
    } else if (currentMailTab === 'compose') {
        renderCompose(content);
    } else if (currentMailTab === 'highwall') {
        renderHighwallFiles(content);
    }
}

function renderInbox(container) {
    // 组合：高墙授权通知(从数据库) + 站内信
    const messages = [];

    // 站内信（包含高墙授权通知，现在从 character_messages 表来）
    mailData.inbox.forEach(m => {
        messages.push({
            type: m.messageType || 'mail',
            id: m.id,
            sender: m.senderName,
            subject: m.subject,
            content: m.content,
            preview: m.content ? m.content.substring(0, 50) : '',
            time: m.createdAt,
            read: m.read,
            hwFilename: m.hwFilename,
            reportId: m.reportId
        });
    });

    // 按时间排序
    messages.sort((a, b) => b.time - a.time);

    if (messages.length === 0) {
        container.innerHTML = '<div class="mail-empty"><i class="fas fa-inbox"></i><p>收件箱为空</p></div>';
        return;
    }

    container.innerHTML = '<div class="mail-list">' + messages.map(m => {
        const date = new Date(m.time).toLocaleDateString('zh-CN');
        const isHwAuth = m.type === 'hw_auth';
        const isOS = m.sender === 'OS' || isHwAuth;

        // 构建点击处理
        const clickHandler = `openMailReader(${JSON.stringify(m).replace(/"/g, '&quot;')})`;

        return `
            <div class="mail-item ${isHwAuth ? 'hw-auth' : ''} ${m.read === 0 || m.read === false ? 'unread' : ''}"
                 onclick="${clickHandler}">
                <div class="mail-sender">
                    ${isOS ? '<span class="os-badge">OS</span>' : `<i class="fas fa-user"></i> ${escapeHtmlMail(m.sender)}`}
                </div>
                <div class="mail-subject">${escapeHtmlMail(m.subject)}</div>
                <div class="mail-preview">${escapeHtmlMail(m.preview)}</div>
                <div class="mail-time"><i class="fas fa-clock"></i> ${date}</div>
            </div>
        `;
    }).join('') + '</div>';
}

let currentOutboxForm = null;
let sendTargets = { manager: null, teammates: [] };

async function loadSendTargets() {
    try {
        const res = await fetch(`/api/character/${charId}/send-targets`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
            sendTargets = await res.json();
        }
    } catch (e) {
        console.error('加载发送目标失败:', e);
    }
}

function renderSentMail(container) {
    const messages = mailData.sent || [];

    if (messages.length === 0) {
        container.innerHTML = '<div class="mail-empty"><i class="fas fa-paper-plane"></i><p>暂无已发邮件</p></div>';
        return;
    }

    container.innerHTML = '<div class="mail-list">' + messages.map(m => {
        const date = new Date(m.createdAt);
        const timeStr = date.toLocaleString('zh-CN', {
            month: 'numeric', day: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });
        const preview = m.content ? m.content.substring(0, 50) + (m.content.length > 50 ? '...' : '') : '';
        return `
            <div class="mail-item sent-mail-item" onclick="openSentMailReader('${m.id}')">
                <div class="mail-icon sent-icon"><i class="fas fa-paper-plane"></i></div>
                <div class="mail-info">
                    <div class="mail-header-row">
                        <span class="mail-recipient">收件人: ${escapeHtmlText(m.recipientName)}</span>
                        <span class="mail-time">${timeStr}</span>
                    </div>
                    <div class="mail-subject">${escapeHtmlText(m.subject)}</div>
                    <div class="mail-preview">${escapeHtmlText(preview)}</div>
                </div>
            </div>
        `;
    }).join('') + '</div>';
}

function renderCompose(container) {
    // 提交报告选项 - 只有解锁A1后才显示
    const reportOption = isA1Unlocked ? `
            <div class="outbox-option opt-report" onclick="selectOutboxOption('report')">
                <i class="fas fa-file-alt"></i>
                <h4>提交任务报告</h4>
                <p>填写并提交任务报告</p>
            </div>` : '';

    container.innerHTML = `
        <div class="outbox-options">
            <div class="outbox-option opt-containment" onclick="selectOutboxOption('containment')">
                <i class="fas fa-cube"></i>
                <h4>寄送收容物</h4>
                <p>向经理发送收容物品</p>
            </div>
            ${reportOption}
            <div class="outbox-option opt-mail" onclick="selectOutboxOption('mail')">
                <i class="fas fa-envelope"></i>
                <h4>发信</h4>
                <p>给经理或队友发送消息</p>
            </div>
        </div>

        <!-- 寄送收容物表单 -->
        <div id="form-containment" class="outbox-form">
            <h4><i class="fas fa-cube" style="color:#27ae60;"></i> 寄送收容物</h4>
            <label>收容物名称 *</label>
            <input type="text" id="containment-name" placeholder="输入收容物名称">
            <label>收容物描述</label>
            <textarea id="containment-desc" placeholder="描述收容物的特征、来源等信息..."></textarea>
            <button class="btn-send" onclick="sendContainment()">
                <i class="fas fa-paper-plane"></i> 寄送
            </button>
        </div>

        <!-- 任务报告表单 -->
        <div id="form-report" class="outbox-form">
            <h4><i class="fas fa-file-alt" style="color:#e67e22;"></i> 任务报告</h4>

            <div class="report-section">
                <h5>异常状态</h5>
                <div class="report-status-grid">
                    <label class="report-status-item">
                        <input type="radio" name="rpt-status" value="neutralized" id="rpt-neutralized">
                        <span class="status-icon">🔫</span>
                        <div class="status-info"><h6>已中和</h6><small>无影响</small></div>
                    </label>
                    <label class="report-status-item">
                        <input type="radio" name="rpt-status" value="captured" id="rpt-captured">
                        <span class="status-icon">💼</span>
                        <div class="status-info"><h6>已捕获</h6><small>+3 嘉奖</small></div>
                    </label>
                    <label class="report-status-item">
                        <input type="radio" name="rpt-status" value="escaped" id="rpt-escaped">
                        <span class="status-icon">🚪</span>
                        <div class="status-info"><h6>已逃脱</h6><small>+3 申诫</small></div>
                    </label>
                    <label class="report-status-item">
                        <input type="radio" name="rpt-status" value="other" id="rpt-other-check">
                        <span class="status-icon">📝</span>
                        <div class="status-info"><h6>其他</h6><input type="text" id="rpt-other-text" placeholder="..." style="width:80px;padding:2px 5px;font-size:11px;" onclick="event.stopPropagation()"></div>
                    </label>
                </div>
            </div>

            <div class="report-section">
                <h5>异常分析</h5>
                <div class="report-row"><label>代号</label><input type="text" id="rpt-codename"></div>
                <div class="report-row"><label>行为</label><input type="text" id="rpt-behavior"></div>
                <div class="report-row"><label>焦点</label><input type="text" id="rpt-focus"></div>
                <div class="report-row"><label>领域</label><input type="text" id="rpt-domain"></div>
            </div>

            <div class="report-section">
                <h5>散逸端 <button type="button" class="btn-add-row" onclick="addScatterRow()"><i class="fas fa-plus"></i> 添加</button></h5>
                <table class="report-table">
                    <thead><tr><th>名称</th><th>数量</th><th>备注</th><th></th></tr></thead>
                    <tbody id="scatterTableBody">
                        <tr class="scatter-row">
                            <td><input type="text" class="scat-name" placeholder="物品名称"></td>
                            <td><input type="text" class="scat-qty" placeholder="数量"></td>
                            <td><input type="text" class="scat-note" placeholder="备注"></td>
                            <td><button type="button" class="btn-remove-row" onclick="removeScatterRow(this)"><i class="fas fa-times"></i></button></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="report-section">
                <h5>评优信息</h5>
                <div class="report-row"><label>最终评级</label><input type="text" id="rpt-rating" placeholder="仅供GM使用"></div>
                <div class="report-row"><label>混沌池</label><input type="number" id="rpt-chaos" value="0"></div>
                <div class="report-row"><label>MVP</label><input type="text" id="rpt-mvp"></div>
                <div class="report-row"><label>察看期</label><input type="text" id="rpt-probation"></div>
                <label style="margin-top:10px;">参与者</label>
                <textarea id="rpt-participants" placeholder="填写参与任务的特工..."></textarea>
            </div>

            <div class="report-section">
                <h5>可选目标</h5>
                <table class="report-table">
                    <thead><tr><th>目标</th><th>奖励</th><th>按特工</th></tr></thead>
                    <tbody>
                        <tr><td><input type="text" id="rpt-obj1-target"></td><td><input type="text" id="rpt-obj1-reward"></td><td><input type="text" id="rpt-obj1-agent"></td></tr>
                        <tr><td><input type="text" id="rpt-obj2-target"></td><td><input type="text" id="rpt-obj2-reward"></td><td><input type="text" id="rpt-obj2-agent"></td></tr>
                        <tr><td><input type="text" id="rpt-obj3-target"></td><td><input type="text" id="rpt-obj3-reward"></td><td><input type="text" id="rpt-obj3-agent"></td></tr>
                    </tbody>
                </table>
            </div>

            <button class="btn-send" onclick="sendReport()">
                <i class="fas fa-paper-plane"></i> 提交报告
            </button>
        </div>

        <!-- 发信表单 -->
        <div id="form-mail" class="outbox-form">
            <h4><i class="fas fa-envelope" style="color:#8e44ad;"></i> 发送消息</h4>
            <label>收件人 *</label>
            <select id="mail-recipient">
                <option value="" disabled selected>-- 选择收件人 --</option>
            </select>
            <label>主题 *</label>
            <input type="text" id="mail-subject" placeholder="输入邮件主题">
            <label>内容 *</label>
            <textarea id="mail-content" placeholder="输入邮件内容..."></textarea>
            <button class="btn-send" onclick="sendMail()">
                <i class="fas fa-paper-plane"></i> 发送
            </button>
        </div>
    `;

    // 加载发送目标（经理和队友）
    loadSendTargets().then(() => {
        populateRecipients();
    });
}

function selectOutboxOption(type) {
    // 更新选中状态
    document.querySelectorAll('.outbox-option').forEach(opt => opt.classList.remove('active'));
    document.querySelector(`.opt-${type}`).classList.add('active');

    // 显示对应表单
    document.querySelectorAll('.outbox-form').forEach(form => form.classList.remove('active'));
    document.getElementById(`form-${type}`).classList.add('active');

    currentOutboxForm = type;
}

function populateRecipients() {
    const select = document.getElementById('mail-recipient');
    if (!select) return;

    select.innerHTML = '<option value="" disabled selected>-- 选择收件人 --</option>';

    // 添加经理（API返回的是 managers 数组）
    if (sendTargets.managers && sendTargets.managers.length > 0) {
        sendTargets.managers.forEach(m => {
            const opt = document.createElement('option');
            opt.value = `manager:${m.id}`;
            opt.textContent = `📋 经理: ${m.name || m.username}`;
            select.appendChild(opt);
        });
    }

    // 添加队友（API返回的字段是 id 和 name，服务器期望 recipientType 为 'character'）
    if (sendTargets.teammates && sendTargets.teammates.length > 0) {
        const optGroup = document.createElement('optgroup');
        optGroup.label = '同任务队友';
        sendTargets.teammates.forEach(t => {
            const opt = document.createElement('option');
            opt.value = `character:${t.id}`;
            opt.textContent = `👤 ${t.name}`;
            optGroup.appendChild(opt);
        });
        select.appendChild(optGroup);
    }

    const hasManagers = sendTargets.managers && sendTargets.managers.length > 0;
    const hasTeammates = sendTargets.teammates && sendTargets.teammates.length > 0;
    if (!hasManagers && !hasTeammates) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.disabled = true;
        opt.textContent = '暂无可发送对象';
        select.appendChild(opt);
    }
}

async function sendContainment() {
    const name = document.getElementById('containment-name').value.trim();
    const desc = document.getElementById('containment-desc').value.trim();

    if (!name) {
        showToast('请输入收容物名称', 'error');
        return;
    }

    const btn = document.querySelector('#form-containment .btn-send');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 发送中...';

    try {
        const res = await fetch(`/api/character/${charId}/send-containment`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ name, description: desc })
        });

        if (!res.ok) throw new Error('发送失败');

        showToast('收容物已寄送', 'success');
        document.getElementById('containment-name').value = '';
        document.getElementById('containment-desc').value = '';
    } catch (e) {
        showToast('发送失败: ' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> 寄送';
    }
}

function closeSuccessModal() {
    const modal = document.getElementById('reportSuccessModal');
    if (modal) {
        modal.classList.remove('show');
    }
}



// 散逸端动态行管理
function addScatterRow() {
    const tbody = document.getElementById('scatterTableBody');
    const newRow = document.createElement('tr');
    newRow.className = 'scatter-row';
    newRow.innerHTML = `
        <td><input type="text" class="scat-name" placeholder="物品名称"></td>
        <td><input type="text" class="scat-qty" placeholder="数量"></td>
        <td><input type="text" class="scat-note" placeholder="备注"></td>
        <td><button type="button" class="btn-remove-row" onclick="removeScatterRow(this)"><i class="fas fa-times"></i></button></td>
    `;
    tbody.appendChild(newRow);
}

function removeScatterRow(btn) {
    const tbody = document.getElementById('scatterTableBody');
    const rows = tbody.querySelectorAll('.scatter-row');
    // 保留至少一行
    if (rows.length > 1) {
        btn.closest('tr').remove();
    } else {
        showToast('至少保留一行', 'error');
    }
}

function getScatteringData() {
    const rows = document.querySelectorAll('#scatterTableBody .scatter-row');
    const data = [];
    rows.forEach(row => {
        const name = row.querySelector('.scat-name').value.trim();
        const qty = row.querySelector('.scat-qty').value.trim();
        const note = row.querySelector('.scat-note').value.trim();
        if (name) {
            data.push({ name, qty, note });
        }
    });
    return data;
}

async function sendReport() {
    // 获取选中的单选按钮值
    const selectedStatus = document.querySelector('input[name="rpt-status"]:checked');
    const statusValue = selectedStatus ? selectedStatus.value : null;

    const reportData = {
        status: {
            selected: statusValue,
            neutralized: statusValue === 'neutralized',
            captured: statusValue === 'captured',
            escaped: statusValue === 'escaped',
            other: statusValue === 'other' ? document.getElementById('rpt-other-text').value : null
        },
        analysis: {
            codename: document.getElementById('rpt-codename').value,
            behavior: document.getElementById('rpt-behavior').value,
            focus: document.getElementById('rpt-focus').value,
            domain: document.getElementById('rpt-domain').value
        },
        scattering: getScatteringData(),
        evaluation: {
            rating: document.getElementById('rpt-rating').value,
            chaosPool: document.getElementById('rpt-chaos').value,
            mvp: document.getElementById('rpt-mvp').value,
            probation: document.getElementById('rpt-probation').value,
            participants: document.getElementById('rpt-participants').value
        },
        objectives: [
            { target: document.getElementById('rpt-obj1-target').value, reward: document.getElementById('rpt-obj1-reward').value, agent: document.getElementById('rpt-obj1-agent').value },
            { target: document.getElementById('rpt-obj2-target').value, reward: document.getElementById('rpt-obj2-reward').value, agent: document.getElementById('rpt-obj2-agent').value },
            { target: document.getElementById('rpt-obj3-target').value, reward: document.getElementById('rpt-obj3-reward').value, agent: document.getElementById('rpt-obj3-agent').value }
        ].filter(o => o.target)
    };

    const btn = document.querySelector('#form-report .btn-send');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';

    try {
        const res = await fetch(`/api/character/${charId}/send-report`, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify(reportData)
        });

        if (!res.ok) {
            const errorData = await res.json();
            if (res.status === 409) {
                 alert(errorData.message || '您已提交过报告，无法重复提交');
            } else {
                alert(errorData.message || '提交失败，请稍后重试');
            }
            return;
        } else {
            // 提交成功！显示弹窗并设置延时关闭
            const modal = document.getElementById('reportSuccessModal');
            if (modal) {
                modal.classList.add('show');
                
                // 设置一个 2.5 秒的计时器，之后自动调用关闭函数
                setTimeout(() => {
                    closeSuccessModal();
                }, 2500); 
            }
        }
    } catch (e) {
        showToast(e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> 提交报告';
    }
}

async function sendMail() {
    const recipient = document.getElementById('mail-recipient').value;
    const subject = document.getElementById('mail-subject').value.trim();
    const content = document.getElementById('mail-content').value.trim();

    if (!recipient) {
        showToast('请选择收件人', 'error');
        return;
    }
    if (!subject) {
        showToast('请输入邮件主题', 'error');
        return;
    }
    if (!content) {
        showToast('请输入邮件内容', 'error');
        return;
    }

    const [type, id] = recipient.split(':');

    const btn = document.querySelector('#form-mail .btn-send');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 发送中...';

    try {
        const res = await fetch(`/api/character/${charId}/send-mail`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                recipientType: type,
                recipientId: id,
                subject,
                content
            })
        });

        if (!res.ok) throw new Error('发送失败');

        showToast('邮件已发送', 'success');
        document.getElementById('mail-subject').value = '';
        document.getElementById('mail-content').value = '';
        // 刷新已发邮件列表
        loadMailbox();
    } catch (e) {
        showToast('发送失败: ' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> 发送';
    }
}

function renderHighwallFiles(container) {
    if (mailData.highwallFiles.length === 0) {
        container.innerHTML = '<div class="mail-empty"><i class="fas fa-file-shield"></i><p>暂无授权的高墙文件</p></div>';
        return;
    }

    container.innerHTML = '<div class="hw-folder">' + mailData.highwallFiles.map(f => `
        <div class="hw-file" onclick="openHighwallFile('${f.filename}')">
            <i class="fas fa-file-alt"></i>
            <div class="hw-name">${escapeHtmlMail(f.title)}</div>
        </div>
    `).join('') + '</div>';
}

function escapeHtmlMail(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function openHighwallFile(filename) {
    const overlay = document.getElementById('hw-overlay');
    const icon = document.getElementById('hw-icon');
    const text = document.getElementById('hw-text');
    const scanlines = document.getElementById('hw-scanlines');
    const eyeLayer = document.getElementById('hw-eye-layer');
    const eyeIcon = document.getElementById('hw-eye-icon');
    const tentaclesLayer = document.getElementById('hw-tentacles');
    const blackout = document.getElementById('hw-blackout');
    const content = document.getElementById('hw-content');

    // 重置状态
    overlay.classList.remove('active', 'glitch-mode');
    icon.className = 'fas fa-circle-notch fa-spin hw-loader-icon';
    icon.style.color = '';
    icon.style.transform = '';
    text.style.color = '';
    text.style.fontFamily = '';
    text.innerHTML = '访问高墙文件<span class="hw-dots"></span>';
    scanlines.style.display = 'none';
    content.style.display = '';
    eyeLayer.style.opacity = '0';
    eyeIcon.classList.remove('eye-open', 'scared');
    tentaclesLayer.innerHTML = '';
    blackout.classList.remove('active');

    // 阶段 1: 伪装 (0s - 1.0s)
    overlay.classList.add('active');

    // 阶段 2: 故障 (1.0s)
    setTimeout(() => {
        icon.classList.remove('fa-spin');
        icon.style.transform = 'rotate(160deg)';

        setTimeout(() => {
            icon.className = 'fas fa-exclamation-triangle hw-loader-icon';
            icon.style.color = '#ff0000';
            text.style.color = '#ff0000';
            text.style.fontFamily = 'monospace';
            text.innerHTML = 'SYSTEM FAILURE /// 0xFF';
            overlay.classList.add('glitch-mode');
            scanlines.style.display = 'block';
        }, 100);
    }, 1000);

    // 阶段 3: 凝视 (1.5s) - 眼睛在黑暗中睁开
    setTimeout(() => {
        overlay.classList.remove('glitch-mode');
        scanlines.style.display = 'none';
        content.style.display = 'none';

        eyeLayer.style.opacity = '1';

        setTimeout(() => {
            eyeIcon.classList.add('eye-open');
        }, 100);
    }, 1500);

    // 阶段 4: 吞噬 (1.9s) - 触手开始蔓延
    setTimeout(() => {
        eyeIcon.classList.add('scared');

        tentaclesLayer.innerHTML = '';
        const count = 20;
        for (let i = 0; i < count; i++) {
            const div = document.createElement('div');
            div.className = 'tendril';

            const deg = i * (360 / count);
            div.style.setProperty('--r', `${deg}deg`);
            div.style.animationDelay = `${Math.random() * 0.4}s`;

            tentaclesLayer.appendChild(div);

            requestAnimationFrame(() => div.classList.add('creeping'));
        }
    }, 1900);

    // 阶段 5: 熄灭 & 跳转 (2.5s)
    setTimeout(() => {
        blackout.classList.add('active');
        setTimeout(() => {
            // 传递角色卡ID和来源，用于返回和权限筛选
            window.location.href = `documents.html?file=${encodeURIComponent(filename)}&charId=${encodeURIComponent(charId)}&from=sheet`;
        }, 500);
    }, 2500);
}

// ==========================================
// 蓝色眼睛邮件阅读器
// ==========================================
let currentOpenMail = null;

function openMailReader(mailData) {
    currentOpenMail = mailData;

    const overlay = document.getElementById('mail-reader-overlay');
    const subjectEl = document.getElementById('mail-reader-subject');
    const senderEl = document.getElementById('mail-reader-sender');
    const timeEl = document.getElementById('mail-reader-time');
    const bodyEl = document.getElementById('mail-reader-body');
    const actionsEl = document.getElementById('mail-reader-actions');
    const eyeContainer = document.querySelector('.mail-eye-container');

    // 填充内容
    subjectEl.textContent = mailData.subject || '无主题';

    const isOS = mailData.sender === 'OS' || mailData.type === 'hw_auth';
    senderEl.innerHTML = isOS
        ? '<span class="os-badge">OS</span> 系统通知'
        : `<i class="fas fa-user"></i> ${escapeHtmlMail(mailData.sender)}`;

    const date = new Date(mailData.time);
    timeEl.innerHTML = `<i class="fas fa-clock"></i> ${date.toLocaleDateString('zh-CN')} ${date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}`;

    bodyEl.textContent = mailData.content || '';

    // 根据邮件类型设置操作按钮
    if (mailData.type === 'hw_auth' && mailData.hwFilename) {
        actionsEl.innerHTML = `
            <button class="mail-reader-btn secondary" onclick="closeMailReader()">
                <i class="fas fa-times"></i> 关闭
            </button>
            <button class="mail-reader-btn danger" onclick="openHighwallFromMail('${escapeHtmlMail(mailData.hwFilename)}')">
                <i class="fas fa-file-shield"></i> 查看高墙文件
            </button>
        `;
    } else if (mailData.type === 'rating_notice' && mailData.reportId) {
        // 任务初评通知 - 显示接受/申诉按钮
        actionsEl.innerHTML = `
            <button class="mail-reader-btn secondary" onclick="closeMailReader()">
                <i class="fas fa-times"></i> 关闭
            </button>
            <button class="mail-reader-btn success" onclick="acceptRating(${mailData.reportId})">
                <i class="fas fa-check"></i> 接受评级
            </button>
            <button class="mail-reader-btn warning" onclick="showAppealForm(${mailData.reportId})">
                <i class="fas fa-exclamation-triangle"></i> 申诉
            </button>
        `;
    } else {
        actionsEl.innerHTML = `
            <button class="mail-reader-btn secondary" onclick="closeMailReader()">
                <i class="fas fa-check"></i> 关闭
            </button>
        `;
    }

    // 标记已读
    if (mailData.id && (mailData.read === 0 || mailData.read === false)) {
        markMessageRead(mailData.id);
    }

    // 眨眼动画
    eyeContainer.classList.add('mail-eye-blink');
    setTimeout(() => eyeContainer.classList.remove('mail-eye-blink'), 300);

    // 显示覆盖层
    overlay.classList.add('active');
}

function closeMailReader() {
    const overlay = document.getElementById('mail-reader-overlay');
    const eyeContainer = document.querySelector('.mail-eye-container');

    // 眨眼动画
    eyeContainer.classList.add('mail-eye-blink');

    setTimeout(() => {
        overlay.classList.remove('active');
        eyeContainer.classList.remove('mail-eye-blink');
        currentOpenMail = null;
    }, 200);
}

function openHighwallFromMail(filename) {
    closeMailReader();
    setTimeout(() => {
        openHighwallFile(filename);
    }, 300);
}

function openSentMailReader(msgId) {
    const msg = mailData.sent.find(m => m.id == msgId);
    if (!msg) return;

    const overlay = document.getElementById('mail-reader-overlay');
    const subjectEl = document.getElementById('mail-reader-subject');
    const senderEl = document.getElementById('mail-reader-sender');
    const timeEl = document.getElementById('mail-reader-time');
    const bodyEl = document.getElementById('mail-reader-body');
    const actionsEl = document.getElementById('mail-reader-actions');
    const eyeContainer = document.querySelector('.mail-eye-container');

    subjectEl.textContent = msg.subject || '无主题';
    senderEl.innerHTML = `<i class="fas fa-paper-plane" style="color:#3498db;"></i> 发送给: ${escapeHtmlMail(msg.recipientName)}`;

    const date = new Date(msg.createdAt);
    timeEl.innerHTML = `<i class="fas fa-clock"></i> ${date.toLocaleDateString('zh-CN')} ${date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}`;

    bodyEl.textContent = msg.content || '';

    actionsEl.innerHTML = `
        <button class="mail-reader-btn secondary" onclick="closeMailReader()">
            <i class="fas fa-check"></i> 关闭
        </button>
    `;

    eyeContainer.classList.add('mail-eye-blink');
    setTimeout(() => eyeContainer.classList.remove('mail-eye-blink'), 300);

    overlay.classList.add('active');
}

async function markMessageRead(msgId) {
    try {
        await fetch(`/api/character/${charId}/message/${msgId}/read`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        // 更新本地数据
        const msg = mailData.inbox.find(m => m.id === msgId);
        if (msg) msg.read = 1;
        
        // 更新顶部未读图标状态
        const unreadCount = mailData.inbox.filter(m => !m.read).length;
        const mailBtn = document.querySelector('.top-mail-btn');
        const badge = document.getElementById('topMailBadge');

        if (unreadCount > 0) {
            mailBtn.classList.add('has-unread');
            badge.style.display = 'block';
            badge.textContent = unreadCount;
        } else {
            mailBtn.classList.remove('has-unread');
            badge.style.display = 'none';
        }
    } catch (e) {
        console.error('标记已读失败:', e);
    }
}

function openMessage(msgId) {
    // 从收件箱数据中找到消息
    const msg = mailData.inbox.find(m => m.id === msgId);
    if (msg) {
        openMailReader({
            type: msg.messageType || 'mail',
            id: msg.id,
            sender: msg.senderName,
            subject: msg.subject,
            content: msg.content,
            time: msg.createdAt,
            read: msg.read,
            hwFilename: msg.hwFilename,
            reportId: msg.reportId
        });
    }
}

// 接受任务评级
async function acceptRating(reportId) {
    if (!charId || !reportId) return;

    if (!confirm('确定接受此评级吗？')) return;

    try {
        const res = await fetch(`/api/character/${charId}/accept-rating/${reportId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('ta_token')
            }
        });

        const data = await res.json();
        if (data.success) {
            alert(data.message || '已接受评级');
            closeMailReader();
            loadMailbox(); // 刷新邮件
        } else {
            alert(data.message || '操作失败');
        }
    } catch (e) {
        console.error('接受评级失败:', e);
        alert('操作失败');
    }
}

// 显示申诉表单
function showAppealForm(reportId) {
    const actionsEl = document.getElementById('mail-reader-actions');
    actionsEl.innerHTML = `
        <div class="appeal-form">
            <textarea id="appealReasonInput" placeholder="请输入申诉理由..." rows="3" style="width:100%;margin-bottom:10px;padding:8px;border-radius:6px;border:1px solid #555;background:#2a2a2a;color:#fff;resize:none;"></textarea>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <button class="mail-reader-btn secondary" onclick="cancelAppeal(${reportId})">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button class="mail-reader-btn warning" onclick="submitAppeal(${reportId})">
                    <i class="fas fa-paper-plane"></i> 提交申诉
                </button>
            </div>
        </div>
    `;
}

// 取消申诉，恢复原按钮
function cancelAppeal(reportId) {
    const actionsEl = document.getElementById('mail-reader-actions');
    actionsEl.innerHTML = `
        <button class="mail-reader-btn secondary" onclick="closeMailReader()">
            <i class="fas fa-times"></i> 关闭
        </button>
        <button class="mail-reader-btn success" onclick="acceptRating(${reportId})">
            <i class="fas fa-check"></i> 接受评级
        </button>
        <button class="mail-reader-btn warning" onclick="showAppealForm(${reportId})">
            <i class="fas fa-exclamation-triangle"></i> 申诉
        </button>
    `;
}

// 提交申诉
async function submitAppeal(reportId) {
    if (!charId || !reportId) return;

    const reason = document.getElementById('appealReasonInput').value.trim();
    if (!reason) {
        alert('请输入申诉理由');
        return;
    }

    try {
        const res = await fetch(`/api/character/${charId}/appeal-rating/${reportId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('ta_token')
            },
            body: JSON.stringify({ reason })
        });

        const data = await res.json();
        if (data.success) {
            alert(data.message || '申诉已提交');
            closeMailReader();
            loadMailbox(); // 刷新邮件
        } else {
            alert(data.message || '申诉失败');
        }
    } catch (e) {
        console.error('提交申诉失败:', e);
        alert('操作失败');
    }
}

const ATTRS=['专注','欺瞒','活力','共情','主动','坚毅','气场','专业','诡秘'];
function initAttrs(){ const c=document.getElementById('attrs-list');c.innerHTML='';ATTRS.forEach(a=>{ const d=document.createElement('div');d.className='attr-row';d.innerHTML=`<div class="attr-label">${a}</div><input type="text" class="attr-input" data-attr="${a}" value="0"><div class="attr-dots-container"><div class="attr-dots" data-attr="${a}">${Array(9).fill(0).map((_,i)=>`<div class="dot" data-i="${i+1}"></div>`).join('')}</div></div>`;c.appendChild(d); const i=d.querySelector('input');i.oninput=(e)=>renderDots(a,e.target.value);d.querySelectorAll('.dot').forEach(dot=>{dot.onclick=()=>{if(isReadOnly)return;const max=parseInt(i.value)||0,idx=parseInt(dot.dataset.i);if(idx>max)return;if(dot.classList.contains('marked')){dot.classList.remove('marked');dot.classList.add('active');}else{dot.classList.remove('active');dot.classList.add('marked');}}});});}
function renderDots(a,v){const val=parseInt(v)||0;document.querySelectorAll(`.attr-dots[data-attr="${a}"] .dot`).forEach((d,i)=>{if(i<val){if(!d.classList.contains('marked'))d.classList.add('active');}else{d.classList.remove('active','marked');}}); }
function createDelBtn(type){
    return`<button class="btn-del" onclick="deleteCard(this, '${type}')">×</button>`;
}

function deleteCard(btn, type) {
    if(!confirm('确定删除?')) return;
    btn.parentElement.remove();
    updateSlotButtons();
}

// 更新添加按钮状态
function updateSlotButtons() {
    const anomCount = document.querySelectorAll('#list-anom .card').length;
    const realCount = document.querySelectorAll('#list-real .card').length;

    const btnAddAnom = document.querySelector('#view-anom .btn-add');
    const btnAddReal = document.querySelector('#view-real .btn-add');

    if (btnAddAnom) {
        if (anomCount >= SLOT_LIMITS.anomSlots) {
            btnAddAnom.disabled = true;
            btnAddAnom.innerHTML = `<i class="fas fa-lock"></i> 已满 (${anomCount}/${SLOT_LIMITS.anomSlots})`;
            btnAddAnom.style.opacity = '0.5';
            btnAddAnom.style.cursor = 'not-allowed';
        } else {
            btnAddAnom.disabled = false;
            btnAddAnom.innerHTML = `<i class="fas fa-plus"></i> 添加 (${anomCount}/${SLOT_LIMITS.anomSlots})`;
            btnAddAnom.style.opacity = '1';
            btnAddAnom.style.cursor = 'pointer';
        }
    }

    if (btnAddReal) {
        if (realCount >= SLOT_LIMITS.realSlots) {
            btnAddReal.disabled = true;
            btnAddReal.innerHTML = `<i class="fas fa-lock"></i> 已满 (${realCount}/${SLOT_LIMITS.realSlots})`;
            btnAddReal.style.opacity = '0.5';
            btnAddReal.style.cursor = 'not-allowed';
        } else {
            btnAddReal.disabled = false;
            btnAddReal.innerHTML = `<i class="fas fa-plus"></i> 添加 (${realCount}/${SLOT_LIMITS.realSlots})`;
            btnAddReal.style.opacity = '1';
            btnAddReal.style.cursor = 'pointer';
        }
    }
}

function addAnom(d=null, prepend=false, skipCheck=false){
    if (!skipCheck && !d) {
        const currentCount = document.querySelectorAll('#list-anom .card').length;
        if (currentCount >= SLOT_LIMITS.anomSlots) {
            showToast('异常能力槽位已满，请联系经理解锁更多槽位', 'error');
            return;
        }
    }
    const div=document.createElement('div');div.className='card bd-anom';div.innerHTML=`${createDelBtn('anom')}<div class="row-2" style="margin-bottom:10px"><input type="text" class="f-name" placeholder="能力名称"><input type="text" class="f-trig" placeholder="触发器"></div><input type="text" class="f-qual" placeholder="资质" style="margin-bottom:10px"><label class="c-anom">成功时</label><div class="rich-editor f-succ" contenteditable="true"></div><label style="color:#c0392b;margin-top:8px">失败时</label><div class="rich-editor f-fail" contenteditable="true"></div><div style="background:#f9f9f9;padding:10px;border-radius:6px;margin-top:10px;border:1px solid #eee"><div style="display:flex;align-items:center;margin-bottom:6px;gap:10px"><input type="text" class="f-tdesc" placeholder="问题" style="flex:1;margin-bottom:0"><label class="chk-btn chk-trained"><input type="checkbox" class="f-chk"><span></span></label></div><div style="display:flex;gap:8px;align-items:center;margin-bottom:6px"><input type="text" class="f-t1" placeholder="答案1" style="flex:1"><input type="text" class="small-input f-t1-val"><div class="sq-dots d1">${get3Sq()}</div></div><div style="display:flex;gap:8px;align-items:center"><input type="text" class="f-t2" placeholder="答案2" style="flex:1"><input type="text" class="small-input f-t2-val"><div class="sq-dots d2">${get3Sq()}</div></div></div>`; setupSq(div);if(d)fillAnom(div,d);setRandomVars(div); const container = document.getElementById('list-anom'); if(prepend) { container.prepend(div); } else { container.appendChild(div); } if(isReadOnly){div.querySelectorAll('[contenteditable]').forEach(e=>e.setAttribute('contenteditable','false'));}
    updateSlotButtons();
}

function getBonusOptions() {
    let opts = '<option value="" disabled selected>-- 选择连结加成 --</option>';
    if (CONFIG_DATA.bonuses && Array.isArray(CONFIG_DATA.bonuses)) {
        CONFIG_DATA.bonuses.forEach(b => {
            const val = typeof b === 'string' ? b : (b.content || b.name);
            const name = typeof b === 'string' ? b : b.name;
            let displayName = name;
            if (displayName.length > 20) { displayName = displayName.substring(0, 20) + '...'; }
            const safeVal = val.replace(/"/g, '&quot;');
            opts += `<option value="${safeVal}">${displayName}</option>`;
        });
    }
    opts += '<option value="__CUSTOM__">➤ 自定义 / 手动输入...</option>';
    return opts;
}

window.handleBonusChange = function(select) {
    const wrapper = select.parentElement;
    const editor = wrapper.querySelector('.rich-editor');
    const val = select.value;
    wrapper.classList.add('show-input'); 
    if (val === '__CUSTOM__') {
        editor.focus();
    } else {
        editor.innerHTML = val;
    }
};

window.resetBonus = function(btn) {
    const wrapper = btn.parentElement;
    const select = wrapper.querySelector('select');
    wrapper.classList.remove('show-input');
    select.value = ''; 
};

function addReal(d = null, skipCheck = false) {
    if (!skipCheck && !d) {
        const currentCount = document.querySelectorAll('#list-real .card').length;
        if (currentCount >= SLOT_LIMITS.realSlots) {
            showToast('关系网槽位已满，请联系经理解锁更多槽位', 'error');
            return null;
        }
    }
    const div = document.createElement('div');
    div.className = 'card bd-real';
    const bonusOptions = getBonusOptions();
    div.innerHTML = `${createDelBtn('real')}<div class="row-2" style="margin-bottom:10px"><input type="text" class="f-name" placeholder="姓名"><input type="text" class="f-actor" placeholder="扮演者"></div><div class="rich-editor f-desc" contenteditable="true" placeholder="描述" style="margin-bottom:10px"></div><label>连结进度</label><div class="rel-row"><div class="sq-dots r-dots">${get9Dots()}</div><label class="chk-btn"><input type="checkbox" class="f-act"><span></span></label></div><label>连结加成</label><div class="hybrid-input-wrapper has-editor"><select class="f-conn-sel" onchange="handleBonusChange(this)">${bonusOptions}</select><div class="rich-editor f-conn" contenteditable="true" placeholder="选择预设或输入加成效果..."></div><button class="btn-reset-list" onclick="resetBonus(this)"><i class="fas fa-list"></i></button></div>`;
    setupRDots(div);
    if (d) fillReal(div, d);
    setRandomVars(div);
    if (isReadOnly) {
        div.querySelectorAll('[contenteditable]').forEach(e => e.setAttribute('contenteditable', 'false'));
        div.querySelector('.hybrid-input-wrapper').classList.add('show-input');
    }
    setTimeout(updateSlotButtons, 0);
    return div;
}

function addItem(d=null, prepend=false){const div=document.createElement('div');div.className='card bd-func';div.innerHTML=`${createDelBtn('item')}<div class="row-2" style="margin-bottom:10px"><input type="text" class="f-item" placeholder="物品名称"><input type="text" class="f-pd" placeholder="页面/PD码"></div><label>效果</label><div class="rich-editor f-eff" contenteditable="true"></div>`;if(d){div.querySelector('.f-item').value=d.item||'';div.querySelector('.f-pd').value=d.pd||'';div.querySelector('.f-eff').innerHTML=d.eff||'';}setRandomVars(div); const container = document.getElementById('list-item'); if(prepend) { container.prepend(div); } else { container.appendChild(div); } if(isReadOnly){div.querySelectorAll('[contenteditable]').forEach(e=>e.setAttribute('contenteditable','false'));}}

function get3Sq(){return` <div class="sq-dot"></div><div class="sq-dot"></div><div class="sq-dot"></div> `;}
function get9Dots(){return Array(9).fill(0).map((_,i)=>`<div class="dot" data-i="${i+1}"></div>`).join('');}
function setupSq(div){div.querySelectorAll('.sq-dot').forEach(d=>d.onclick=()=>{if(!isReadOnly)d.classList.toggle('active');});}

function addRealSafe() {
    const card = addReal(null, false);
    if (card) {
        document.getElementById('list-real').appendChild(card);
    }
}
function setupRDots(div){const d=div.querySelectorAll('.r-dots .dot');d.forEach(dot=>{dot.onclick=()=>{if(isReadOnly)return;const idx=parseInt(dot.dataset.i);d.forEach((dd,i)=>{if(i<idx)dd.classList.add('active');else dd.classList.remove('active');});}});}
function fillAnom(div,d){div.querySelector('.f-name').value=d.name||'';div.querySelector('.f-trig').value=d.trig||'';div.querySelector('.f-qual').value=d.qual||'';div.querySelector('.f-succ').innerHTML=d.succ||'';div.querySelector('.f-fail').innerHTML=d.fail||'';if(d.chk)div.querySelector('.f-chk').checked=d.chk;if(d.tdesc)div.querySelector('.f-tdesc').value=d.tdesc;if(d.t1)div.querySelector('.f-t1').value=d.t1;if(d.t1v)div.querySelector('.f-t1-val').value=d.t1v;if(d.t2)div.querySelector('.f-t2').value=d.t2;if(d.t2v)div.querySelector('.f-t2-val').value=d.t2v;if(d.p1)div.querySelectorAll('.d1 .sq-dot').forEach((e,i)=>{if(d.p1[i])e.classList.add('active')});if(d.p2)div.querySelectorAll('.d2 .sq-dot').forEach((e,i)=>{if(d.p2[i])e.classList.add('active')});}

function fillReal(div, d) {
    div.querySelector('.f-name').value = d.name;
    div.querySelector('.f-actor').value = d.actor;
    div.querySelector('.f-desc').innerHTML = d.desc;
    div.querySelector('.f-act').checked = d.act;
    const connEditor = div.querySelector('.f-conn');
    const connWrapper = div.querySelector('.hybrid-input-wrapper');
    connEditor.innerHTML = d.conn;
    if (d.conn !== undefined && d.conn !== null) {
        connWrapper.classList.add('show-input');
        div.querySelector('.f-conn-sel').value = '__CUSTOM__'; 
    }
    div.querySelectorAll('.r-dots .dot').forEach((e, i) => {
        if (i < d.lvl) e.classList.add('active')
    });
}

document.querySelectorAll('.p-cell').forEach(c=>{c.addEventListener('click',()=>{if(isReadOnly)return;if(c.classList.contains('active')){c.classList.remove('active');c.classList.add('ignored');}else if(c.classList.contains('ignored')){c.classList.remove('ignored');}else{c.classList.add('active');}});c.addEventListener('contextmenu',(e)=>{e.preventDefault();if(isReadOnly)return;c.classList.remove('active');c.classList.add('ignored');});});
function populateData(d){
    SLOT_LIMITS.anomSlots = d.anomSlots || 3;
    SLOT_LIMITS.realSlots = d.realSlots || 3;
    ['pName','pTrig1','pTrig2','pTrig3','perm1','perm2','perm3','pComm','pRep','mvpCount','watchCount','noteTitle','noteBody'].forEach(id=>{const e=document.getElementById(id);if(d[id]&&e){if(e.tagName==='DIV')e.innerHTML=d[id];else e.value=d[id];}});
	    document.getElementById('mvpCount').value = d.mvpCount || (d.rewards || []).reduce((sum, r) => sum + (r.count || 1), 0);
    document.getElementById('watchCount').value = d.watchCount || (d.reprimands || []).reduce((sum, r) => sum + (r.count || 1), 0);
	setHybridInputState('pAnom',d.pAnom);setHybridInputState('pReal',d.pReal);setHybridInputState('pFunc',d.pFunc);if(d.qs)d.qs.forEach((h,i)=>{const q=document.getElementById(`q${i+1}`);if(q)q.innerHTML=h;});if(d.attrs){for(let k in d.attrs){const r=document.querySelector(`.attr-input[data-attr="${k}"]`);if(r){r.value=d.attrs[k].v;renderDots(k,d.attrs[k].v);const dots=r.parentElement.querySelectorAll('.dot');d.attrs[k].m.forEach(idx=>{if(dots[idx-1]){dots[idx-1].classList.remove('active');dots[idx-1].classList.add('marked');}});}}}document.getElementById('list-anom').innerHTML='';document.getElementById('list-real').innerHTML='';document.getElementById('list-item').innerHTML='';
    (d.anoms||[]).forEach(x=>addAnom(x, false, true));
    (d.reals||[]).forEach(x=>{const card = addReal(x, true); if(card) document.getElementById('list-real').appendChild(card);});
    (d.items||[]).forEach(x=>addItem(x, false));
    if(!document.getElementById('list-anom').children.length)addAnom(null, false, true);
    if(!document.getElementById('list-real').children.length){const card = addReal(null, true); if(card) document.getElementById('list-real').appendChild(card);}
    if(!document.getElementById('list-item').children.length)addItem(null, false);
    (d.pf||[]).forEach(i=>document.querySelector(`.f-cell[data-idx="${i}"]`)?.classList.add('active'));(d.pr||[]).forEach(i=>document.querySelector(`.r-cell[data-idx="${i}"]`)?.classList.add('active'));(d.pa||[]).forEach(i=>document.querySelector(`.a-cell[data-idx="${i}"]`)?.classList.add('active'));(d.pf_ign||[]).forEach(i=>document.querySelector(`.f-cell[data-idx="${i}"]`)?.classList.add('ignored'));(d.pr_ign||[]).forEach(i=>document.querySelector(`.r-cell[data-idx="${i}"]`)?.classList.add('ignored'));(d.pa_ign||[]).forEach(i=>document.querySelector(`.a-cell[data-idx="${i}"]`)?.classList.add('ignored'));
    updateSlotButtons();

    // 处理发信权限
    canSendMessages = d.canSendMessages !== false; // 默认允许发信
    const composeTab = document.getElementById('tab-compose');
    if (composeTab) {
        composeTab.style.display = canSendMessages ? '' : 'none';
    }
}
function gatherData(){const d={pName:document.getElementById('pName').value,pAnom:document.getElementById('pAnom').value,pReal:document.getElementById('pReal').value,pFunc:document.getElementById('pFunc').value,pTrig1:document.getElementById('pTrig1').innerHTML,pTrig2:document.getElementById('pTrig2').innerHTML,pTrig3:document.getElementById('pTrig3').innerHTML,perm1:document.getElementById('perm1').value,perm2:document.getElementById('perm2').value,perm3:document.getElementById('perm3').value,pComm:document.getElementById('pComm').value,pRep:document.getElementById('pRep').value,mvpCount:document.getElementById('mvpCount').value,watchCount:document.getElementById('watchCount').value,noteTitle:document.getElementById('noteTitle').value,noteBody:document.getElementById('noteBody').innerHTML,qs:[],attrs:{},anoms:[],reals:[],items:[],pf:[],pr:[],pa:[],pf_ign:[],pr_ign:[],pa_ign:[],anomSlots:SLOT_LIMITS.anomSlots,realSlots:SLOT_LIMITS.realSlots};for(let i=1;i<=7;i++)d.qs.push(document.getElementById(`q${i}`).innerHTML);ATTRS.forEach(a=>{const r=document.querySelector(`.attr-input[data-attr="${a}"]`).parentElement,m=[];r.querySelectorAll('.dot.marked').forEach(dt=>m.push(parseInt(dt.dataset.i)));d.attrs[a]={v:r.querySelector('input').value,m:m};});document.querySelectorAll('#list-anom .card').forEach(c=>{d.anoms.push({name:c.querySelector('.f-name').value,trig:c.querySelector('.f-trig').value,qual:c.querySelector('.f-qual').value,succ:c.querySelector('.f-succ').innerHTML,fail:c.querySelector('.f-fail').innerHTML,chk:c.querySelector('.f-chk').checked,tdesc:c.querySelector('.f-tdesc').value,t1:c.querySelector('.f-t1').value,t1v:c.querySelector('.f-t1-val').value,t2:c.querySelector('.f-t2').value,t2v:c.querySelector('.f-t2-val').value,p1:Array.from(c.querySelectorAll('.d1 .sq-dot')).map(e=>e.classList.contains('active')),p2:Array.from(c.querySelectorAll('.d2 .sq-dot')).map(e=>e.classList.contains('active'))});});document.querySelectorAll('#list-real .card').forEach(c=>{let l=0;c.querySelectorAll('.r-dots .dot').forEach((e,i)=>{if(e.classList.contains('active'))l=i+1});d.reals.push({name:c.querySelector('.f-name').value,actor:c.querySelector('.f-actor').value,desc:c.querySelector('.f-desc').innerHTML,act:c.querySelector('.f-act').checked,conn:c.querySelector('.f-conn').innerHTML,lvl:l});});document.querySelectorAll('#list-item .card').forEach(c=>{d.items.push({item:c.querySelector('.f-item').value,pd:c.querySelector('.f-pd').value,eff:c.querySelector('.f-eff').innerHTML});});document.querySelectorAll('.f-cell.active').forEach(e=>d.pf.push(parseInt(e.dataset.idx)));document.querySelectorAll('.r-cell.active').forEach(e=>d.pr.push(parseInt(e.dataset.idx)));document.querySelectorAll('.a-cell.active').forEach(e=>d.pa.push(parseInt(e.dataset.idx)));document.querySelectorAll('.f-cell.ignored').forEach(e=>d.pf_ign.push(parseInt(e.dataset.idx)));document.querySelectorAll('.r-cell.ignored').forEach(e=>d.pr_ign.push(parseInt(e.dataset.idx)));document.querySelectorAll('.a-cell.ignored').forEach(e=>d.pa_ign.push(parseInt(e.dataset.idx)));return d;}
function showToast(msg, type='success') {
    const m = document.getElementById('status-msg');
    m.innerHTML = type === 'error' ? `<i class="fas fa-exclamation-circle"></i> ${msg}` : `<i class="fas fa-save"></i> ${msg}`;
    m.className = type === 'error' ? 'error' : 'success';
    m.style.display = 'block';
    setTimeout(() => m.style.display = 'none', 2500);
}
async function saveData(silent=false){if(isReadOnly)return;const d=gatherData();const res=await fetch(`/api/character/${charId}`,{method:'PUT',headers:getAuthHeaders(),body:JSON.stringify(d)});if(res.ok){if(!silent){showToast('DATA_SAVED', 'success');}}else if(res.status===401||res.status===403){window.location.href='login.html';}else{showToast('保存失败', 'error');}}
function exportOffline(){const d=gatherData();let h=document.documentElement.outerHTML;h=h.replace(/<script id="__SAVED_DATA__" type="application\/json">.*?<\/script>/s,`<script id="__SAVED_DATA__" type="application/json">${JSON.stringify(d)}<\/script>`);const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([h],{type:'text/html'}));a.download=`${d.pName||'角色'}_离线备份.html`;a.click();}

function exportJson() {
    const data = gatherData();
    const name = data.pName ? data.pName.replace(/\s+/g, '_') : 'character';
    const fileName = `${name}_data.json`;
    const jsonStr = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('JSON 数据已导出');
}

function triggerImport() {
    if (document.body.classList.contains('readonly-mode')) {
        alert('只读模式下无法导入数据');
        return;
    }
    if(!confirm('警告：导入 JSON 将完全覆盖当前页面上的所有内容！\n确定要继续吗？')) {
        return;
    }
    document.getElementById('jsonInput').click();
}

function handleImportJson(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if (typeof data !== 'object' || (!data.pName && !data.anoms)) {
                throw new Error("无效的角色数据格式");
            }
            populateData(data);
            showToast('数据导入成功', 'success');
        } catch (err) {
            console.error(err);
            alert('导入失败：文件格式错误或数据损坏');
        }
    };
    reader.readAsText(file);
    input.value = '';
}

// 嘉奖/申诫历史记录功能
let cachedRecords = null;

async function showRecordHistory(type) {
    const modal = document.getElementById('recordHistoryModal');
    const titleEl = document.getElementById('recordHistoryTitle');
    const contentEl = document.getElementById('recordHistoryContent');

    titleEl.textContent = type === 'reward' ? '嘉奖记录' : '申诫记录';
    contentEl.innerHTML = '<div class="record-empty"><i class="fas fa-circle-notch fa-spin"></i> 加载中...</div>';
    modal.style.display = 'flex';

    try {
        // 如果已有缓存且不需要重新加载
        if (!cachedRecords && charId) {
            const res = await fetch(`/api/character/${charId}/records`, {
                headers: getAuthHeaders()
            });
            if (res.ok) {
                cachedRecords = await res.json();
            }
        }

        let records = type === 'reward'
            ? (cachedRecords?.rewards || [])
            : (cachedRecords?.reprimands || []);

        // 确保 records 是数组（可能因为旧数据是数字）
        if (!Array.isArray(records)) {
            records = [];
        }

        if (records.length === 0) {
            contentEl.innerHTML = `<div class="record-empty">暂无${type === 'reward' ? '嘉奖' : '申诫'}记录</div>`;
            return;
        }

        // 按时间倒序
        const sorted = [...records].sort((a, b) => (b.date || 0) - (a.date || 0));

        contentEl.innerHTML = sorted.map(r => {
            const date = r.date ? new Date(r.date).toLocaleString('zh-CN', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            }) : '未知时间';
            const countBadge = (r.count && r.count > 1)
                ? `<span class="record-count-badge ${type === 'reprimand' ? 'reprimand' : ''}">x${r.count}</span>`
                : '';
            return `
                <div class="record-entry ${type === 'reprimand' ? 'reprimand' : ''}">
                    <div class="record-reason">${escapeHtmlText(r.reason || '无原因')}${countBadge}</div>
                    <div class="record-meta">
                        <i class="fas fa-clock"></i> ${date}
                        ${r.addedByName ? `&nbsp;&nbsp;<i class="fas fa-user-tie"></i> ${escapeHtmlText(r.addedByName)}` : ''}
                    </div>
                </div>
            `;
        }).join('');
    } catch (e) {
        console.error('加载记录失败:', e);
        contentEl.innerHTML = '<div class="record-empty" style="color:#e74c3c;">加载失败</div>';
    }
}

function closeRecordHistory() {
    document.getElementById('recordHistoryModal').style.display = 'none';
}

function escapeHtmlText(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

</script>
<!-- 嘉奖/申诫历史记录弹窗 -->
<div id="recordHistoryModal" class="record-history-modal" style="display:none;">
    <div class="record-history-overlay" onclick="closeRecordHistory()"></div>
    <div class="record-history-box">
        <div class="record-history-header">
            <h3 id="recordHistoryTitle">记录历史</h3>
            <button class="btn-close-history" onclick="closeRecordHistory()">&times;</button>
        </div>
        <div class="record-history-content" id="recordHistoryContent">
            <!-- 历史记录将在此动态生成 -->
        </div>
    </div>
</div>
<style>
    .record-history-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .record-history-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); }
    .record-history-box { position: relative; background: #2c3e50; border-radius: 8px; width: 90%; max-width: 400px; max-height: 70vh; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .record-history-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .record-history-header h3 { margin: 0; color: white; font-size: 16px; }
    .btn-close-history { background: none; border: none; color: rgba(255,255,255,0.6); font-size: 24px; cursor: pointer; padding: 0; line-height: 1; }
    .btn-close-history:hover { color: white; }
    .record-history-content { padding: 15px 20px; overflow-y: auto; max-height: calc(70vh - 60px); }
    .record-entry { background: rgba(255,255,255,0.05); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #27ae60; }
    .record-entry.reprimand { border-left-color: #e74c3c; }
    .record-reason { color: white; font-size: 14px; margin-bottom: 8px; }
    .record-count-badge { display: inline-block; background: #27ae60; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-left: 6px; }
    .record-count-badge.reprimand { background: #e74c3c; }
    .record-meta { font-size: 11px; color: rgba(255,255,255,0.5); }
    .record-meta i { margin-right: 4px; }
    .record-empty { text-align: center; padding: 30px 20px; color: rgba(255,255,255,0.5); }
/* =========================================
   报告提交成功 - 动态红勾动画样式 (V2.2)
   ========================================= */
.transition-overlay { 
    position: fixed; top: 0; left: 0; 
    width: 100vw; height: 100vh; 
    background: #0f172a; 
    z-index: 6000;
    clip-path: inset(50% 0 50% 0); 
    pointer-events: none;
    transition: clip-path 0.8s cubic-bezier(0.8, 0, 0.2, 1); 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center; 
}
.transition-overlay.active { 
    pointer-events: all; 
    clip-path: inset(0 0 0 0); 
}
.transition-overlay::before { 
    content: ''; position: absolute; top: 50%; left: 0; 
    width: 100%; height: 2px; background: var(--signal-red); 
    z-index: 100; box-shadow: 0 0 15px var(--signal-red); 
    opacity: 0; transition: opacity 0.2s; 
}
.transition-overlay.active::before { 
    opacity: 1; animation: line-fade 0.8s forwards; 
}
@keyframes line-fade { 
    0% { opacity: 1; transform: scaleX(0.1); } 
    50% { opacity: 1; transform: scaleX(1); } 
    100% { opacity: 0; transform: scaleX(1); } 
}
.transition-overlay .loader-content { 
    text-align: center; color: var(--signal-red); 
    opacity: 0; transform: scale(0.9); 
    transition: all 0.4s ease 0.2s; 
}
.transition-overlay.active .loader-content { 
    opacity: 1; transform: scale(1); 
}
.transition-overlay .loader-text { 
    font-family: "Noto Sans SC", sans-serif; 
    font-size: 16px; letter-spacing: 2px; font-weight: 900; 
    display: flex; align-items: center; justify-content: center; 
}
.transition-overlay .dots::after { 
    content: ''; width: 1.5em; text-align: left; 
    display: inline-block; animation: dot-steps 1.5s infinite steps(4, end); 
}
@keyframes dot-steps { 
    0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80%, 100% { content: '...'; } 
}

/* --- SVG 动态红勾动画 --- */
.success-icon-wrapper { 
    width: 80px; 
    height: 80px; 
    margin: 0 auto 20px; /* 调整与文字的间距 */
}
.checkmark { 
    width: 100%; height: 100%; 
    display: block; 
    stroke-width: 2.5; 
    stroke-miterlimit: 10; 
}
.checkmark__circle {
    stroke-dasharray: 166; stroke-dashoffset: 166;
    stroke-width: 2.5; fill: none;
    /* 关键修改：圆圈也使用红色 */
    stroke: var(--signal-red);
    animation: stroke 0.8s cubic-bezier(0.65, 0, 0.45, 1) forwards;
}
.checkmark__check {
    transform-origin: 50% 50%;
    stroke-dasharray: 48; stroke-dashoffset: 48;
    /* 关键修改：对勾使用红色 */
    stroke: var(--signal-red);
    animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
}
@keyframes stroke {
    100% { stroke-dashoffset: 0; }
}

/* =========================================
   任务报告提交成功 - 动态弹窗样式 (V2.1 - 自动消失)
   ========================================= */
.success-modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(15, 23, 42, 0.8);
    backdrop-filter: blur(5px);
    z-index: 6000;
    display: none;
    align-items: center; justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}
.success-modal-overlay.show {
    display: flex;
    opacity: 1;
}

.success-modal-box {
    background: rgba(15, 25, 45, 0.95);
    border: 1px solid rgba(192, 57, 43, 0.3);
    padding: 30px 40px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 0 40px rgba(192, 57, 43, 0.2), inset 0 0 20px rgba(192, 57, 43, 0.1);
    transform: scale(0.8) translateY(20px);
    opacity: 0;
    animation: success-swoop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}
@keyframes success-swoop-in {
    to { transform: scale(1) translateY(0); opacity: 1; }
}

.success-modal-box h3 {
    margin: 20px 0 5px; font-size: 18px; font-weight: 700;
    color: #e0f0ff; letter-spacing: 1px;
}
/* 关键修改：移除了p标签的下边距 */
.success-modal-box p {
    margin: 0; font-size: 13px; color: #6090b0;
}

/* --- SVG 动画样式 --- */
.success-modal-icon { width: 80px; height: 80px; margin: 0 auto; }
.checkmark { width: 100%; height: 100%; display: block; stroke-width: 2.5; stroke-miterlimit: 10; }
.checkmark__circle {
    stroke-dasharray: 166; stroke-dashoffset: 166;
    stroke-width: 2.5; fill: none;
    /* 修改：将描边从渐变改为红色变量 */
    stroke: var(--signal-red); 
    animation: stroke 0.8s cubic-bezier(0.65, 0, 0.45, 1) forwards;
}
.checkmark__check {
    transform-origin: 50% 50%;
    stroke-dasharray: 48; stroke-dashoffset: 48;
    /* 保持红色 */
    stroke: var(--signal-red); 
    animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
}
@keyframes stroke {
    100% { stroke-dashoffset: 0; }
}

</style>
<div class="nav-arrow arrow-left" onclick="moveTab(-1)"><i class="fas fa-caret-left"></i></div>
<div class="nav-arrow arrow-right" onclick="moveTab(1)"><i class="fas fa-caret-right"></i></div>

<!-- =========================================
     报告提交成功 
     ========================================= -->
<div id="reportSuccessModal" class="success-modal-overlay">
    <div class="success-modal-box">
        <div class="success-modal-icon">
            <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                <defs>
                    <linearGradient id="gradient-circle" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#3498db; stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#c0392b; stop-opacity:1" />
                    </linearGradient>
                </defs>
                <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
        </div>
        <h3>任务报告已提交</h3>
    </div>
</div>
</body>
</html>
