<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜å¢™æ¡£æ¡ˆåº“ // PLAYWALLED DOCUMENTS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --deep-bg: #0f172a;
            --sidebar-bg: #1e293b;
            --text-main: #e2e8f0;
            --accent: #d50000;
            --locked: #475569;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            font-family: "Roboto Mono", "Noto Sans SC", sans-serif;
            background: var(--deep-bg);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 300px;
            background: var(--sidebar-bg);
            border-right: 1px solid #334155;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 10;
            transition: transform 0.3s ease;
        }
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #334155;
            background: #0b1120;
            flex-shrink: 0;
        }
        .brand { font-size: 18px; font-weight: 900; letter-spacing: 2px; color: white; }
        .brand span { color: var(--accent); }
        .back-btn {
            display: inline-block; margin-top: 10px; font-size: 12px; 
            color: #94a3b8; text-decoration: none; cursor: pointer;
            padding: 5px 0;
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            -webkit-overflow-scrolling: touch;
        }
        .file-item {
            padding: 15px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255,255,255,0.02);
            border: 1px solid transparent;
            font-size: 14px;
        }
        .file-item:active { background: rgba(255,255,255,0.1); }
        .file-item.active { background: var(--accent); color: white; border-color: var(--accent); }
        .file-item.locked { opacity: 0.5; }

        /* é˜…è¯»å™¨ */
        .reader {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-image: radial-gradient(#334155 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
            z-index: 5;
            width: 100%;
        }

        .mobile-nav {
            display: none;
            padding: 15px;
            background: var(--sidebar-bg);
            border-bottom: 1px solid #334155;
            align-items: center;
            gap: 10px;
        }
        .btn-close {
            background: transparent; border: 1px solid #475569; color: #cbd5e1;
            padding: 6px 12px; border-radius: 4px; font-size: 12px;
        }

        .doc-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }
        .markdown-body { 
            max-width: 800px; margin: 0 auto; 
            background: rgba(30, 41, 59, 0.95);
            padding: 25px; border-radius: 8px;
            min-height: 50vh;
        }

        /* Markdown åŸºç¡€æ ·å¼ (é˜²æ­¢CDNåŠ è½½å¤±è´¥æ—¶æ²¡æ ·å¼) */
        .markdown-body h1 { border-bottom: 1px solid #444; padding-bottom: 10px; color: white; font-size: 1.5em; }
        .markdown-body p { line-height: 1.6; color: #ccc; margin-bottom: 1em; }
        .markdown-body pre { background: #111; padding: 10px; overflow-x: auto; border-radius: 4px; }
        .markdown-body code { background: #222; padding: 2px 5px; font-family: monospace; }
        .markdown-body a { color: var(--accent); }

        /* é”™è¯¯æç¤ºæ ·å¼ */
        .error-box {
            padding: 20px;
            text-align: center;
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            margin: 20px;
            font-size: 13px;
        }
        .btn-retry {
            margin-top: 10px;
            padding: 8px 16px;
            background: var(--sidebar-bg);
            border: 1px solid #475569;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        /* ========== A1 ä»»åŠ¡æŠ¥å‘Šè¡¨å•æ ·å¼ ========== */
        .report-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 20px;
        }
        .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #334155;
        }
        .report-header h1 {
            color: #e67e22;
            font-size: 24px;
            margin: 0 0 10px 0;
        }
        .report-header p {
            color: #94a3b8;
            font-size: 13px;
            margin: 0;
        }
        .report-section {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .report-section h3 {
            color: #f1c40f;
            font-size: 14px;
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 1px dashed #475569;
        }
        .report-status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .report-status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .report-status-item:hover { background: rgba(0,0,0,0.4); }
        .report-status-item input[type="checkbox"] {
            width: 18px; height: 18px;
            accent-color: #e67e22;
        }
        .report-status-item .status-icon { font-size: 22px; }
        .report-status-item .status-info h4 { margin: 0; font-size: 13px; color: #e2e8f0; }
        .report-status-item .status-info small { color: #64748b; font-size: 11px; }
        .report-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        .report-row label {
            width: 80px;
            flex-shrink: 0;
            font-size: 13px;
            color: #94a3b8;
        }
        .report-row input, .report-row textarea {
            flex: 1;
            padding: 10px 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid #475569;
            border-radius: 4px;
            color: #e2e8f0;
            font-size: 13px;
        }
        .report-row input:focus, .report-row textarea:focus {
            outline: none;
            border-color: #e67e22;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
        }
        .report-table th {
            text-align: left;
            padding: 8px;
            color: #94a3b8;
            font-size: 12px;
            font-weight: normal;
            border-bottom: 1px solid #475569;
        }
        .report-table td {
            padding: 8px;
        }
        .report-table input {
            width: 100%;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border: 1px solid #475569;
            border-radius: 4px;
            color: #e2e8f0;
            font-size: 12px;
        }
        .report-table input:focus {
            outline: none;
            border-color: #e67e22;
        }
        .btn-submit-report {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #e67e22, #d35400);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-submit-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(230, 126, 34, 0.4);
        }
        .btn-submit-report:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .report-toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            transition: transform 0.3s;
        }
        .report-toast.show { transform: translateX(-50%) translateY(0); }
        .report-toast.success { background: #27ae60; color: white; }
        .report-toast.error { background: #e74c3c; color: white; }

        /* ========== A1 åªè¯»æ¨¡å¼æ ·å¼ ========== */
        .report-readonly-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 30px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            color: #333;
        }
        .report-readonly-container .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e67e22;
        }
        .report-readonly-container .report-header h1 {
            color: #e67e22;
            font-size: 24px;
            margin: 0 0 10px 0;
        }
        .report-readonly-container .report-header p {
            color: #666;
            font-size: 14px;
            margin: 0;
        }
        .report-readonly-container .readonly-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .report-readonly-container .readonly-section h3 {
            color: #d35400;
            font-size: 15px;
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ddd;
        }
        .report-readonly-container .readonly-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .report-readonly-container .readonly-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
        }
        .report-readonly-container .readonly-item .status-icon { font-size: 22px; }
        .report-readonly-container .readonly-item .status-info h4 { margin: 0; font-size: 13px; color: #333; }
        .report-readonly-container .readonly-item .status-info small { color: #888; font-size: 11px; }
        .report-readonly-container .readonly-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 4px;
        }
        .report-readonly-container .readonly-row label {
            width: 80px;
            flex-shrink: 0;
            font-size: 13px;
            color: #666;
            font-weight: 500;
        }
        .report-readonly-container .readonly-row span {
            flex: 1;
            color: #999;
            font-size: 13px;
        }
        .report-readonly-container .readonly-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 4px;
            overflow: hidden;
        }
        .report-readonly-container .readonly-table th {
            text-align: left;
            padding: 10px;
            color: #666;
            font-size: 12px;
            font-weight: 500;
            background: #f1f3f4;
            border-bottom: 1px solid #e9ecef;
        }
        .report-readonly-container .readonly-table td {
            padding: 10px;
            font-size: 12px;
            color: #999;
            border-bottom: 1px solid #f1f3f4;
        }
        .report-readonly-container .readonly-notice {
            margin-top: 20px;
            padding: 15px;
            background: #fff8e1;
            border: 1px solid #ffe082;
            border-radius: 8px;
            text-align: center;
            color: #f57c00;
            font-size: 13px;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; height: 100%; }
            .reader { position: absolute; width: 100%; height: 100%; transform: translateX(100%); transition: transform 0.3s ease; }
            .mobile-nav { display: flex; }
            
            /* é˜…è¯»æ¨¡å¼æ¿€æ´» */
            body.reading-mode .sidebar { transform: translateX(-30%); opacity: 0; pointer-events: none; }
            body.reading-mode .reader { transform: translateX(0); }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <div class="brand">PLAY<span>WALLED</span></div>
        <div onclick="goBack()" class="back-btn">
            <i class="fas fa-chevron-left"></i> <span id="backText">è¿”å›ç»ˆç«¯é¦–é¡µ</span>
        </div>
    </div>
    <div class="file-list" id="fileList">
        <div style="padding:40px; text-align:center; color:#64748b;">
            <i class="fas fa-circle-notch fa-spin" style="font-size:24px; margin-bottom:10px;"></i>
            <div>è¿æ¥é«˜å¢™æ•°æ®åº“...</div>
        </div>
    </div>
</div>

<div class="reader">
    <div class="mobile-nav">
        <button class="btn-close" onclick="closeReader()">
            <i class="fas fa-arrow-left"></i> è¿”å›åˆ—è¡¨
        </button>
        <div style="font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" id="mobileTitle">æ–‡æ¡£é¢„è§ˆ</div>
    </div>
    <div class="doc-container">
        <div class="markdown-body" id="docContent">
            <div style="text-align:center; padding-top:50px; color:#64748b;">
                <i class="fas fa-file-contract" style="font-size:48px; opacity:0.2;"></i>
                <p>è¯·é€‰æ‹©æ–‡ä»¶</p>
            </div>
        </div>
    </div>
</div>

<!-- Toast æç¤º -->
<div id="reportToast" class="report-toast"></div>

<!-- å¼‚æ­¥åŠ è½½ Markedï¼Œé˜²æ­¢é˜»å¡é¡µé¢ -->
<script src="/js/marked.min.js"></script>

<script>
    const token = localStorage.getItem('ta_token');
    const params = new URLSearchParams(window.location.search);
    const charId = params.get('charId');  // ä»é‚®ç®±è¿›å…¥æ—¶ä¼ é€’çš„è§’è‰²å¡ID
    const fromSheet = params.get('from') === 'sheet';  // æ˜¯å¦ä»è§’è‰²å¡é‚®ç®±è¿›å…¥
    const fileToOpen = params.get('file');  // ç›´æ¥æ‰“å¼€çš„æ–‡ä»¶

    // 1. å¼ºåˆ¶ç™»å½•æ£€æŸ¥
    if (!token) {
        alert("æœªæ£€æµ‹åˆ°èº«ä»½ä»¤ç‰Œï¼Œè¯·é‡æ–°ç™»å½•");
        window.location.href = 'login.html';
    }

    // è®¾ç½®è¿”å›æŒ‰é’®æ–‡æœ¬
    if (fromSheet && charId) {
        document.getElementById('backText').textContent = 'è¿”å›è§’è‰²æ¡£æ¡ˆ';
    }

    // è¿”å›å‡½æ•°
    function goBack() {
        if (fromSheet && charId) {
            window.location.href = `sheet.html?id=${charId}`;
        } else {
            window.location.href = 'dashboard.html';
        }
    }

    async function loadFiles() {
        const listEl = document.getElementById('fileList');

        try {
            // è®¾ç½®è¶…æ—¶æœºåˆ¶ï¼Œé˜²æ­¢ä¸€ç›´è½¬åœˆ
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5ç§’è¶…æ—¶

            // å¦‚æœæŒ‡å®šäº†è§’è‰²å¡IDï¼Œä¼ é€’ç»™APIè¿›è¡Œç­›é€‰
            let apiUrl = '/api/documents/list';
            if (charId) {
                apiUrl += `?charId=${encodeURIComponent(charId)}`;
            }

            const res = await fetch(apiUrl, {
                headers: { 'Authorization': `Bearer ${token}` },
                signal: controller.signal
            });
            clearTimeout(timeoutId);

            if (res.status === 401 || res.status === 403) {
                localStorage.clear();
                alert("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°æ¥å…¥");
                window.location.href = 'login.html';
                return;
            }

            if (!res.ok) throw new Error(`HTTP Error ${res.status}`);

            const files = await res.json();
            renderList(files);

        } catch (e) {
            console.error(e);
            let errorMsg = "è¿æ¥å¤±è´¥";
            if (e.name === 'AbortError') errorMsg = "è¿æ¥æœåŠ¡å™¨è¶…æ—¶";
            else if (e.message.includes('Failed to fetch')) errorMsg = "ç½‘ç»œæ— æ³•è¿æ¥ (è¯·æ£€æŸ¥IP)";

            listEl.innerHTML = `
                <div class="error-box">
                    <i class="fas fa-wifi" style="font-size:24px; margin-bottom:10px;"></i>
                    <div>${errorMsg}</div>
                    <div style="font-size:11px; margin-top:5px; opacity:0.8;">è¯·ç¡®è®¤æ‰‹æœºå·²è¿æ¥åŒä¸€å±€åŸŸç½‘ï¼Œä¸”ç”µè„‘é˜²ç«å¢™å·²å…è®¸ç«¯å£è®¿é—®ã€‚</div>
                    <button class="btn-retry" onclick="location.reload()">é‡è¯•</button>
                </div>
            `;
        }
    }

    function renderList(files) {
        const container = document.getElementById('fileList');
        container.innerHTML = '';

        if (!files || files.length === 0) {
            container.innerHTML = '<div style="padding:20px;text-align:center;color:#64748b;">æš‚æ— æ–‡ä»¶æƒé™</div>';
            return;
        }

        files.forEach(file => {
            const el = document.createElement('div');
            el.className = `file-item ${file.allowed ? '' : 'locked'}`;
            el.innerHTML = `
                <div style="display:flex;align-items:center;overflow:hidden;">
                    <i class="fas ${file.allowed ? 'fa-file-alt' : 'fa-lock'}" style="margin-right:10px; width:20px; text-align:center;"></i>
                    <span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${file.title}</span>
                </div>
                ${file.allowed ? '<i class="fas fa-chevron-right" style="opacity:0.3;font-size:12px;"></i>' : ''}
            `;
            
            if (file.allowed) {
                el.onclick = () => loadContent(file.filename, file.title);
            }
            container.appendChild(el);
        });
    }

    async function loadContent(filename, title) {
        // åˆ‡æ¢åˆ°é˜…è¯»æ¨¡å¼
        document.body.classList.add('reading-mode');
        document.getElementById('mobileTitle').textContent = title;

        const contentEl = document.getElementById('docContent');
        contentEl.innerHTML = '<div style="text-align:center;padding:50px;"><i class="fas fa-circle-notch fa-spin"></i><br>æ­£åœ¨è§£å¯†...</div>';

        // ç‰¹æ®Šå¤„ç† A1.md - æ˜¾ç¤ºåªè¯»çš„ä»»åŠ¡æŠ¥å‘Šæ¨¡æ¿ï¼ˆä¸å¯ç¼–è¾‘ï¼Œç™½è‰²èƒŒæ™¯ï¼‰
        if (filename.toLowerCase() === 'a1.md') {
            renderReportReadOnly(contentEl);
            return;
        }

        try {
            const res = await fetch(`/api/documents/read/${filename}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!res.ok) throw new Error('æ— æ³•è¯»å–æ–‡ä»¶');
            const data = await res.json();

            // æ£€æŸ¥ Marked æ˜¯å¦åŠ è½½æˆåŠŸ
            if (typeof marked !== 'undefined') {
                contentEl.innerHTML = marked.parse(data.content);
            } else {
                // å¦‚æœ CDN æŒ‚äº†ï¼Œæ˜¾ç¤ºçº¯æ–‡æœ¬ï¼Œä¸è®©ç”¨æˆ·çœ‹ä¸äº†
                contentEl.innerHTML = `<pre style="white-space:pre-wrap; font-family:sans-serif;">${data.content}</pre>
                <div style="color:orange;font-size:12px;margin-top:20px;">* Markdown è§£æå™¨åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºåŸå§‹æ–‡æœ¬</div>`;
            }

        } catch (e) {
            contentEl.innerHTML = `<div class="error-box">è¯»å–å¤±è´¥: ${e.message}</div>`;
        }
    }

    // ========== A1 ä»»åŠ¡æŠ¥å‘Šè¡¨å• ==========
    let missionTeammates = []; // å­˜å‚¨ä»»åŠ¡é˜Ÿå‹ä¿¡æ¯

    async function renderReportForm(container) {
        // å…ˆåŠ è½½ä»»åŠ¡é˜Ÿå‹ä¿¡æ¯
        if (charId) {
            try {
                const res = await fetch(`/api/character/${charId}/mission`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    if (data.inMission && data.teammates) {
                        missionTeammates = data.teammates;
                    }
                }
            } catch (e) {
                console.error('è·å–ä»»åŠ¡é˜Ÿå‹å¤±è´¥:', e);
            }
        }

        // ç”Ÿæˆç‰¹å·¥è¡¨ç°è¡Œï¼ˆæ ¹æ®é˜Ÿå‹æ•°é‡åŠ¨æ€ç”Ÿæˆï¼‰
        const agentRows = [];
        const maxAgents = Math.max(4, missionTeammates.length); // è‡³å°‘4è¡Œ
        for (let i = 0; i < maxAgents; i++) {
            const teammate = missionTeammates[i];
            const name = teammate ? teammate.characterName : '';
            agentRows.push(`
                <tr>
                    <td><input type="text" id="rpt-agent${i+1}-name" value="${escapeAttr(name)}"></td>
                    <td><input type="number" id="rpt-agent${i+1}-reward" value="0" min="0"></td>
                    <td><input type="number" id="rpt-agent${i+1}-penalty" value="0" min="0"></td>
                    <td><input type="text" id="rpt-agent${i+1}-note"></td>
                </tr>
            `);
        }

        container.innerHTML = `
            <div class="report-container">
                <div class="report-header">
                    <h1><i class="fas fa-file-alt"></i> ä»»åŠ¡æŠ¥å‘Šæäº¤ç³»ç»Ÿ</h1>
                    <p>è¯·å¦‚å®å¡«å†™ä»»åŠ¡æ‰§è¡Œæƒ…å†µï¼Œæäº¤åå°†å‘é€è‡³ä»»åŠ¡è´Ÿè´£ç»ç†</p>
                </div>

                <div class="report-section">
                    <h3><i class="fas fa-exclamation-triangle"></i> å¼‚å¸¸çŠ¶æ€</h3>
                    <div class="report-status-grid">
                        <label class="report-status-item">
                            <input type="checkbox" id="rpt-neutralized">
                            <span class="status-icon">ğŸ”«</span>
                            <div class="status-info"><h4>å·²ä¸­å’Œ</h4><small>æ— å½±å“</small></div>
                        </label>
                        <label class="report-status-item">
                            <input type="checkbox" id="rpt-captured">
                            <span class="status-icon">ğŸ’¼</span>
                            <div class="status-info"><h4>å·²æ•è·</h4><small>+3 å˜‰å¥–</small></div>
                        </label>
                        <label class="report-status-item">
                            <input type="checkbox" id="rpt-escaped">
                            <span class="status-icon">ğŸšª</span>
                            <div class="status-info"><h4>å·²é€ƒè„±</h4><small>+3 ç”³è¯«</small></div>
                        </label>
                        <label class="report-status-item">
                            <input type="checkbox" id="rpt-breach">
                            <span class="status-icon">ğŸ’€</span>
                            <div class="status-info"><h4>æ”¶å®¹å¤±æ•ˆ</h4><small>+5 ç”³è¯«</small></div>
                        </label>
                    </div>
                </div>

                <div class="report-section">
                    <h3><i class="fas fa-info-circle"></i> å¼‚å¸¸æƒ…æŠ¥</h3>
                    <div class="report-row"><label>ä»£å·</label><input type="text" id="rpt-codename" placeholder="å¼‚å¸¸ä»£å·"></div>
                    <div class="report-row"><label>è¡Œä¸º</label><input type="text" id="rpt-behavior" placeholder="å¼‚å¸¸è¡Œä¸ºæè¿°"></div>
                    <div class="report-row"><label>ç„¦ç‚¹</label><input type="text" id="rpt-focus" placeholder="ç„¦ç‚¹ç›®æ ‡"></div>
                    <div class="report-row"><label>é¢†åŸŸ</label><input type="text" id="rpt-domain" placeholder="å½±å“é¢†åŸŸ"></div>
                </div>

                <div class="report-section">
                    <h3><i class="fas fa-users"></i> ç‰¹å·¥è¡¨ç°</h3>
                    <table class="report-table">
                        <thead><tr><th>ç‰¹å·¥å</th><th>å˜‰å¥–</th><th>ç”³è¯«</th><th>å¤‡æ³¨</th></tr></thead>
                        <tbody>
                            ${agentRows.join('')}
                        </tbody>
                    </table>
                </div>

                <div class="report-section">
                    <h3><i class="fas fa-chart-bar"></i> ä»»åŠ¡ç»“ç®—ï¼ˆä»…ä¾›GMä½¿ç”¨ï¼‰</h3>
                    <div class="report-row"><label>æœ€ç»ˆè¯„çº§</label><input type="text" id="rpt-rating" placeholder="S/A/B/C/D/F"></div>
                    <div class="report-row"><label>æ··æ²Œæ± </label><input type="number" id="rpt-chaos" value="-2"></div>
                    <div class="report-row"><label>MVP</label><input type="text" id="rpt-mvp" placeholder="æœ¬æ¬¡ä»»åŠ¡MVP"></div>
                    <div class="report-row"><label>å¯Ÿçœ‹æœŸ</label><input type="text" id="rpt-probation" placeholder="éœ€å¯Ÿçœ‹çš„ç‰¹å·¥"></div>
                </div>

                <div class="report-section">
                    <h3><i class="fas fa-box"></i> æ”¶å®¹ç‰©å¤„ç†</h3>
                    <table class="report-table">
                        <thead><tr><th>æ”¶å®¹ç‰©</th><th>å¤„ç½®æ–¹å¼</th><th>ç»æ‰‹äºº</th></tr></thead>
                        <tbody>
                            <tr><td><input type="text" id="rpt-item1-name"></td><td><input type="text" id="rpt-item1-dispose"></td><td><input type="text" id="rpt-item1-handler"></td></tr>
                            <tr><td><input type="text" id="rpt-item2-name"></td><td><input type="text" id="rpt-item2-dispose"></td><td><input type="text" id="rpt-item2-handler"></td></tr>
                            <tr><td><input type="text" id="rpt-item3-name"></td><td><input type="text" id="rpt-item3-dispose"></td><td><input type="text" id="rpt-item3-handler"></td></tr>
                        </tbody>
                    </table>
                </div>

                <button class="btn-submit-report" onclick="submitReport()">
                    <i class="fas fa-paper-plane"></i> æäº¤æŠ¥å‘Š
                </button>
            </div>
        `;
    }

    // è½¬ä¹‰HTMLå±æ€§å€¼
    function escapeAttr(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;')
                  .replace(/"/g, '&quot;')
                  .replace(/'/g, '&#39;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;');
    }

    // ========== A1 åªè¯»æ˜¾ç¤ºï¼ˆä¸å¯ç¼–è¾‘ï¼Œç™½è‰²èƒŒæ™¯ï¼‰ ==========
    function renderReportReadOnly(container) {
        container.innerHTML = `
            <div class="report-readonly-container">
                <div class="report-header">
                    <h1><i class="fas fa-file-alt"></i> ä»»åŠ¡æŠ¥å‘Šæ¨¡æ¿</h1>
                    <p>A1 - å¤–å‹¤ä»»åŠ¡ç»“æ¡ˆæŠ¥å‘Šæ ‡å‡†æ ¼å¼</p>
                </div>

                <div class="readonly-section">
                    <h3><i class="fas fa-exclamation-triangle"></i> å¼‚å¸¸çŠ¶æ€</h3>
                    <div class="readonly-grid">
                        <div class="readonly-item">
                            <span class="status-icon">ğŸ”«</span>
                            <div class="status-info"><h4>å·²ä¸­å’Œ</h4><small>æ— å½±å“</small></div>
                        </div>
                        <div class="readonly-item">
                            <span class="status-icon">ğŸ’¼</span>
                            <div class="status-info"><h4>å·²æ•è·</h4><small>+3 å˜‰å¥–</small></div>
                        </div>
                        <div class="readonly-item">
                            <span class="status-icon">ğŸšª</span>
                            <div class="status-info"><h4>å·²é€ƒè„±</h4><small>+3 ç”³è¯«</small></div>
                        </div>
                        <div class="readonly-item">
                            <span class="status-icon">ğŸ’€</span>
                            <div class="status-info"><h4>æ”¶å®¹å¤±æ•ˆ</h4><small>+5 ç”³è¯«</small></div>
                        </div>
                    </div>
                </div>

                <div class="readonly-section">
                    <h3><i class="fas fa-info-circle"></i> å¼‚å¸¸æƒ…æŠ¥</h3>
                    <div class="readonly-row"><label>ä»£å·</label><span>å¼‚å¸¸ä»£å·</span></div>
                    <div class="readonly-row"><label>è¡Œä¸º</label><span>å¼‚å¸¸è¡Œä¸ºæè¿°</span></div>
                    <div class="readonly-row"><label>ç„¦ç‚¹</label><span>ç„¦ç‚¹ç›®æ ‡</span></div>
                    <div class="readonly-row"><label>é¢†åŸŸ</label><span>å½±å“é¢†åŸŸ</span></div>
                </div>

                <div class="readonly-section">
                    <h3><i class="fas fa-users"></i> ç‰¹å·¥è¡¨ç°</h3>
                    <table class="readonly-table">
                        <thead><tr><th>ç‰¹å·¥å</th><th>å˜‰å¥–</th><th>ç”³è¯«</th><th>å¤‡æ³¨</th></tr></thead>
                        <tbody>
                            <tr><td>ç‰¹å·¥1</td><td>0</td><td>0</td><td>â€”</td></tr>
                            <tr><td>ç‰¹å·¥2</td><td>0</td><td>0</td><td>â€”</td></tr>
                            <tr><td>ç‰¹å·¥3</td><td>0</td><td>0</td><td>â€”</td></tr>
                            <tr><td>ç‰¹å·¥4</td><td>0</td><td>0</td><td>â€”</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="readonly-section">
                    <h3><i class="fas fa-chart-bar"></i> ä»»åŠ¡ç»“ç®—ï¼ˆä»…ä¾›GMä½¿ç”¨ï¼‰</h3>
                    <div class="readonly-row"><label>æœ€ç»ˆè¯„çº§</label><span>S/A/B/C/D/F</span></div>
                    <div class="readonly-row"><label>æ··æ²Œæ± </label><span>-2</span></div>
                    <div class="readonly-row"><label>MVP</label><span>æœ¬æ¬¡ä»»åŠ¡MVP</span></div>
                    <div class="readonly-row"><label>å¯Ÿçœ‹æœŸ</label><span>éœ€å¯Ÿçœ‹çš„ç‰¹å·¥</span></div>
                </div>

                <div class="readonly-section">
                    <h3><i class="fas fa-box"></i> æ”¶å®¹ç‰©å¤„ç†</h3>
                    <table class="readonly-table">
                        <thead><tr><th>æ”¶å®¹ç‰©</th><th>å¤„ç½®æ–¹å¼</th><th>ç»æ‰‹äºº</th></tr></thead>
                        <tbody>
                            <tr><td>â€”</td><td>â€”</td><td>â€”</td></tr>
                            <tr><td>â€”</td><td>â€”</td><td>â€”</td></tr>
                            <tr><td>â€”</td><td>â€”</td><td>â€”</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="readonly-notice">
                    <i class="fas fa-info-circle"></i>
                    æ­¤ä¸ºä»»åŠ¡æŠ¥å‘Šæ ‡å‡†æ¨¡æ¿ï¼Œä»…ä¾›å‚è€ƒæŸ¥é˜…ã€‚å®é™…æŠ¥å‘Šæäº¤è¯·é€šè¿‡ä»»åŠ¡é¢æ¿è¿›è¡Œã€‚
                </div>
            </div>
        `;
    }

    async function submitReport() {
        if (!charId) {
            showReportToast('é”™è¯¯ï¼šæœªæŒ‡å®šè§’è‰²å¡ID', 'error');
            return;
        }

        // åŠ¨æ€æ”¶é›†ç‰¹å·¥æ•°æ®ï¼ˆæ ¹æ®å®é™…ç”Ÿæˆçš„è¡Œæ•°ï¼‰
        const agentCount = Math.max(4, missionTeammates.length);
        const agents = [];
        for (let i = 1; i <= agentCount; i++) {
            const nameEl = document.getElementById(`rpt-agent${i}-name`);
            if (nameEl && nameEl.value.trim()) {
                agents.push({
                    name: nameEl.value.trim(),
                    reward: parseInt(document.getElementById(`rpt-agent${i}-reward`)?.value) || 0,
                    penalty: parseInt(document.getElementById(`rpt-agent${i}-penalty`)?.value) || 0,
                    note: document.getElementById(`rpt-agent${i}-note`)?.value || ''
                });
            }
        }

        const reportData = {
            status: {
                neutralized: document.getElementById('rpt-neutralized')?.checked || false,
                captured: document.getElementById('rpt-captured')?.checked || false,
                escaped: document.getElementById('rpt-escaped')?.checked || false,
                breach: document.getElementById('rpt-breach')?.checked || false
            },
            anomaly: {
                codename: document.getElementById('rpt-codename')?.value || '',
                behavior: document.getElementById('rpt-behavior')?.value || '',
                focus: document.getElementById('rpt-focus')?.value || '',
                domain: document.getElementById('rpt-domain')?.value || ''
            },
            agents: agents,
            settlement: {
                rating: document.getElementById('rpt-rating')?.value || '',
                chaos: parseInt(document.getElementById('rpt-chaos')?.value) || 0,
                mvp: document.getElementById('rpt-mvp')?.value || '',
                probation: document.getElementById('rpt-probation')?.value || ''
            },
            items: [1,2,3].map(i => ({
                name: document.getElementById(`rpt-item${i}-name`)?.value || '',
                dispose: document.getElementById(`rpt-item${i}-dispose`)?.value || '',
                handler: document.getElementById(`rpt-item${i}-handler`)?.value || ''
            })).filter(item => item.name.trim())
        };

        const btn = document.querySelector('.btn-submit-report');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...';

        try {
            const res = await fetch(`/api/character/${charId}/send-report`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(reportData)
            });

            const result = await res.json();
            if (!res.ok) throw new Error(result.error || 'æäº¤å¤±è´¥');

            showReportToast('æŠ¥å‘Šå·²æˆåŠŸæäº¤', 'success');

            // æ¸…ç©ºè¡¨å•
            setTimeout(() => {
                renderReportForm(document.getElementById('docContent'));
            }, 2000);

        } catch (e) {
            showReportToast('æäº¤å¤±è´¥: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> æäº¤æŠ¥å‘Š';
        }
    }

    function showReportToast(msg, type) {
        const toast = document.getElementById('reportToast');
        toast.textContent = msg;
        toast.className = `report-toast ${type} show`;
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function closeReader() {
        document.body.classList.remove('reading-mode');
    }

    // å¯åŠ¨
    async function init() {
        await loadFiles();

        // å¦‚æœURLä¸­æŒ‡å®šäº†æ–‡ä»¶ï¼Œè‡ªåŠ¨æ‰“å¼€å®ƒ
        if (fileToOpen) {
            const title = fileToOpen.replace(/\.md$/i, '');
            loadContent(fileToOpen, title);
        }
    }
    init();
</script>
</body>
</html>
