<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统管理 // TRIANGLE AGENCY</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --deep-bg: #1a252f;
            --bg-pattern: radial-gradient(#2c3e50 1px, transparent 1px);
            --pure-white: #ffffff;
            --signal-red: #c0392b;
            --text-dark: #2c3e50;
            --placeholder: #95a5a6;
        }
        body {
            font-family: "Roboto Mono", "Noto Sans SC", "Microsoft YaHei", sans-serif;
            background-color: var(--deep-bg);
            background-image: var(--bg-pattern);
            background-size: 20px 20px;
            margin: 0; padding: 20px; color: var(--text-dark);
        }
        .container { max-width: 900px; margin: 0 auto; }

        header {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .brand-logo { display: flex; flex-direction: column; line-height: 0.9; font-weight: 900; text-transform: uppercase; }
        .brand-logo .top { font-size: 20px; letter-spacing: 2px; color: white; }
        .brand-logo .btm { font-size: 12px; letter-spacing: 3px; color: var(--signal-red); }
        .page-title { font-size: 12px; color: #7f8c8d; margin-top: 5px; text-transform: uppercase; letter-spacing: 1px; }

        .btn-group { display: flex; gap: 10px; }
        .btn-logout { background: rgba(255,255,255,0.1); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .btn-logout:hover { background: var(--signal-red); }

        /* 标签页 */
        .tabs {
            display: flex; gap: 5px; margin-bottom: 20px;
        }
        .tab-btn {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.6);
            border: none;
            padding: 10px 20px;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: var(--pure-white);
            color: var(--text-dark);
        }
        .tab-btn:hover:not(.active) {
            background: rgba(255,255,255,0.2);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* 系统设置面板 */
        .config-panel {
            background: var(--pure-white);
            padding: 25px;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .config-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ecf0f1;
        }
        .config-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        .config-section h3 {
            font-size: 14px;
            color: var(--text-dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .config-section h3 i { color: var(--signal-red); }

        .config-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .config-row label {
            font-size: 13px;
            color: var(--text-dark);
            font-weight: 500;
        }
        .config-row .desc {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 3px;
        }

        /* 开关样式 */
        .switch {
            position: relative;
            width: 50px;
            height: 26px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 26px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--signal-red); }
        input:checked + .slider:before { transform: translateX(24px); }

        /* SMTP 配置表单 */
        .smtp-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .smtp-grid .full { grid-column: 1 / -1; }
        .form-field {
            display: flex;
            flex-direction: column;
        }
        .form-field label {
            font-size: 11px;
            color: #7f8c8d;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .form-field input {
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 4px;
            font-size: 16px; /* 防止iOS自动缩放 */
            transition: border-color 0.2s;
            box-sizing: border-box;
            width: 100%;
        }
        .form-field input:focus {
            outline: none;
            border-color: var(--signal-red);
        }

        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        /* 移动端适配 */
        
        .btn-save {
            background: var(--signal-red);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.2s;
        }
        .btn-save:hover { background: #e74c3c; }
        .btn-test {
            background: #34495e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.2s;
        }
        .btn-test:hover { background: #2c3e50; }

        /* 用户管理 */
        .add-panel {
            background: var(--pure-white);
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex; gap: 10px; flex-wrap: wrap;
            border-left: 5px solid var(--signal-red);
        }

        .add-panel input, .add-panel select {
            padding: 10px; border: 2px solid #ecf0f1; background: #fdfdfd; color: var(--text-dark);
            border-radius: 4px; flex: 1; min-width: 100px; font-weight: bold;
        }
        .add-panel input:focus, .add-panel select:focus { border-color: var(--signal-red); outline: none; background: white; }

        .btn-add {
            background: var(--signal-red); color: white; border: none;
            padding: 0 20px; border-radius: 4px; cursor: pointer; font-weight: bold;
            text-transform: uppercase; font-size: 12px; box-shadow: 0 2px 5px rgba(192, 57, 43, 0.3);
        }
        .btn-add:hover { background: #e74c3c; transform: translateY(-1px); }

        .search-wrapper {
            position: relative;
            margin-bottom: 20px;
        }
        .search-wrapper i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--placeholder);
        }
        .search-input {
            width: 100%;
            padding: 12px 10px 12px 40px;
            background: rgba(0,0,0,0.2);
            border: 1px solid #576574;
            border-radius: 4px;
            color: white;
            font-family: inherit;
            box-sizing: border-box;
        }
        .search-input:focus { outline: none; border-color: var(--signal-red); background: rgba(0,0,0,0.4); }
        .search-input::placeholder { color: var(--placeholder); font-style: italic; }

        .filter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .filter-btn {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7);
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }
        .filter-btn.active {
            background: var(--signal-red);
            color: white;
        }
        .filter-btn:hover:not(.active) {
            background: rgba(255,255,255,0.2);
        }

        .user-list { display: grid; gap: 12px; }
        .user-card {
            background: var(--pure-white);
            padding: 15px; border-radius: 6px;
            display: flex; align-items: center; justify-content: space-between;
            border: 1px solid #ecf0f1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .u-info { flex: 1; }
        .u-name { font-weight: bold; font-size: 16px; color: var(--text-dark); display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .u-meta { font-size: 12px; color: #7f8c8d; margin-top: 5px; }

        .action-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn-base { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; text-transform: uppercase; }

        .btn-edit { background: #ecf0f1; color: var(--text-dark); }
        .btn-edit:hover { background: #bdc3c7; }

        .btn-role { background: #3498db; color: white; }
        .btn-role:hover { background: #2980b9; }

        .btn-del { background: #fceceb; color: var(--signal-red); }
        .btn-del:hover { background: var(--signal-red); color: white; }

        /* 邀请码列表样式 */
        .invitation-list { display: grid; gap: 12px; }
        .invitation-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--signal-red);
        }
        .invitation-card.inactive {
            opacity: 0.6;
            border-left-color: #95a5a6;
        }
        .invitation-card .inv-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .invitation-card .inv-code {
            font-family: monospace;
            font-size: 18px;
            font-weight: bold;
            color: var(--signal-red);
            letter-spacing: 2px;
        }
        .invitation-card .inv-meta {
            font-size: 11px;
            color: #7f8c8d;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .invitation-card .inv-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .invitation-card .inv-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .btn-inv {
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
        }
        .btn-inv-copy { background: #3498db; color: white; }
        .btn-inv-copy:hover { background: #2980b9; }
        .btn-inv-uses { background: #9b59b6; color: white; }
        .btn-inv-uses:hover { background: #8e44ad; }
        .btn-inv-toggle { background: #f39c12; color: white; }
        .btn-inv-toggle:hover { background: #d68910; }
        .btn-inv-delete { background: #e74c3c; color: white; }
        .btn-inv-delete:hover { background: #c0392b; }
        .uses-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .uses-item .uses-user { font-weight: bold; color: var(--text-dark); }
        .uses-item .uses-time { color: #7f8c8d; font-size: 11px; }

        .role-tag {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            letter-spacing: 0.5px;
        }
        .role-player { background: #ecf0f1; color: #7f8c8d; }
        .role-manager { background: #3498db; color: white; }
        .role-admin { background: var(--signal-red); color: white; }

        .no-result { text-align: center; color: #7f8c8d; font-style: italic; font-size: 14px; margin-top: 10px; }

        /* 模态框 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal h3 {
            margin: 0 0 20px;
            color: var(--text-dark);
            font-size: 16px;
        }
        .modal-btns {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-btns button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-cancel { background: #ecf0f1; color: var(--text-dark); }
        .btn-confirm { background: var(--signal-red); color: white; }

        .role-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 4px;
            font-size: 14px;
        }
        .role-select:focus {
            outline: none;
            border-color: var(--signal-red);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--signal-red);
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: bold;
            z-index: 2000;
            display: none;
        }
        .toast.show { display: block; animation: slideUp 0.3s ease; }
        .toast.success { background: #27ae60; }
        @keyframes slideUp { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    /* =========================================
       移动端深度适配 (Mobile Responsive)
       ========================================= */
/* =========================================
       统一导航栏与侧滑菜单样式 (Admin)
       ========================================= */
    
    /* 1. 桌面端按钮组基础样式 */
    .btn-group { display: flex; align-items: center; gap: 10px; }
    .btn-nav {
        height: 36px; padding: 0 15px; border: none; border-radius: 4px;
        color: white; font-weight: bold; font-size: 12px; cursor: pointer;
        display: inline-flex; align-items: center; gap: 6px; transition: 0.2s;
        text-decoration: none;
    }
    .btn-nav:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    
    /* 颜色定义 */
    .btn-nav.manager { background: #E06B56; } /* 经理台 */
    .btn-nav.archive { background: #3498db; } /* 档案库 */
    .btn-nav.logout { background: #fff; color: #555; border: 1px solid #eee; }
    .btn-nav.logout:hover { color: var(--signal-red); }

    /* 2. 移动端菜单触发器 (默认隐藏) */
/* =========================================
           【统一】手机端菜单按钮样式 (Unified Menu Button)
           ========================================= */
        .menu-toggle {
            display: none; /* 桌面端默认隐藏 */
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
            padding: 0 12px;
            height: 36px; /* 统一高度 */
            color: rgba(255, 255, 255, 0.8);
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s ease;
        }

        .menu-toggle:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--signal-red);
            color: white;
            box-shadow: 0 0 10px rgba(192, 57, 43, 0.3);
        }

        /* 三角形图标容器 */
        .menu-toggle .tri-icon {
            position: relative;
            width: 18px;
            height: 16px;
        }

        /* 小三角形构造 */
        .menu-toggle .tri {
            position: absolute;
            width: 0; height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 7px solid var(--signal-red); /* 统一红色 */
        }

        /* 三角形位置与动画 */
        .menu-toggle .t1 { 
            left: 5px; top: 0; 
            animation: tri-pulse 2s infinite ease-in-out; 
        }
        .menu-toggle .t2 { 
            left: 0; top: 8px; 
            animation: tri-pulse 2s infinite ease-in-out 0.3s; 
        }
        .menu-toggle .t3 { 
            left: 10px; top: 8px; 
            animation: tri-pulse 2s infinite ease-in-out 0.6s; 
        }

        @keyframes tri-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        /* 移动端显示控制 */
        @media (max-width: 768px) {
            .menu-toggle { display: flex !important; }
        }
		
    .menu-toggle .tri-icon { display: flex; flex-direction: column; gap: 3px; }
    .menu-toggle .line { width: 18px; height: 2px; background: var(--signal-red); }

   /* =========================================
       【统一】侧滑菜单样式 (Unified Sidebar)
       ========================================= */
    .side-menu-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); backdrop-filter: blur(2px); z-index: 9998;
        opacity: 0; transition: opacity 0.3s;
    }
    .side-menu-overlay.show { display: block; opacity: 1; }

    .side-menu {
        position: fixed; 
        top: 0; 
        right: -280px; /* 默认隐藏在右侧 */
        left: auto;    /* 清除左侧定位 */
        width: 260px; 
        height: 100%;
        background: linear-gradient(180deg, #1a252f 0%, #0f172a 100%);
        z-index: 9999; 
        transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* 动画属性改为 right */
        display: flex; 
        flex-direction: column;
        box-shadow: -10px 0 40px rgba(0,0,0,0.5); /* 阴影投向左侧 */
        border-left: 1px solid rgba(255,255,255,0.05); /* 左侧边框 */
        border-right: none;
    }
    
    /* 激活状态：right 变为 0 */
    .side-menu.show { 
        right: 0; 
    }

    .side-menu-header {
        padding: 30px 20px; border-bottom: 1px solid rgba(255,255,255,0.1);
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(0,0,0,0.2);
    }
    .side-menu-header .brand-sm { font-weight: 900; font-style: italic; letter-spacing: 1px; color: white; font-size: 18px; }
    .side-menu-header .brand-sm span { color: var(--signal-red); font-size: 12px; display: block; letter-spacing: 3px; }
    
    .side-menu-close {
        background: none; border: none; color: rgba(255,255,255,0.4);
        font-size: 24px; cursor: pointer; transition: 0.2s;
    }
    .side-menu-close:hover { color: white; transform: scale(1.1); }

    .side-menu-content {
        flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 12px;
        overflow-y: auto;
    }

    /* 统一菜单项样式 */
    .menu-item {
        display: flex; align-items: center; gap: 15px; padding: 16px 20px;
        background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
        border-radius: 8px; color: rgba(255,255,255,0.8); font-size: 13px; font-weight: 700;
        cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px;
    }
    .menu-item i { width: 20px; text-align: center; font-size: 14px; opacity: 0.8; }
    .menu-item:hover {
        background: rgba(255,255,255,0.08); transform: translateX(-5px);
        color: white; border-color: rgba(255,255,255,0.2);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    /* === 特定功能按钮配色 (使用 !important 覆盖默认) === */
    /* 档案库/高墙 (蓝色) */
    .menu-item.archive, .menu-item.highwall { 
        border-left: 3px solid #3498db !important;
    }
    .menu-item.archive:hover, .menu-item.highwall:hover { background: rgba(52, 152, 219, 0.15) !important; color: #3498db !important; }

    /* 经理台 (橙红) */
    .menu-item.manager { 
        border-left: 3px solid #E06B56 !important;
    }
    .menu-item.manager:hover { background: rgba(224, 107, 86, 0.15) !important; color: #E06B56 !important; }

    /* 管理台 (正红) */
    .menu-item.admin { 
        border-left: 3px solid #d63031 !important;
    }
    .menu-item.admin:hover { background: rgba(214, 48, 49, 0.15) !important; color: #d63031 !important; }

    /* 收件箱 (紫色) */
    .menu-item.inbox { 
        border-left: 3px solid #8e44ad !important;
    }
    .menu-item.inbox:hover { background: rgba(142, 68, 173, 0.15) !important; color: #8e44ad !important; }

    /* 退出登录 */
    .menu-item.logout {
        margin-top: auto; border: 1px dashed rgba(255,255,255,0.2); background: transparent;
    }
    .menu-item.logout:hover {
        border-color: var(--signal-red); color: var(--signal-red); background: rgba(192, 57, 43, 0.1);
    }

    /* 4. 强制移动端适配 */
    @media (max-width: 768px) {
        header { 
            flex-direction: row !important; 
            justify-content: space-between !important; 
            align-items: center !important;
            margin-bottom: 20px !important;
        }
        .brand-logo { margin-bottom: 0 !important; }
        .btn-group { display: none !important; } /* 隐藏桌面按钮 */
        .menu-toggle { display: flex !important; } /* 显示汉堡菜单 */
    }
	/* =========================================
       【修复】过渡动画样式 (Transition Overlay)
       ========================================= */
    #transition-overlay { 
        position: fixed; 
        top: 0; left: 0; 
        width: 100vw; height: 100vh; 
        background: #0f172a; 
        z-index: 10000; /* 确保在最上层 */
        
        /* 核心动画属性：默认上下闭合隐藏 */
        clip-path: inset(50% 0 50% 0); 
        pointer-events: none; /* 默认不挡鼠标 */
        transition: clip-path 0.8s cubic-bezier(0.8, 0, 0.2, 1); 
        
        display: flex; 
        flex-direction: column; 
        justify-content: center; 
        align-items: center; 
    }

    /* 激活状态：展开 */
    #transition-overlay.active { 
        pointer-events: all; 
        clip-path: inset(0 0 0 0); 
    }

    /* 中间的横线光效 */
    #transition-overlay::before { 
        content: ''; position: absolute; top: 50%; left: 0; 
        width: 100%; height: 2px; background: var(--signal-red); 
        z-index: 100; box-shadow: 0 0 15px var(--signal-red); 
        opacity: 0; transition: opacity 0.2s; 
    }
    #transition-overlay.active::before { 
        opacity: 1; animation: line-fade 0.8s forwards; 
    }
    @keyframes line-fade { 
        0% { opacity: 1; transform: scaleX(0.1); } 
        50% { opacity: 1; transform: scaleX(1); } 
        100% { opacity: 0; transform: scaleX(1); } 
    }

    /* 文字和图标内容 */
    .loader-content { 
        text-align: center; color: var(--signal-red); 
        opacity: 0; transform: scale(0.9); 
        transition: all 0.4s ease 0.2s; 
    }
    #transition-overlay.active .loader-content { 
        opacity: 1; transform: scale(1); 
    }
    
    .loader-icon { font-size: 40px; margin-bottom: 20px; }
    .loader-text { 
        font-family: "Noto Sans SC", sans-serif; 
        font-size: 16px; letter-spacing: 2px; font-weight: 900; 
        display: flex; align-items: center; justify-content: center; 
    }
    .dots::after { 
        content: ''; width: 1.5em; text-align: left; 
        display: inline-block; animation: dot-steps 1.5s infinite steps(4, end); 
    }
    @keyframes dot-steps { 
        0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80%, 100% { content: '...'; } 
    }
	</style>
</head>
<body>
<!-- 页面过渡遮罩层 -->
<div id="transition-overlay">
    <div class="loader-content">
        <i class="fas fa-circle-notch fa-spin loader-icon"></i>
        <div class="loader-text">系统处理中<span class="dots"></span></div>
    </div>
</div>
<div class="container">
<header>
        <div class="brand-logo">
            <span class="top">TRIANGLE</span>
            <span class="btm">AGENCY</span>
            <div class="page-title" style="margin-top:2px; font-size:10px;">// SYSTEM ADMIN</div>
        </div>
        
        <!-- 桌面端按钮组 -->
        <div class="btn-group">
            <!-- 经理台: 改为 onclick="goManager()" -->
			<button class="btn-nav manager" id="deskBtnManager" onclick="goManager()" style="display:none;">
				<i class="fas fa-user-tie"></i> 经理台
			</button>
            
            <!-- 档案库: 改为 onclick="goDashboard()" -->
			<button class="btn-nav archive" onclick="goDashboard()">
				<i class="fas fa-folder"></i> 档案库
			</button>
            
            <!-- 退出保持不变 -->
            <button class="btn-nav logout" onclick="logout()">
                <i class="fas fa-power-off"></i>
            </button>
        </div>

        <!-- 移动端菜单按钮 -->
        <button class="menu-toggle" onclick="toggleSideMenu()">
            <span>菜单</span>
            <div class="tri-icon">
                <div class="tri t1"></div>
                <div class="tri t2"></div>
                <div class="tri t3"></div>
            </div>
        </button>
    </header>

    <!-- 侧滑菜单结构 (插入到 Header 之后) -->
    <div class="side-menu-overlay" id="sideMenuOverlay" onclick="closeSideMenu()"></div>
    <div class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <div class="brand-sm">TRIANGLE AGENCY</div>
            <button class="side-menu-close" onclick="closeSideMenu()">&times;</button>
        </div>
		<div class="side-menu-content">
            <!-- 经理台: 改为 onclick="closeSideMenu(); goManager();" -->
			<div class="menu-item manager" id="mobBtnManager" onclick="closeSideMenu(); goManager();" style="display:none;">
				<i class="fas fa-user-tie"></i> 经理台
			</div>
            
            <!-- 档案库: 改为 onclick="closeSideMenu(); goDashboard();" -->
			<div class="menu-item archive" onclick="closeSideMenu(); goDashboard();">
				<i class="fas fa-folder"></i> 档案库
			</div>
            
            <!-- 退出保持不变 -->
            <div class="menu-item logout" onclick="closeSideMenu(); logout();">
                <i class="fas fa-sign-out-alt"></i> 退出登录
            </div>
        </div>
    </div>

    <!-- 标签页切换 -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('users')"><i class="fas fa-users"></i> 人员管理</button>
        <button class="tab-btn" onclick="switchTab('config')"><i class="fas fa-cog"></i> 系统设置</button>
        <button class="tab-btn" onclick="switchTab('invitations')"><i class="fas fa-ticket-alt"></i> 邀请码</button>
    </div>

    <!-- 人员管理 -->
    <div id="tab-users" class="tab-content active">
        <div class="add-panel">
            <input type="text" id="newName" placeholder="职员姓名">
            <input type="text" id="newUser" placeholder="登录账号">
            <input type="text" id="newPass" placeholder="登录密码">
            <select id="newRole">
                <option value="0">玩家</option>
                <option value="1">经理</option>
                <option value="2">超级管理员</option>
            </select>
            <button class="btn-add" onclick="addUser()"><i class="fas fa-plus"></i> 入职登记</button>
        </div>

        <div class="filter-row">
            <button class="filter-btn active" data-role="all" onclick="filterByRole('all', this)">全部</button>
            <button class="filter-btn" data-role="0" onclick="filterByRole(0, this)">玩家</button>
            <button class="filter-btn" data-role="1" onclick="filterByRole(1, this)">经理</button>
            <button class="filter-btn" data-role="2" onclick="filterByRole(2, this)">超管</button>
        </div>

        <div class="search-wrapper">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="SEARCH... [输入姓名进行检索]" autocomplete="off">
        </div>

        <div id="list" class="user-list"></div>
    </div>

    <!-- 系统设置 -->
    <div id="tab-config" class="tab-content">
        <div class="config-panel">
            <div class="config-section">
                <h3><i class="fas fa-user-plus"></i> 注册设置</h3>
                <div class="config-row">
                    <div>
                        <label>开放注册</label>
                        <div class="desc">允许新用户自行注册账号</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="cfg_reg_enabled">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="config-row">
                    <div>
                        <label>邮箱验证</label>
                        <div class="desc">注册时需要验证邮箱（需配置SMTP）</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="cfg_email_enabled">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="config-row">
                    <div>
                        <label>邀请码注册</label>
                        <div class="desc">开启后需要邀请码才能注册</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="cfg_invitation_required">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="config-section">
                <h3><i class="fas fa-envelope"></i> SMTP 邮件配置</h3>
                <div class="smtp-grid">
                    <div class="form-field">
                        <label>SMTP 服务器</label>
                        <input type="text" id="cfg_smtp_host" placeholder="smtp.example.com">
                    </div>
                    <div class="form-field">
                        <label>端口</label>
                        <input type="text" id="cfg_smtp_port" placeholder="587">
                    </div>
                    <div class="form-field">
                        <label>用户名</label>
                        <input type="text" id="cfg_smtp_user" placeholder="your@email.com">
                    </div>
                    <div class="form-field">
                        <label>密码</label>
                        <input type="password" id="cfg_smtp_pass" placeholder="••••••••">
                    </div>
                    <div class="form-field full">
                        <label>发件人地址</label>
                        <input type="text" id="cfg_smtp_from" placeholder="Triangle Agency <noreply@example.com>">
                    </div>
                    <div class="config-row full" style="background:transparent;padding:0;">
                        <div>
                            <label>使用 SSL/TLS</label>
                            <div class="desc">端口465通常需要开启</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="cfg_smtp_secure">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="btn-row">
                    <button class="btn-test" onclick="testSmtp()"><i class="fas fa-plug"></i> 测试连接</button>
                    <button class="btn-save" onclick="saveConfig()"><i class="fas fa-save"></i> 保存配置</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 邀请码管理 -->
    <div id="tab-invitations" class="tab-content">
        <div class="config-panel">
            <div class="config-section">
                <h3><i class="fas fa-ticket-alt"></i> 邀请码管理</h3>
                <div class="btn-row" style="margin-bottom:20px;">
                    <button class="btn-save" onclick="openCreateInvitationModal()"><i class="fas fa-plus"></i> 生成邀请码</button>
                    <button class="btn-test" onclick="loadInvitations()"><i class="fas fa-sync"></i> 刷新</button>
                </div>
                <div id="invitationList" class="invitation-list">
                    <div style="text-align:center;color:#7f8c8d;padding:20px;">加载中...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 生成邀请码模态框 -->
<div class="modal-overlay" id="invitationModal">
    <div class="modal">
        <h3><i class="fas fa-ticket-alt"></i> 生成邀请码</h3>
        <div class="form-field" style="margin-bottom:15px;">
            <label>邀请码类型</label>
            <select id="invGrantRole" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                <option value="0">普通邀请码（注册为特工）</option>
                <option value="1">经理邀请码（注册后拥有经理权限）</option>
            </select>
        </div>
        <div class="form-field" style="margin-bottom:15px;">
            <label>可使用次数</label>
            <input type="number" id="invMaxUses" value="1" min="1" placeholder="1=单次使用，0=无限">
            <div style="font-size:11px;color:#7f8c8d;margin-top:5px;">设为0表示无限次使用</div>
        </div>
        <div class="form-field" style="margin-bottom:15px;">
            <label>有效期（天）</label>
            <input type="number" id="invExpiresDays" value="" min="1" placeholder="留空表示永不过期">
        </div>
        <div class="modal-btns">
            <button class="btn-cancel" onclick="closeInvitationModal()">取消</button>
            <button class="btn-confirm" onclick="createInvitation()">生成</button>
        </div>
    </div>
</div>

<!-- 邀请码使用记录模态框 -->
<div class="modal-overlay" id="invitationUsesModal">
    <div class="modal" style="max-width:500px;">
        <h3><i class="fas fa-history"></i> 使用记录 - <span id="usesModalCode"></span></h3>
        <div id="usesModalContent" style="max-height:300px;overflow-y:auto;">
            <div style="text-align:center;color:#7f8c8d;padding:20px;">加载中...</div>
        </div>
        <div class="modal-btns">
            <button class="btn-cancel" onclick="closeUsesModal()">关闭</button>
        </div>
    </div>
</div>

<!-- 角色修改模态框 -->
<div class="modal-overlay" id="roleModal">
    <div class="modal">
        <h3><i class="fas fa-user-tag"></i> 修改用户角色</h3>
        <p style="margin-bottom:15px;font-size:13px;color:#7f8c8d;">用户: <strong id="modalUserName"></strong></p>
        <select class="role-select" id="modalRoleSelect">
            <option value="0">玩家 - 普通用户，只能管理自己的角色卡</option>
            <option value="1">经理 - 可以查看/编辑已授权的角色卡</option>
            <option value="2">超级管理员 - 拥有全部权限</option>
        </select>
        <div class="modal-btns">
            <button class="btn-cancel" onclick="closeRoleModal()">取消</button>
            <button class="btn-confirm" onclick="confirmRoleChange()">确认修改</button>
        </div>
    </div>
</div>

<!-- 重置密码模态框 -->
<div class="modal-overlay" id="passwordModal">
    <div class="modal">
        <h3><i class="fas fa-key"></i> 重置密码</h3>
        <p style="margin-bottom:15px;font-size:13px;color:#7f8c8d;">用户: <strong id="pwdModalUserName"></strong></p>
        <div class="form-field">
            <label>新密码</label>
            <input type="password" id="newPasswordInput" placeholder="输入新密码">
        </div>
        <div class="form-field" style="margin-top:10px;">
            <label>确认密码</label>
            <input type="password" id="confirmPasswordInput" placeholder="再次输入新密码">
        </div>
        <div class="modal-btns">
            <button class="btn-cancel" onclick="closePasswordModal()">取消</button>
            <button class="btn-confirm" onclick="confirmPasswordChange()">确认重置</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
    const token = localStorage.getItem('ta_token');
	// === 页面过渡动画逻辑 ===
    function createTransition(text, url) {
        const overlay = document.getElementById('transition-overlay');
        const loaderText = overlay.querySelector('.loader-text');
        
        // 设置加载文字 + 动态省略号
        if (loaderText) {
            loaderText.innerHTML = `${text}<span class="dots"></span>`;
        }
        
        // 激活遮罩层
        overlay.classList.add('active');
        
        // 延迟跳转 (配合 CSS 动画时间 0.8s + 缓冲)
        setTimeout(() => {
            window.location.href = url;
        }, 1200);
    }

    function goManager() {
        createTransition('授权认证中', 'manager.html');
    }

    function goDashboard() {
        createTransition('档案读取中', 'dashboard.html');
    }
	
    const isAdmin = localStorage.getItem('ta_is_admin');
    if (isAdmin !== 'true' || !token) { window.location.href = 'login.html'; }

    const ROLE_NAMES = ['玩家', '经理', '超管'];
    const ROLE_CLASSES = ['role-player', 'role-manager', 'role-admin'];

    let allUsersData = [];
    let currentFilter = 'all';
    let editingUserId = null;

    function getAuthHeaders() {
        return {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        };
    }

    function showToast(msg, success = false) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className = 'toast show' + (success ? ' success' : '');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // 标签切换
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');

        if (tab === 'config') loadConfig();
        if (tab === 'invitations') loadInvitations();
    }

    // 加载配置
    async function loadConfig() {
        try {
            const res = await fetch('/api/admin/config', { headers: getAuthHeaders() });
            const config = await res.json();

            document.getElementById('cfg_reg_enabled').checked = config.registration_enabled === 'true';
            document.getElementById('cfg_email_enabled').checked = config.email_registration_enabled === 'true';
            document.getElementById('cfg_invitation_required').checked = config.invitation_required === 'true';
            document.getElementById('cfg_smtp_host').value = config.smtp_host || '';
            document.getElementById('cfg_smtp_port').value = config.smtp_port || '587';
            document.getElementById('cfg_smtp_user').value = config.smtp_user || '';
            document.getElementById('cfg_smtp_pass').value = config.smtp_pass || '';
            document.getElementById('cfg_smtp_from').value = config.smtp_from || '';
            document.getElementById('cfg_smtp_secure').checked = config.smtp_secure === 'true';
        } catch (e) {
            showToast('加载配置失败');
        }
    }

    // 保存配置
    async function saveConfig() {
        try {
            const config = {
                registration_enabled: document.getElementById('cfg_reg_enabled').checked ? 'true' : 'false',
                email_registration_enabled: document.getElementById('cfg_email_enabled').checked ? 'true' : 'false',
                invitation_required: document.getElementById('cfg_invitation_required').checked ? 'true' : 'false',
                smtp_host: document.getElementById('cfg_smtp_host').value,
                smtp_port: document.getElementById('cfg_smtp_port').value,
                smtp_user: document.getElementById('cfg_smtp_user').value,
                smtp_pass: document.getElementById('cfg_smtp_pass').value,
                smtp_from: document.getElementById('cfg_smtp_from').value,
                smtp_secure: document.getElementById('cfg_smtp_secure').checked ? 'true' : 'false'
            };

            const res = await fetch('/api/admin/config', {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(config)
            });
            const data = await res.json();

            if (data.success) {
                showToast('配置已保存', true);
            } else {
                showToast(data.message || '保存失败');
            }
        } catch (e) {
            showToast('保存失败');
        }
    }

    // 测试SMTP
    async function testSmtp() {
        try {
            const res = await fetch('/api/admin/test-smtp', {
                method: 'POST',
                headers: getAuthHeaders()
            });
            const data = await res.json();

            if (data.success) {
                showToast('SMTP连接成功', true);
            } else {
                showToast(data.message || 'SMTP连接失败');
            }
        } catch (e) {
            showToast('测试失败');
        }
    }

    // 加载用户列表
    async function loadUsers() {
        try {
            const res = await fetch('/api/users', { headers: getAuthHeaders() });
            allUsersData = await res.json();
            renderList(allUsersData);
        } catch (e) {
            console.error(e);
            showToast('加载用户列表失败');
        }
    }

    // 渲染用户列表
    function renderList(users) {
        const container = document.getElementById('list');
        container.innerHTML = '';

        if (users.length === 0) {
            container.innerHTML = '<div class="no-result">NO MATCHING RECORDS FOUND</div>';
            return;
        }

        users.forEach(u => {
            const el = document.createElement('div');
            el.className = 'user-card';

            const role = u.role !== undefined ? u.role : (u.isAdmin ? 2 : 0);
            const roleTag = `<span class="role-tag ${ROLE_CLASSES[role]}">${ROLE_NAMES[role]}</span>`;

            const delBtn = role >= 2
                ? `<span style="font-size:10px;color:#aaa;padding:0 10px;">SYSTEM</span>`
                : `<button class="btn-base btn-del" onclick="delUser(${u.id}, '${u.name}')">删除</button>`;

            el.innerHTML = `
                <div class="u-info">
                    <span class="u-name">${u.name} ${roleTag}</span>
                    <div class="u-meta">
                        ID: ${u.username} | DOCS: ${u.charCount || 0}
                        ${u.email ? `| EMAIL: ${u.email}` : ''}
                    </div>
                </div>
                <div class="action-btns">
                    <button class="btn-base btn-edit" onclick="changePass(${u.id}, '${u.username}')"><i class="fas fa-key"></i> 重置密码</button>
                    <button class="btn-base btn-role" onclick="openRoleModal(${u.id}, '${u.name}', ${role})">角色</button>
                    ${delBtn}
                </div>
            `;
            container.appendChild(el);
        });
    }
// ==========================================
    // 【修改】手机端手势 - 右侧菜单 (Right Sidebar)
    // ==========================================
    let touchStartX = 0;
    let touchStartY = 0;
    const swipeThreshold = 80; // 滑动触发距离
    const edgeThreshold = 60;  // 边缘检测距离 (从屏幕边缘多少像素内开始滑动才有效)

    document.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
    }, {passive: true});

    document.addEventListener('touchend', e => {
        const touchEndX = e.changedTouches[0].screenX;
        const touchEndY = e.changedTouches[0].screenY;
        handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY);
    }, {passive: true});

    function handleSwipe(startX, startY, endX, endY) {
        const xDiff = endX - startX; // 正数=向右滑，负数=向左滑
        const yDiff = endY - startY;
        const menu = document.getElementById('sideMenu');
        const isOpen = menu.classList.contains('show');
        const screenWidth = window.innerWidth;

        // 1. 过滤垂直滚动：如果垂直移动幅度 > 水平移动幅度，视为滚动页面，不触发侧滑
        if (Math.abs(yDiff) > Math.abs(xDiff)) return;

        // 2. 打开菜单逻辑 (Open Menu)
        // 条件：
        // a. 菜单目前是关闭的 (!isOpen)
        // b. 向左滑动 (xDiff < -swipeThreshold)
        // c. 起始点在屏幕右侧边缘 (startX > screenWidth - edgeThreshold)
        if (!isOpen && xDiff < -swipeThreshold && startX > (screenWidth - edgeThreshold)) {
            toggleSideMenu();
        }

        // 3. 关闭菜单逻辑 (Close Menu)
        // 条件：
        // a. 菜单目前是打开的 (isOpen)
        // b. 向右滑动 (xDiff > swipeThreshold)
        if (isOpen && xDiff > swipeThreshold) {
            closeSideMenu();
        }
    }
    // 角色筛选
    function filterByRole(role, btn) {
        currentFilter = role;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        applyFilters();
    }

    // 搜索
    document.getElementById('searchInput').addEventListener('input', applyFilters);

    function applyFilters() {
        const term = document.getElementById('searchInput').value.toLowerCase().trim();
        let filtered = allUsersData;

        if (currentFilter !== 'all') {
            filtered = filtered.filter(u => {
                const role = u.role !== undefined ? u.role : (u.isAdmin ? 2 : 0);
                return role === currentFilter;
            });
        }

        if (term) {
            filtered = filtered.filter(u =>
                (u.name && u.name.toLowerCase().includes(term)) ||
                (u.username && u.username.toLowerCase().includes(term))
            );
        }

        renderList(filtered);
    }

    // 重置密码模态框
    let passwordEditingUserId = null;

    function changePass(id, username) {
        passwordEditingUserId = id;
        document.getElementById('pwdModalUserName').textContent = username;
        document.getElementById('newPasswordInput').value = '';
        document.getElementById('confirmPasswordInput').value = '';
        document.getElementById('passwordModal').classList.add('show');
        document.getElementById('newPasswordInput').focus();
    }

    function closePasswordModal() {
        document.getElementById('passwordModal').classList.remove('show');
        passwordEditingUserId = null;
    }

    async function confirmPasswordChange() {
        if (!passwordEditingUserId) return;

        const newPass = document.getElementById('newPasswordInput').value;
        const confirmPass = document.getElementById('confirmPasswordInput').value;

        if (!newPass || newPass.trim() === '') {
            showToast('请输入新密码');
            return;
        }

        if (newPass !== confirmPass) {
            showToast('两次输入的密码不一致');
            return;
        }

        const res = await fetch(`/api/users/${passwordEditingUserId}`, {
            method: 'PUT',
            headers: getAuthHeaders(),
            body: JSON.stringify({ password: newPass })
        });
        const data = await res.json();
        if (data.success) {
            showToast('密码已重置', true);
            closePasswordModal();
            loadUsers();
        } else {
            showToast(data.message || '重置失败');
        }
    }

    // 添加用户
    async function addUser() {
        const name = document.getElementById('newName').value;
        const user = document.getElementById('newUser').value;
        const pass = document.getElementById('newPass').value;
        const role = parseInt(document.getElementById('newRole').value);

        if (!user || !pass) return showToast('账号和密码必填');

        const res = await fetch('/api/users', {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify({ username: user, password: pass, name: name, role: role })
        });
        const data = await res.json();
        if (data.success) {
            document.getElementById('newName').value = '';
            document.getElementById('newUser').value = '';
            document.getElementById('newPass').value = '';
            document.getElementById('newRole').value = '0';
            showToast('用户已创建', true);
            loadUsers();
        } else {
            showToast(data.message || '创建失败');
        }
    }

    // 删除用户
    async function delUser(id, name) {
        if (!confirm(`警告：删除用户 [${name}] 将会同时销毁该用户下的所有角色档案！\n\n确定继续吗？`)) return;
        const res = await fetch(`/api/users/${id}`, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });
        const data = await res.json();
        if (data.success) {
            showToast('用户已删除', true);
            loadUsers();
        } else {
            showToast(data.message || '删除失败');
        }
    }

    // 角色修改模态框
    function openRoleModal(userId, userName, currentRole) {
        editingUserId = userId;
        document.getElementById('modalUserName').textContent = userName;
        document.getElementById('modalRoleSelect').value = currentRole;
        document.getElementById('roleModal').classList.add('show');
    }

    function closeRoleModal() {
        document.getElementById('roleModal').classList.remove('show');
        editingUserId = null;
    }

    async function confirmRoleChange() {
        if (!editingUserId) return;
        const newRole = parseInt(document.getElementById('modalRoleSelect').value);

        const res = await fetch(`/api/admin/users/${editingUserId}/role`, {
            method: 'PUT',
            headers: getAuthHeaders(),
            body: JSON.stringify({ role: newRole })
        });
        const data = await res.json();

        if (data.success) {
            showToast('角色已更新', true);
            closeRoleModal();
            loadUsers();
        } else {
            showToast(data.message || '更新失败');
        }
    }
// --- 侧边栏控制 ---
    function toggleSideMenu() {
        document.getElementById('sideMenu').classList.add('show');
        document.getElementById('sideMenuOverlay').classList.add('show');
    }
    function closeSideMenu() {
        document.getElementById('sideMenu').classList.remove('show');
        document.getElementById('sideMenuOverlay').classList.remove('show');
    }

    // --- 导航显隐逻辑 (Admin页) ---
    (function initNav() {
        // 假设 token 解析或 localStorage 存了角色
        // 这里简单使用 admin.html 本身的判断逻辑 (通常能进Admin就是Role 2)
        // 但为了严谨，我们检查 localStorage
        const role = parseInt(localStorage.getItem('ta_role') || '0');
        
        // 如果是经理或超管，显示"经理台"入口
        // (注：在 Admin 页面不需要显示"管理台"入口)
        if (role >= 1) {
            if(document.getElementById('deskBtnManager')) 
                document.getElementById('deskBtnManager').style.display = 'inline-flex';
            if(document.getElementById('mobBtnManager')) 
                document.getElementById('mobBtnManager').style.display = 'flex';
        }
    })();
    function logout() { localStorage.clear(); window.location.href = 'login.html'; }

    // 初始化
    loadUsers();

    // ==========================================
    // 邀请码管理
    // ==========================================
    let invitationsData = [];

    async function loadInvitations() {
        try {
            const res = await fetch('/api/admin/invitation-codes', { headers: getAuthHeaders() });
            const data = await res.json();
            if (data.success) {
                invitationsData = data.codes;
                renderInvitations();
            } else {
                showToast('加载邀请码失败');
            }
        } catch (e) {
            console.error(e);
            showToast('加载邀请码失败');
        }
    }

    function renderInvitations() {
        const container = document.getElementById('invitationList');
        if (invitationsData.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:#7f8c8d;padding:20px;">暂无邀请码，点击上方按钮生成</div>';
            return;
        }

        container.innerHTML = invitationsData.map(inv => {
            const isActive = inv.is_active === 1;
            const isExpired = inv.expires_at && inv.expires_at < Date.now();
            const isUsedUp = inv.max_uses > 0 && inv.used_count >= inv.max_uses;
            const statusClass = (!isActive || isExpired || isUsedUp) ? 'inactive' : '';
            const isManagerCode = inv.grant_role === 1;

            const expiresText = inv.expires_at
                ? (isExpired ? '已过期' : `${new Date(inv.expires_at).toLocaleDateString()} 到期`)
                : '永不过期';

            const usesText = inv.max_uses === 0
                ? `已使用 ${inv.used_count} 次 (无限)`
                : `已使用 ${inv.used_count}/${inv.max_uses} 次`;

            const roleBadge = isManagerCode
                ? '<span style="background:#9b59b6;color:#fff;padding:2px 8px;border-radius:10px;font-size:10px;margin-left:8px;"><i class="fas fa-user-tie"></i> 经理</span>'
                : '<span style="background:#3498db;color:#fff;padding:2px 8px;border-radius:10px;font-size:10px;margin-left:8px;"><i class="fas fa-user"></i> 特工</span>';

            return `
                <div class="invitation-card ${statusClass}" style="${isManagerCode ? 'border-left:3px solid #9b59b6;' : ''}">
                    <div class="inv-header">
                        <span class="inv-code">${inv.code}</span>
                        ${roleBadge}
                        <span style="font-size:11px;color:${isActive && !isExpired && !isUsedUp ? '#27ae60' : '#e74c3c'};margin-left:auto;">
                            ${isActive && !isExpired && !isUsedUp ? '有效' : (isExpired ? '已过期' : (isUsedUp ? '已用完' : '已禁用'))}
                        </span>
                    </div>
                    <div class="inv-meta">
                        <span><i class="fas fa-clock"></i> ${expiresText}</span>
                        <span><i class="fas fa-users"></i> ${usesText}</span>
                        <span><i class="fas fa-calendar"></i> ${new Date(inv.created_at).toLocaleDateString()} 创建</span>
                    </div>
                    <div class="inv-actions">
                        <button class="btn-inv btn-inv-copy" onclick="copyInvCode('${inv.code}')"><i class="fas fa-copy"></i> 复制</button>
                        <button class="btn-inv btn-inv-uses" onclick="showUses(${inv.id})"><i class="fas fa-history"></i> 记录 (${inv.used_count})</button>
                        <button class="btn-inv btn-inv-toggle" onclick="toggleInvitation(${inv.id})">${isActive ? '禁用' : '启用'}</button>
                        <button class="btn-inv btn-inv-delete" onclick="deleteInvitation(${inv.id})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function copyInvCode(code) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(code).then(() => showToast('已复制', true));
        }
    }

    function openCreateInvitationModal() {
        document.getElementById('invGrantRole').value = '0';
        document.getElementById('invMaxUses').value = '1';
        document.getElementById('invExpiresDays').value = '';
        document.getElementById('invitationModal').classList.add('show');
    }

    function closeInvitationModal() {
        document.getElementById('invitationModal').classList.remove('show');
    }

    async function createInvitation() {
        const maxUses = parseInt(document.getElementById('invMaxUses').value) || 1;
        const expiresDays = document.getElementById('invExpiresDays').value;
        const grantRole = parseInt(document.getElementById('invGrantRole').value) || 0;

        try {
            const res = await fetch('/api/admin/invitation-codes', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    maxUses: maxUses,
                    expiresInDays: expiresDays ? parseInt(expiresDays) : null,
                    grantRole: grantRole
                })
            });
            const data = await res.json();
            if (data.success) {
                const roleText = grantRole === 1 ? '（经理）' : '（特工）';
                showToast('邀请码已生成: ' + data.invitation.code + ' ' + roleText, true);
                closeInvitationModal();
                loadInvitations();
            } else {
                showToast(data.message || '生成失败');
            }
        } catch (e) {
            showToast('生成失败');
        }
    }

    async function toggleInvitation(id) {
        try {
            const res = await fetch(`/api/admin/invitation-codes/${id}/toggle`, {
                method: 'PUT',
                headers: getAuthHeaders()
            });
            const data = await res.json();
            if (data.success) {
                showToast(data.is_active ? '已启用' : '已禁用', true);
                loadInvitations();
            } else {
                showToast(data.message || '操作失败');
            }
        } catch (e) {
            showToast('操作失败');
        }
    }

    async function deleteInvitation(id) {
        if (!confirm('确定删除此邀请码？')) return;
        try {
            const res = await fetch(`/api/admin/invitation-codes/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            const data = await res.json();
            if (data.success) {
                showToast('已删除', true);
                loadInvitations();
            } else {
                showToast(data.message || '删除失败');
            }
        } catch (e) {
            showToast('删除失败');
        }
    }

    function showUses(invId) {
        const inv = invitationsData.find(i => i.id === invId);
        if (!inv) return;

        document.getElementById('usesModalCode').textContent = inv.code;
        const container = document.getElementById('usesModalContent');

        if (!inv.uses || inv.uses.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:#7f8c8d;padding:20px;">暂无使用记录</div>';
        } else {
            container.innerHTML = inv.uses.map(u => `
                <div class="uses-item">
                    <div class="uses-user">${u.name || u.username || '未知用户'}</div>
                    <div class="uses-time">${new Date(u.used_at).toLocaleString()}</div>
                </div>
            `).join('');
        }

        document.getElementById('invitationUsesModal').classList.add('show');
    }

    function closeUsesModal() {
        document.getElementById('invitationUsesModal').classList.remove('show');
    }
</script>
</body>
</html>
